<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Distelsa Coverage PRO</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root { --blue: #003399; --green: #27ae60; --red: #c0392b; --yellow: #f1c40f; --gray: #ecf0f1; --dark: #2c3e50; }
  body { font-family: 'Segoe UI', sans-serif; background: #f4f6f9; margin: 0; color: #333; }
  .hidden { display: none !important; }
  
  /* HEADER */
  header { background: white; border-bottom: 4px solid var(--blue); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
  .logo { font-size: 22px; font-weight: 900; color: var(--blue); letter-spacing: -1px; }

  /* LOGIN */
  .login-wrap { display: flex; height: 100vh; justify-content: center; align-items: center; background: #e9ecef; }
  .login-card { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 320px; text-align: center; }
  .inp { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
  
  /* BOTONES */
  .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; }
  .btn-p { background: var(--blue); }
  .btn-s { background: var(--green); }
  .btn-d { background: var(--red); }
  .btn:disabled { background: #95a5a6; cursor: not-allowed; }

  /* TABLA PRINCIPAL */
  .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; }
  .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
  
  table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; table-layout: fixed; }
  th { text-align: left; padding: 12px; background: #f8f9fa; border-bottom: 2px solid #ddd; color: #555; }
  td { padding: 8px 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
  
  /* Inputs de Edición en Tabla */
  .edit-inp { width: 100%; border: 1px solid transparent; background: transparent; padding: 5px; font-family: inherit; }
  .edit-inp:focus { border-color: var(--blue); background: white; }

  /* ESTADOS (BADGES) */
  .badge { padding: 6px 10px; border-radius: 15px; font-weight: bold; font-size: 11px; text-transform: uppercase; color: white; display: inline-block; text-align: center; width: 100px; }
  .bg-cob { background: var(--green); }
  .bg-no { background: var(--red); }
  .bg-con { background: var(--yellow); color: #333; }
  .bg-null { background: #95a5a6; }

  /* SELECTOR DE ESTADO (SOLO ADMIN/LIDER) */
  .state-sel { border: 1px solid #ddd; padding: 5px; border-radius: 15px; width: 100%; font-weight: bold; }

  /* MODAL */
  .modal-bg { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 999; }
  .modal { background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 650px; max-height: 90vh; overflow-y: auto; }
  
  /* PAGINACION */
  .pag-ctrl { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 15px; }

</style>
</head>
<body>

<div id="vLogin" class="login-wrap">
  <div class="login-card">
    <h2 style="color:var(--blue)">DISTELSA PRO</h2>
    <input id="uLog" class="inp" placeholder="Usuario">
    <input id="pLog" type="password" class="inp" placeholder="Contraseña">
    <button id="btnEntrar" onclick="doLogin()" class="btn btn-p" style="width:100%; margin-top:10px;">INGRESAR</button>
  </div>
</div>

<div id="vApp" class="hidden">
  <header>
    <div class="logo">DISTELSA</div>
    <div style="display:flex; align-items:center; gap:15px;">
      <div style="text-align:right;">
        <div id="dispUser" style="font-weight:bold; font-size:14px;">User</div>
        <div id="dispRol" style="font-size:11px; color:#777; text-transform:uppercase;">Rol</div>
      </div>
      <button onclick="logout()" class="btn btn-d" style="padding:5px 10px;"><i class="fa-solid fa-power-off"></i></button>
    </div>
  </header>

  <div class="container">
    <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
      <input id="search" class="inp" style="flex:1; margin:0;" placeholder="Buscar..." onkeyup="renderTable(true)">
      <button id="btnAdd" onclick="openModalAdd()" class="btn btn-s hidden"><i class="fa-solid fa-plus"></i> Nuevo</button>
      <button id="btnExp" onclick="exportExcel()" class="btn btn-p hidden" style="background:#217346"><i class="fa-solid fa-file-excel"></i> Exportar</button>
      <button id="btnHis" onclick="openHist()" class="btn btn-p hidden"><i class="fa-solid fa-clock-rotate-left"></i> Historial</button>
      <button id="btnUsr" onclick="openUsers()" class="btn btn-p hidden" style="background:#34495e"><i class="fa-solid fa-users-gear"></i></button>
    </div>

    <div class="card">
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th width="15%">Municipio</th>
              <th width="20%">Nombre</th>
              <th width="15%">Categoría</th>
              <th width="8%">Zona</th>
              <th width="22%">Referencia</th>
              <th width="15%">Cobertura</th>
              <th width="5%" class="adm-col hidden"></th>
            </tr>
          </thead>
          <tbody id="tbBody"></tbody>
        </table>
      </div>
      <div class="pag-ctrl">
        <button onclick="chPage(-1)" class="btn btn-p"><i class="fa-solid fa-chevron-left"></i></button>
        <span id="pgLbl">1</span>
        <button onclick="chPage(1)" class="btn btn-p"><i class="fa-solid fa-chevron-right"></i></button>
      </div>
    </div>
  </div>
</div>

<div id="mAdd" class="modal-bg hidden">
  <div class="modal">
    <h3 style="color:var(--blue)">Nueva Ubicación</h3>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
      <input id="nM" class="inp" placeholder="Municipio">
      <input id="nN" class="inp" placeholder="Nombre Lugar">
      <input id="nC" class="inp" placeholder="Categoría">
      <input id="nZ" class="inp" placeholder="Zona">
      <input id="nR" class="inp" style="grid-column:span 2" placeholder="Referencia">
      <select id="nCob" class="inp" style="grid-column:span 2">
        <option value="Cobertura">Cobertura</option>
        <option value="Sin Cobertura">Sin Cobertura</option>
        <option value="Consultar">Consultar</option>
      </select>
    </div>
    <div style="margin-top:20px; text-align:right;">
      <button onclick="closeModal('mAdd')" class="btn btn-d">Cancelar</button>
      <button onclick="saveCob('new')" class="btn btn-s">Guardar</button>
    </div>
  </div>
</div>

<div id="mUsr" class="modal-bg hidden">
  <div class="modal">
    <h3 style="color:var(--blue)">Administrar Usuarios</h3>
    
    <div style="background:#f1f1f1; padding:15px; border-radius:8px; margin-bottom:15px; display:flex; gap:5px; align-items:center;">
      <input id="uName" class="inp" placeholder="Usuario" style="margin:0;">
      <input id="uPass" class="inp" placeholder="Clave" style="margin:0;">
      <select id="uRol" class="inp" style="margin:0; width:100px;">
        <option value="agente">Agente</option>
        <option value="lider">Lider</option>
        <option value="admin">Admin</option>
      </select>
      <button id="btnUserAction" onclick="userAction()" class="btn btn-s"><i class="fa-solid fa-plus"></i></button>
      <button onclick="resetUserForm()" class="btn btn-d" style="padding:10px;"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <input id="searchUsr" class="inp" placeholder="Buscar usuario..." onkeyup="renderUsers(true)">
    <div style="max-height:300px; overflow-y:auto;">
      <table style="margin-top:0;">
        <thead><tr><th>Usuario</th><th>Rol</th><th>Acciones</th></tr></thead>
        <tbody id="tbUsr"></tbody>
      </table>
    </div>
    <div class="pag-ctrl">
        <button onclick="chPageUsr(-1)" class="btn btn-p btn-sm"><i class="fa-solid fa-chevron-left"></i></button>
        <span id="pgLblUsr">1</span>
        <button onclick="chPageUsr(1)" class="btn btn-p btn-sm"><i class="fa-solid fa-chevron-right"></i></button>
    </div>

    <div style="margin-top:15px; text-align:right;">
      <button onclick="closeModal('mUsr')" class="btn btn-d">Cerrar</button>
    </div>
  </div>
</div>

<div id="mHis" class="modal-bg hidden">
  <div class="modal" style="max-width:800px;">
    <h3>Historial Reciente</h3>
    <div style="max-height:400px; overflow-y:auto;">
      <table id="tbHis"></table>
    </div>
    <button onclick="closeModal('mHis')" class="btn btn-d" style="margin-top:15px;">Cerrar</button>
  </div>
</div>

<script>
/** * CONFIGURACION:
 * Pega abajo la URL de tu Web App
 */
const API = "https://script.google.com/macros/s/AKfycbyFLy1Q7Xo1_3w5dmr_ws9vszQvLY0dIsOpEpBiIFodWLN1dQGJVr_XZ2T9yJ1Jmj8GoQ/exec";

let DATA = { cob: [], usr: [], his: [] };
let SES = { u: null, r: null, t: null };
let PG = 1, PG_USR = 1;
let EDIT_USER_MODE = false;

// INICIO
window.onload = () => {
  const saved = localStorage.getItem('dist_v5');
  if(saved) {
    SES = JSON.parse(saved);
    initApp();
  }
}

async function doLogin() {
  const u = document.getElementById('uLog').value;
  const p = document.getElementById('pLog').value;
  const btn = document.getElementById('btnEntrar');
  
  if(!u || !p) return;

  // UX: Evitar doble click
  btn.disabled = true;
  btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Entrando...';

  try {
    const res = await fetch(API, {method:'POST', body:JSON.stringify({action:'login', u, p})});
    const json = await res.json();
    
    if(json.status === 'ok') {
      SES = { u: u, r: json.rol, t: json.token };
      localStorage.setItem('dist_v5', JSON.stringify(SES));
      initApp();
    } else {
      alert(json.message);
      btn.disabled = false;
      btn.innerHTML = 'INGRESAR';
    }
  } catch(e) {
    alert("Error de conexión");
    btn.disabled = false;
    btn.innerHTML = 'INGRESAR';
  }
}

function initApp() {
  document.getElementById('vLogin').classList.add('hidden');
  document.getElementById('vApp').classList.remove('hidden');
  document.getElementById('dispUser').innerText = SES.u;
  document.getElementById('dispRol').innerText = SES.r;

  // Permisos UI
  if(SES.r === 'admin' || SES.r === 'lider') {
    document.getElementById('btnAdd').classList.remove('hidden');
    document.getElementById('btnExp').classList.remove('hidden');
  }
  if(SES.r === 'admin') {
    document.getElementById('btnHis').classList.remove('hidden');
    document.getElementById('btnUsr').classList.remove('hidden');
  }

  loadData();
  // Heartbeat
  setInterval(() => {
    fetch(API, {method:'POST', body:JSON.stringify({action:'heartbeat', u:SES.u})});
    loadData();
  }, 20000);
}

async function loadData() {
  try {
    const r = await fetch(API);
    const j = await r.json();
    if(j.status === 'success') {
      // Indexamos para poder editar
      DATA.cob = j.cobertura.map((x,i)=>({i, m:x[0], n:x[1], c:x[2], z:x[3], r:x[4], s:x[5]}));
      DATA.usr = j.usuarios;
      DATA.his = j.historial;
      renderTable();
    }
  } catch(e) { console.log("Sync error"); }
}

// RENDER TABLA PRINCIPAL
function renderTable(reset = false) {
  if(reset) PG = 1;
  const q = document.getElementById('search').value.toLowerCase();
  const filt = DATA.cob.filter(x => `${x.m} ${x.n} ${x.z}`.toLowerCase().includes(q));
  
  const pages = Math.ceil(filt.length / 10) || 1;
  if(PG > pages) PG = pages;
  document.getElementById('pgLbl').innerText = `${PG} / ${pages}`;

  const slice = filt.slice((PG-1)*10, PG*10);
  const tb = document.getElementById('tbBody');
  tb.innerHTML = '';

  const canEdit = (SES.r === 'admin' || SES.r === 'lider');
  
  // Mostramos cabecera accion si tiene permiso
  document.querySelectorAll('.adm-col').forEach(e => e.classList.toggle('hidden', !canEdit));

  slice.forEach(x => {
    // Determinar color
    let cls = 'bg-null';
    if(x.s=='Cobertura') cls='bg-cob';
    else if(x.s=='Sin Cobertura') cls='bg-no';
    else if(x.s=='Consultar') cls='bg-con';

    // HTML del Estado (Badge vs Select)
    let statusHTML = '';
    if(canEdit) {
      statusHTML = `
        <select id="sel_${x.i}" class="state-sel" style="background:${cls==='bg-cob'?'#27ae60':cls==='bg-no'?'#c0392b':cls==='bg-con'?'#f1c40f':'#ecf0f1'}; color:${cls==='bg-con'?'#333':'white'}" onchange="this.style.background = this.value=='Cobertura'?'#27ae60':this.value=='Sin Cobertura'?'#c0392b':this.value=='Consultar'?'#f1c40f':'#ecf0f1'">
          <option value="Sin Datos">Sin Datos</option>
          <option value="Cobertura" ${x.s=='Cobertura'?'selected':''}>Cobertura</option>
          <option value="Sin Cobertura" ${x.s=='Sin Cobertura'?'selected':''}>Sin Cobertura</option>
          <option value="Consultar" ${x.s=='Consultar'?'selected':''}>Consultar</option>
        </select>`;
    } else {
      // AGENTE: Solo texto con color full (NO OPACO)
      statusHTML = `<span class="badge ${cls}" style="width:100%">${x.s}</span>`;
    }

    // Campos
    const htmlM = canEdit ? `<input id="m_${x.i}" value="${x.m}" class="edit-inp">` : x.m;
    const htmlN = canEdit ? `<input id="n_${x.i}" value="${x.n}" class="edit-inp" style="font-weight:bold">` : `<b>${x.n}</b>`;
    const htmlC = canEdit ? `<input id="c_${x.i}" value="${x.c}" class="edit-inp">` : x.c;
    const htmlZ = canEdit ? `<input id="z_${x.i}" value="${x.z}" class="edit-inp">` : x.z;
    const htmlR = canEdit ? `<input id="r_${x.i}" value="${x.r}" class="edit-inp">` : x.r;

    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${htmlM}</td><td>${htmlN}</td><td>${htmlC}</td><td>${htmlZ}</td><td>${htmlR}</td><td>${statusHTML}</td>`;
    
    if(canEdit) {
      const tdAct = document.createElement('td');
      tdAct.innerHTML = `<button onclick="saveCob('upd', ${x.i})" class="btn btn-p" style="padding:5px"><i class="fa-solid fa-save"></i></button>`;
      tr.appendChild(tdAct);
    }
    tb.appendChild(tr);
  });
}

// LOGICA USUARIOS (Paginacion + Busqueda + Edit)
function renderUsers(reset = false) {
  if(reset) PG_USR = 1;
  const q = document.getElementById('searchUsr').value.toLowerCase();
  const filt = DATA.usr.filter(u => u[0].toLowerCase().includes(q)); // u[0] es username
  
  const pages = Math.ceil(filt.length / 10) || 1;
  if(PG_USR > pages) PG_USR = pages;
  document.getElementById('pgLblUsr').innerText = `${PG_USR} / ${pages}`;

  const slice = filt.slice((PG_USR-1)*10, PG_USR*10);
  const tb = document.getElementById('tbUsr');
  tb.innerHTML = '';

  slice.forEach(u => {
    // u = [user, pass, rol, date, token]
    tb.innerHTML += `
      <tr>
        <td><b>${u[0]}</b></td>
        <td><span style="font-size:10px; background:#eee; padding:2px 5px; border-radius:4px">${u[2]}</span></td>
        <td>
          <button onclick="preEditUser('${u[0]}', '${u[1]}', '${u[2]}')" class="btn btn-p" style="padding:4px 8px"><i class="fa-solid fa-pencil"></i></button>
          <button onclick="sendUser('del', '${u[0]}')" class="btn btn-d" style="padding:4px 8px"><i class="fa-solid fa-trash"></i></button>
        </td>
      </tr>`;
  });
}

function preEditUser(name, pass, rol) {
  EDIT_USER_MODE = true;
  document.getElementById('uName').value = name;
  document.getElementById('uName').disabled = true; // No cambiar nombre al editar
  document.getElementById('uPass').value = pass;
  document.getElementById('uRol').value = rol;
  
  const btn = document.getElementById('btnUserAction');
  btn.innerHTML = '<i class="fa-solid fa-check"></i>';
  btn.className = 'btn btn-p'; // Azul para update
}

function resetUserForm() {
  EDIT_USER_MODE = false;
  document.getElementById('uName').value = '';
  document.getElementById('uName').disabled = false;
  document.getElementById('uPass').value = '';
  document.getElementById('btnUserAction').innerHTML = '<i class="fa-solid fa-plus"></i>';
  document.getElementById('btnUserAction').className = 'btn btn-s'; // Verde para nuevo
}

async function userAction() {
  const u = document.getElementById('uName').value;
  const p = document.getElementById('uPass').value;
  const r = document.getElementById('uRol').value;
  if(!u || !p) return alert("Datos incompletos");

  const type = EDIT_USER_MODE ? 'edit' : 'add';
  await sendUser(type, u, p, r);
  resetUserForm();
}

async function sendUser(type, u, p, r) {
  await fetch(API, {method:'POST', body:JSON.stringify({
    action:'manageUser', type, u, p, r, userLog: SES.u
  })});
  loadData(); // Recargar para ver cambios
  setTimeout(() => { 
    renderUsers(); 
    if(type==='del') alert("Eliminado");
  }, 1000);
}

// LOGICA COBERTURA
async function saveCob(type, idx) {
  const data = { action: 'saveCob', type, userLog: SES.u };
  
  if(type === 'new') {
    data.m = document.getElementById('nM').value;
    data.n = document.getElementById('nN').value;
    data.c = document.getElementById('nC').value;
    data.z = document.getElementById('nZ').value;
    data.r = document.getElementById('nR').value;
    data.cob = document.getElementById('nCob').value;
    if(!data.m || !data.n) return alert("Falta Municipio o Nombre");
  } else {
    // Update
    data.idx = idx;
    data.m = document.getElementById(`m_${idx}`).value;
    data.n = document.getElementById(`n_${idx}`).value;
    data.c = document.getElementById(`c_${idx}`).value;
    data.z = document.getElementById(`z_${idx}`).value;
    data.r = document.getElementById(`r_${idx}`).value;
    
    // Obtener valor del select o mantener el actual
    const sel = document.getElementById(`sel_${idx}`);
    data.cob = sel ? sel.value : DATA.cob[idx].s;
  }

  await fetch(API, {method:'POST', mode:'no-cors', body:JSON.stringify(data)});
  
  if(type==='new') closeModal('mAdd');
  loadData();
  alert("Guardado Correctamente");
}

// UTILIDADES
function chPage(d) { PG += d; renderTable(); }
function chPageUsr(d) { PG_USR += d; renderUsers(); }
function logout() { localStorage.removeItem('dist_v5'); location.reload(); }
function exportExcel() {
  const ws = XLSX.utils.json_to_sheet(DATA.cob);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Cobertura");
  XLSX.writeFile(wb, "Reporte.xlsx");
}

// MODALES
function openModalAdd() { document.getElementById('mAdd').classList.remove('hidden'); }
function openUsers() { document.getElementById('mUsr').classList.remove('hidden'); renderUsers(true); }
function openHist() {
  document.getElementById('mHis').classList.remove('hidden');
  document.getElementById('tbHis').innerHTML = 
    `<thead><tr><th>Fecha</th><th>User</th><th>Acción</th><th>Detalle</th></tr></thead>` +
    DATA.his.map(h => `<tr><td>${new Date(h[0]).toLocaleString()}</td><td>${h[1]}</td><td>${h[2]}</td><td>${h[3]}</td></tr>`).join('');
}
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

</script>
</body>
</html>
