<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA DE COBERTURA | DISTELSA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { 
            --primary: #0054a6; 
            --success: #00b050; 
            --danger: #c00000; 
            --warning: #f1c40f; 
            --dark: #2c3e50; 
            --light-grey: #dcdcdc; 
        }
        body { font-family: 'Segoe UI', sans-serif; background:#f0f2f5; margin:0; }
        
        .header { background: white; padding: 10px 50px; border-bottom: 5px solid var(--primary); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header img { height: 120px; width: auto; }
        .header-title h1 { margin: 0; color: var(--primary); font-size: 28px; font-weight: 800; text-transform: uppercase; }
        
        .container { max-width: 1250px; margin: 20px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); position: relative; min-height: 450px; }
        .hidden { display: none !important; }

        /* Bot칩n Cerrar Sesi칩n Superior */
        .btn-exit-top { 
            position: absolute; top: 15px; right: 15px; background: var(--dark); color: white; border: none; 
            padding: 8px 12px; border-radius: 20px; cursor: pointer; font-size: 12px; display: flex; 
            align-items: center; gap: 8px; transition: all 0.3s; z-index: 10;
        }
        .btn-exit-top span { display: none; }
        .btn-exit-top:hover { background: var(--danger); padding: 8px 18px; }
        .btn-exit-top:hover span { display: inline; }

        /* Buscador con Escoba */
        .toolbar { display: flex; gap: 15px; margin-bottom: 25px; align-items: center; }
        .search-container { position: relative; flex-grow: 1; }
        .search-box { width: 100%; padding: 14px 45px 14px 14px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; box-sizing: border-box; outline: none; }
        .clear-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--primary); font-size: 18px; display: none; }

        .btn { padding: 12px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; color: white; display: inline-flex; align-items: center; gap: 10px; }
        .btn-admin { background: var(--warning); color: #000; }
        .btn-nav { background: var(--primary); min-width: 120px; justify-content: center; }

        /* Cassette */
        .btn-save { background: var(--success); padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; }
        .btn-save i { font-size: 20px; color: white; }

        /* Selectores Coloreados */
        .sel-status { padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-weight: bold; color: white; cursor: pointer; }
        .sel-sin-datos { background-color: var(--light-grey); color: #666 !important; }
        .sel-cobertura { background-color: var(--success); }
        .sel-sin-cobertura { background-color: var(--danger); }
        .sel-consultar { background-color: var(--warning); color: black !important; }

        table { width: 100%; border-collapse: collapse; }
        th { background: var(--primary); color: white; padding: 15px; text-align: left; font-size: 12px; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        
        .badge { padding: 6px 12px; border-radius: 20px; color: white; font-weight: bold; font-size: 10px; text-transform: uppercase; }
        .bg-verde { background: var(--success); }
        .bg-rojo { background: var(--danger); }
        .bg-amarillo { background: var(--warning); color: black; }
        .bg-gris { background: var(--light-grey); color: #666; }

        .pagination { display: flex; justify-content: center; gap: 20px; margin-top: 30px; align-items: center; font-weight: bold; color: var(--primary); }

        /* Modal */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 450px; position: relative; }
    </style>
</head>
<body>

<header class="header">
    <img src="https://drive.google.com/thumbnail?id=1bawJf9oARBLy2itsOfA9YE8RVAFNdNef" alt="Logo Distelsa">
    <div class="header-title">
        <h1>SISTEMA DE COBERTURA</h1>
        <small id="statText" style="color: var(--primary); font-weight: bold;">SISTEMA ONLINE</small>
    </div>
    <div style="width: 120px;"></div>
</header>

<div class="container">
    <button id="logoutBtn" onclick="logout()" class="btn-exit-top hidden">
        <i class="fa-solid fa-power-off"></i> <span>Cerrar Sesi칩n</span>
    </button>

    <div id="loginPanel" style="max-width: 400px; margin: 60px auto; text-align: center;">
        <h2 style="color:var(--primary)">Acceso</h2>
        <input id="userInput" type="text" placeholder="Usuario" style="width:100%; padding:14px; margin-bottom:15px; border-radius:8px; border:1px solid #ddd;">
        <input id="passInput" type="password" placeholder="Contrase침a" style="width:100%; padding:14px; margin-bottom:20px; border-radius:8px; border:1px solid #ddd;">
        <button id="btnLogin" onclick="login()" disabled class="btn" style="background:var(--primary); width:100%; justify-content:center;">CARGANDO...</button>
    </div>

    <div id="appPanel" class="hidden">
        <div class="toolbar">
            <div class="search-container">
                <input id="buscar" class="search-box" placeholder="游댌 Buscar..." oninput="manejarBusqueda()">
                <i id="clearBtn" class="fa-solid fa-broom clear-icon" onclick="limpiarBusqueda()"></i>
            </div>
            <button id="btnAdmin" onclick="abrirModal()" class="btn btn-admin hidden">USUARIOS</button>
        </div>
        <table>
            <thead><tr><th>Municipio</th><th>Nombre</th><th>Zona</th><th>Cobertura</th></tr></thead>
            <tbody id="cuerpo"></tbody>
        </table>
        <div class="pagination">
            <button id="btnAnt" class="btn btn-nav" onclick="cambiarPag(-1)">ANTERIOR</button>
            <span id="pagTxt">P치gina 1</span>
            <button id="btnSig" class="btn btn-nav" onclick="cambiarPag(1)">SIGUIENTE</button>
        </div>
    </div>
</div>

<div id="modalUser" class="modal hidden">
    <div class="modal-content">
        <h3 style="margin-top:0">Gesti칩n de Usuarios</h3>
        <div style="display:flex; flex-direction:column; gap:10px; margin-bottom:20px;">
            <input id="newU" type="text" placeholder="Usuario" style="padding:10px;">
            <input id="newP" type="text" placeholder="Clave" style="padding:10px;">
            <select id="newR" style="padding:10px;">
                <option value="agente">Agente</option>
                <option value="lider">L칤der</option>
                <option value="admin">Administrador</option>
            </select>
            <button onclick="crearUsuario()" class="btn" style="background:var(--primary); justify-content:center;">AGREGAR</button>
        </div>
        <div id="listaU" style="max-height:150px; overflow-y:auto;"></div>
        <button onclick="cerrarModal()" class="btn" style="background:var(--dark); width:100%; margin-top:15px; justify-content:center;">CERRAR</button>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbx4GK4eRKjRXD5AqukR-lpjo_1jloeSjKlk7GYpihbYlo8YwRAEUwaj6TbUUDg0aODEOg/exec";
    let MASTER = [], USUARIOS = [], ROL = "", pag = 1;
    const limite = 10;

    window.onload = cargarDatos;

    async function cargarDatos() {
        try {
            const res = await fetch(API);
            const data = await res.json();
            USUARIOS = data.usuarios.slice(1).map(r => ({u: String(r[0]), p: String(r[1]), r: String(r[2])}));
            MASTER = data.cobertura.slice(1).map((r, i) => ({ fila: i+2, m: r[0], n: r[1], z: r[3], cob: r[5] || "Sin Datos" }));
            document.getElementById("btnLogin").innerText = "INGRESAR";
            document.getElementById("btnLogin").disabled = false;
        } catch (e) { document.getElementById("statText").innerText = "ERROR DE CONEXI칍N"; }
    }

    function manejarBusqueda() {
        const val = document.getElementById("buscar").value;
        document.getElementById("clearBtn").style.display = val.length > 0 ? "block" : "none";
        pag = 1; render();
    }

    function limpiarBusqueda() { document.getElementById("buscar").value = ""; manejarBusqueda(); }

    function getColorClass(val) {
        if (val === "Cobertura") return "sel-cobertura";
        if (val === "Sin Cobertura") return "sel-sin-cobertura";
        if (val === "Consultar") return "sel-consultar";
        return "sel-sin-datos";
    }

    function render() {
        const q = document.getElementById("buscar").value.toLowerCase().split(" ");
        const filtrados = MASTER.filter(r => q.every(w => `${r.m} ${r.n} ${r.z}`.toLowerCase().includes(w)));
        const segment = filtrados.slice((pag-1)*limite, pag*limite);
        let html = "";
        segment.forEach(r => {
            const canEdit = (ROL === 'admin' || ROL === 'lider');
            if (canEdit) {
                html += `<tr><td>${r.m}</td><td><b>${r.n}</b></td><td>${r.z}</td>
                    <td><div style="display:flex; align-items:center; gap:8px;">
                        <select id="s-${r.fila}" class="sel-status ${getColorClass(r.cob)}" onchange="this.className='sel-status ' + getColorClass(this.value)">
                            <option value="Sin Datos" ${r.cob=='Sin Datos'?'selected':''}>Sin Datos</option>
                            <option value="Cobertura" ${r.cob=='Cobertura'?'selected':''}>Cobertura</option>
                            <option value="Sin Cobertura" ${r.cob=='Sin Cobertura'?'selected':''}>Sin Cobertura</option>
                            <option value="Consultar" ${r.cob=='Consultar'?'selected':''}>Consultar</option>
                        </select>
                        <button class="btn-save" onclick="guardarEstado(${r.fila})"><i class="fa-solid fa-cassette-tape"></i></button>
                    </div></td></tr>`;
            } else {
                let cl = r.cob=="Cobertura"?"bg-verde":r.cob=="Sin Cobertura"?"bg-rojo":r.cob=="Consultar"?"bg-amarillo":"bg-gris";
                html += `<tr><td>${r.m}</td><td><b>${r.n}</b></td><td>${r.z}</td><td><span class="badge ${cl}">${r.cob}</span></td></tr>`;
            }
        });
        document.getElementById("cuerpo").innerHTML = html;
        document.getElementById("pagTxt").innerText = `P치gina ${pag} de ${Math.ceil(filtrados.length/limite) || 1}`;
        document.getElementById("btnAnt").disabled = pag === 1;
        document.getElementById("btnSig").disabled = pag*limite >= filtrados.length;
    }

    async function guardarEstado(fila) {
        const val = document.getElementById(`s-${fila}`).value;
        document.getElementById("statText").innerText = "GUARDANDO...";
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'updateCob', fila, valor: val }) });
        const item = MASTER.find(x => x.fila === fila);
        if(item) item.cob = val;
        document.getElementById("statText").innerText = "SISTEMA ONLINE";
        render();
    }

    function login() {
        const u = document.getElementById("userInput").value.trim().toLowerCase();
        const p = document.getElementById("passInput").value.trim();
        const user = USUARIOS.find(x => x.u.toLowerCase() === u && x.p === p);
        if(user) {
            ROL = user.r.toLowerCase();
            document.getElementById("loginPanel").classList.add("hidden");
            document.getElementById("appPanel").classList.remove("hidden");
            document.getElementById("logoutBtn").classList.remove("hidden");
            if(ROL === 'admin') document.getElementById("btnAdmin").classList.remove("hidden");
            render();
        } else { alert("Datos incorrectos"); }
    }

    function abrirModal() { document.getElementById("modalUser").classList.remove("hidden"); listarU(); }
    function cerrarModal() { document.getElementById("modalUser").classList.add("hidden"); }
    function listarU() {
        let h = "<table style='width:100%; font-size:12px;'>";
        USUARIOS.forEach(u => h += `<tr><td>${u.u}</td><td>${u.r}</td><td><button onclick="delU('${u.u}')" style="color:red; border:none; background:none; cursor:pointer">X</button></td></tr>`);
        document.getElementById("listaU").innerHTML = h + "</table>";
    }
    async function crearUsuario() {
        const u = document.getElementById("newU").value, p = document.getElementById("newP").value, r = document.getElementById("newR").value;
        if(!u || !p) return;
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'addUser', usuario: u, clave: p, rol: r }) });
        USUARIOS.push({u, p, r}); listarU();
    }
    async function delU(n) {
        if(!confirm("쮼liminar?")) return;
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'delete', usuarioNombre: n }) });
        USUARIOS = USUARIOS.filter(x => x.u !== n); listarU();
    }

    function cambiarPag(v) { pag += v; render(); }
    function logout() { location.reload(); }
</script>
</body>
</html>
