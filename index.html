<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>DISTELSA - Cobertura 2026</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --p: #003399; --s: #28a745; --d: #dc3545; --bg: #f4f7f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; }
        .hidden { display: none !important; }
        
        /* Header con Identidad Corporativa */
        header { background: white; border-bottom: 5px solid var(--p); padding: 10px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo { font-weight: 900; color: var(--p); font-size: 26px; letter-spacing: -1px; }
        .logo span { color: var(--d); }

        .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        /* Online Tracker (Admin) */
        .online-status { position: relative; cursor: pointer; background: #eef2ff; color: var(--p); padding: 6px 15px; border-radius: 20px; font-weight: bold; border: 1px solid #cdd9f7; font-size: 13px; }
        .online-list { display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ccc; width: 180px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 100; border-radius: 5px; padding: 10px; }
        .online-status:hover .online-list { display: block; }

        /* Tabla Estilizada */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; color: #555; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        
        .btn { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 13px; }
        .btn-p { background: var(--p); color: white; }
        .btn-s { background: var(--s); color: white; }
        .btn-export { background: #1d6f42; color: white; }

        .badge { padding: 5px 8px; border-radius: 4px; color: white; font-size: 11px; font-weight: bold; text-transform: uppercase; border: none; }
        .bg-cob { background: var(--s); } .bg-nocob { background: var(--d); } .bg-cons { background: #ffc107; color: black; }
        
        input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:20px;">
        <div class="logo">DISTEL<span>SA</span></div>
        <div style="width:1.5px; height:30px; background:#ddd;"></div>
        <h2 style="margin:0; font-size:16px; color:#666; letter-spacing: 1px;">COBERTURA</h2>
    </div>
    
    <div id="navRight" class="hidden" style="display:flex; align-items:center; gap:20px;">
        <div class="online-status" id="onlineBadge">
            <i class="fa-solid fa-circle" style="color:var(--s); font-size:10px;"></i> 
            <span id="countOn">0</span> Conectados
            <div id="namesOn" class="online-list"></div>
        </div>
        <span id="userName" style="font-weight:bold; color:var(--p);"></span>
        <button onclick="logout()" class="btn" style="color:var(--d); border:1px solid var(--d); background:none;"><i class="fa-solid fa-power-off"></i></button>
    </div>
</header>

<div id="loginBox" class="container" style="max-width: 380px; margin-top: 15vh;">
    <div class="card" style="text-align: center;">
        <h3 style="color:var(--p); margin-bottom:20px;">Iniciar Sesi√≥n</h3>
        <input type="text" id="user" placeholder="Usuario" style="width:90%; margin-bottom:10px;">
        <input type="password" id="pass" placeholder="Contrase√±a" style="width:90%; margin-bottom:20px;">
        <button onclick="login()" class="btn btn-p" style="width:95%; justify-content:center; padding:12px;">ENTRAR</button>
    </div>
</div>

<div id="app" class="container hidden">
    <div class="card">
        <div style="display:flex; justify-content:space-between; gap:10px; margin-bottom:20px;">
            <input type="text" id="search" placeholder="üîç Buscar municipio, lugar o zona..." style="flex-grow:1; border:2px solid #eee;" onkeyup="pag=1; render()">
            
            <button onclick="exportarExcel()" class="btn btn-export"><i class="fa-solid fa-file-excel"></i> Excel</button>
            <button id="btnHist" onclick="abrirHistorial()" class="btn btn-p hidden"><i class="fa-solid fa-history"></i></button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Municipio</th>
                    <th>Lugar</th>
                    <th>Zona</th>
                    <th>Referencia</th>
                    <th>Estado</th>
                    <th class="adm-col hidden">Acci√≥n</th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>

        <div style="text-align:center; margin-top:20px;">
            <button onclick="changePag(-1)" class="btn btn-p">Anterior</button>
            <span id="pagInfo" style="margin:0 15px; font-weight:bold; color:#666;">P√°gina 1</span>
            <button onclick="changePag(1)" class="btn btn-p">Siguiente</button>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzVYAUtH98PCkvHVATOOEabX2Y3cVmIK1li20yZLtPUKZLTOdrxux9if6Br0sa9TooRFQ/exec"; // REEMPLAZAR CON TU URL
    let DATA = { cob: [], logs: [], online: [] };
    let SES = { u: "", r: "", tk: "" };
    let pag = 1;

    async function fetchData() {
        const res = await fetch(API_URL);
        const json = await res.json();
        
        // --- SEGURIDAD: SESI√ìN √öNICA ---
        if (SES.u && json.tokens[SES.u] !== SES.tk) {
            alert("Tu sesi√≥n ha sido abierta en otro dispositivo.");
            logout();
            return;
        }

        DATA.cob = json.cobertura.slice(1).map((r,i) => ({f:i+2, m:r[0], n:r[1], c:r[2], z:r[3], ref:r[4], val:r[5]||"Sin Datos"}));
        DATA.online = json.onlineList;
        
        document.getElementById("countOn").innerText = DATA.online.length;
        // Solo el Admin ve los nombres de qui√©n est√° online
        if(SES.r === 'admin') {
            document.getElementById("namesOn").innerHTML = "<b>Usuarios Online:</b><hr>" + DATA.online.map(u => `<div style='padding:3px 0;'>‚Ä¢ ${u}</div>`).join('');
        } else {
            document.getElementById("namesOn").innerHTML = "Informaci√≥n solo para Admin";
        }

        if(SES.u) render();
    }

    async function login() {
        const u = document.getElementById("user").value;
        const p = document.getElementById("pass").value;
        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({action:'login', u, p}) });
        const resJson = await res.json();
        
        if(resJson.status === 'ok') {
            SES = { u, r: resJson.rol, tk: resJson.token };
            localStorage.setItem("distelsa_session", JSON.stringify(SES));
            start();
        } else alert("Datos incorrectos");
    }

    function start() {
        const storage = localStorage.getItem("distelsa_session");
        if(storage) {
            SES = JSON.parse(storage);
            document.getElementById("loginBox").classList.add("hidden");
            document.getElementById("app").classList.remove("hidden");
            document.getElementById("navRight").classList.remove("hidden");
            document.getElementById("userName").innerText = SES.u.toUpperCase();
            
            if(SES.r === 'admin' || SES.r === 'lider') {
                document.querySelectorAll(".adm-col").forEach(e => e.classList.remove("hidden"));
                if(SES.r === 'admin') document.getElementById("btnHist").classList.remove("hidden");
            }
            fetchData();
            setInterval(fetchData, 30000); 
        }
    }

    function render() {
        const q = document.getElementById("search").value.toLowerCase();
        const filtered = DATA.cob.filter(r => `${r.m} ${r.n} ${r.z} ${r.ref}`.toLowerCase().includes(q));
        const slice = filtered.slice((pag-1)*10, pag*10);
        const tbody = document.getElementById("tbody");
        tbody.innerHTML = "";

        const isEd = (SES.r === 'admin' || SES.r === 'lider');

        slice.forEach(r => {
            const color = r.val=='Cobertura'?'bg-cob':r.val=='Sin Cobertura'?'bg-nocob':r.val=='Consultar'?'bg-cons':'bg-null';
            tbody.innerHTML += `
                <tr>
                    <td>${isEd ? `<input value="${r.m}" id="m-${r.f}">` : r.m}</td>
                    <td>${isEd ? `<input value="${r.n}" id="n-${r.f}" style="font-weight:bold">` : `<b>${r.n}</b>`}</td>
                    <td>${isEd ? `<input value="${r.z}" id="z-${r.f}" style="width:40px">` : r.z}</td>
                    <td>${isEd ? `<input value="${r.ref}" id="r-${r.f}">` : r.ref}</td>
                    <td>
                        <select class="badge ${color}" id="v-${r.f}" ${!isEd?'disabled':''}>
                            <option value="Sin Datos" ${r.val=='Sin Datos'?'selected':''}>Sin Datos</option>
                            <option value="Cobertura" ${r.val=='Cobertura'?'selected':''}>Cobertura</option>
                            <option value="Sin Cobertura" ${r.val=='Sin Cobertura'?'selected':''}>Sin Cobertura</option>
                        </select>
                    </td>
                    <td class="adm-col ${isEd?'':'hidden'}">
                        <button onclick="save(${r.f})" class="btn btn-s" style="padding:5px 10px;"><i class="fa-solid fa-save"></i></button>
                    </td>
                </tr>`;
        });
        document.getElementById("pagInfo").innerText = `P√°gina ${pag} de ${Math.ceil(filtered.length/10) || 1}`;
    }

    async function save(f) {
        const data = {
            action:'update', fila: f, userLog: SES.u,
            m: document.getElementById(`m-${f}`).value,
            n: document.getElementById(`n-${f}`).value,
            z: document.getElementById(`z-${f}`).value,
            ref: document.getElementById(`r-${f}`).value,
            val: document.getElementById(`v-${f}`).value,
            c: "General" 
        };
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
        alert("Guardado!");
        fetchData();
    }

    function exportarExcel() {
        // Exportar SOLO la tabla de cobertura
        const wb = XLSX.utils.book_new();
        const exportData = DATA.cob.map(r => ({
            "Municipio": r.m,
            "Lugar/Punto": r.n,
            "Zona": r.z,
            "Referencia": r.ref,
            "Estado de Cobertura": r.val
        }));
        const ws = XLSX.utils.json_to_sheet(exportData);
        XLSX.utils.book_append_sheet(wb, ws, "COBERTURA DISTELSA");
        XLSX.writeFile(wb, "Cobertura_Distelsa_2026.xlsx");
    }

    function logout() { localStorage.clear(); location.reload(); }
    function changePag(d) { pag = Math.max(1, pag + d); render(); }
    start();
</script>
</body>
</html>
