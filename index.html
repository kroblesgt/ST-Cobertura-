<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA COBERTURA DISTELSA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --primary: #0054a6; --success: #00b050; --danger: #c00000; --warning: #f1c40f; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; }
        .container { max-width: 1500px; margin: 20px auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        th { background: var(--primary); color: white; padding: 12px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #ddd; }
        input { width: 92%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
        .badge { padding: 6px 12px; border-radius: 20px; color: white; font-weight: bold; border: none; cursor: pointer; text-align: center; }
        .bg-verde { background: var(--success); } .bg-rojo { background: var(--danger); } 
        .bg-amarillo { background: var(--warning); color: black; } .bg-gris { background: #95a5a6; }
        .modified { background-color: #fff9c4 !important; }
        .btn { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        #toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 15px 25px; border-radius: 8px; display: none; z-index: 10000; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 5000; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 600px; max-height: 80vh; overflow-y: auto; }
    </style>
</head>
<body>

<div id="toast"></div>

<div class="container">
    <div id="loginPanel" style="text-align:center; padding: 60px 0;">
        <h2 style="color:var(--primary)">SISTEMA DE COBERTURA</h2>
        <input id="userInput" placeholder="Usuario" style="margin-bottom:12px; width: 280px; padding: 12px;"><br>
        <input id="passInput" type="password" placeholder="Contrase침a" style="margin-bottom:20px; width: 280px; padding: 12px;"><br>
        <button id="btnLogin" onclick="login()" class="btn" style="background:var(--primary); width: 305px; justify-content:center;">CARGANDO...</button>
    </div>

    <div id="appPanel" class="hidden">
        <div id="panelNuevo" class="hidden" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; background:#eef2f7; padding:20px; border-radius:10px; margin-bottom:25px; border: 1px solid #d1d9e6;">
            <input id="newMuni" placeholder="Municipio">
            <input id="newNom" placeholder="Nombre">
            <input id="newCat" placeholder="Categor칤a">
            <input id="newZona" placeholder="Zona">
            <input id="newRef" placeholder="Referencia">
            <select id="newEst" style="padding:8px; border-radius:5px;">
                <option value="Sin Datos">Sin Datos</option>
                <option value="Cobertura">Cobertura</option>
                <option value="Sin Cobertura">Sin Cobertura</option>
                <option value="Consultar">Consultar</option>
            </select>
            <button onclick="crearCobertura()" class="btn" style="background:var(--success); grid-column: span 3; justify-content:center;">+ AGREGAR NUEVA UBICACI칍N</button>
        </div>

        <div style="display:flex; gap:12px; margin-bottom:20px;">
            <input id="buscar" placeholder="游댌 Buscar por municipio, nombre o zona..." oninput="pag=1; render()" style="flex-grow:1; padding:12px; font-size:15px;">
            <button id="btnExport" onclick="exportarExcel()" class="btn hidden" style="background:#217346;"><i class="fa-solid fa-file-excel"></i> EXPORTAR</button>
            <button id="btnAdmin" onclick="abrirModal()" class="btn hidden" style="background:var(--warning); color:black;"><i class="fa-solid fa-users-gear"></i> USUARIOS</button>
            <button onclick="logout()" class="btn" style="background:#444;"><i class="fa-solid fa-right-from-bracket"></i> SALIR</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Municipio</th><th>Nombre</th><th>Categor칤a</th><th>Zona</th><th>Referencia</th><th style="width:230px;">Estado / Acciones</th>
                </tr>
            </thead>
            <tbody id="cuerpo"></tbody>
        </table>

        <div style="text-align:center; margin-top:25px; display:flex; justify-content:center; align-items:center; gap:20px;">
            <button id="btnAnt" onclick="cambiarPag(-1)" class="btn" style="background:var(--primary);">ANTERIOR</button>
            <span id="pagTxt" style="font-weight:bold; font-size:14px;">P치gina 1</span>
            <button id="btnSig" onclick="cambiarPag(1)" class="btn" style="background:var(--primary);">SIGUIENTE</button>
        </div>
    </div>
</div>

<div id="modalUser" class="modal hidden">
    <div class="modal-content">
        <h3>Gesti칩n de Usuarios</h3>
        <div id="formU" style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:8px; margin-bottom:20px;">
            <input id="uN" placeholder="User">
            <input id="uP" placeholder="Pass">
            <select id="uR"><option value="Agente">Agente</option><option value="Lider">Lider</option><option value="Admin">Admin</option></select>
            <button onclick="guardarUser()" class="btn" style="background:var(--success); padding:8px;"><i class="fa-solid fa-plus"></i></button>
        </div>
        <div id="listaU"></div>
        <button onclick="cerrarModal()" class="btn" style="background:var(--danger); width:100%; margin-top:20px; justify-content:center;">CERRAR</button>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbwPU0ChTZs0yE745amyh0ajCy_mJW1CsgFqYyR9OCNU0Q8xInKPnJwuntpPlKUTcDwG7Q/exec"; 
    let MASTER = [], USUARIOS = [], ROL = "", pag = 1;

    async function cargarDatos(silencioso = false) {
        try {
            const res = await fetch(API);
            const data = await res.json();
            USUARIOS = data.usuarios.slice(1).map(r => ({ u: String(r[0]), p: String(r[1]), r: String(r[2]) }));
            MASTER = data.cobertura.slice(1).map((r, i) => ({ 
                fila: i + 2, m: r[0], n: r[1], c: r[2], z: r[3], ref: r[4], cob: r[5] || "Sin Datos" 
            }));
            document.getElementById("btnLogin").innerText = "INGRESAR";
            if(!silencioso) checkSession();
            render();
        } catch (e) { showToast("Error al conectar con la base de datos"); }
    }

    function checkSession() {
        const s = localStorage.getItem("distelsa_auth");
        if(s) { const d = JSON.parse(s); const u = USUARIOS.find(x => x.u === d.u && x.p === d.p); if(u) authOk(u.r); }
    }

    function login() {
        const u = document.getElementById("userInput").value.trim(), p = document.getElementById("passInput").value.trim();
        const user = USUARIOS.find(x => x.u === u && x.p === p);
        if(user) { localStorage.setItem("distelsa_auth", JSON.stringify({u, p})); authOk(user.r); } 
        else alert("Usuario o contrase침a incorrectos");
    }

    function authOk(rol) {
        ROL = rol.toLowerCase();
        document.getElementById("loginPanel").classList.add("hidden");
        document.getElementById("appPanel").classList.remove("hidden");
        if(ROL === 'admin' || ROL === 'lider') {
            document.getElementById("panelNuevo").classList.remove("hidden");
            document.getElementById("btnExport").classList.remove("hidden");
        }
        if(ROL === 'admin') document.getElementById("btnAdmin").classList.remove("hidden");
        render();
    }

    function render() {
        const q = document.getElementById("buscar").value.toLowerCase();
        const filt = MASTER.filter(r => `${r.m} ${r.n} ${r.c} ${r.z} ${r.ref} ${r.cob}`.toLowerCase().includes(q));
        
        const totalPags = Math.ceil(filt.length / 10) || 1;
        const segment = filt.slice((pag-1)*10, pag*10); // Regla de los 10
        
        let html = "";
        segment.forEach(r => {
            const col = r.cob=="Cobertura"?"bg-verde":r.cob=="Sin Cobertura"?"bg-rojo":r.cob=="Consultar"?"bg-amarillo":"bg-gris";
            const canEdit = (ROL === 'admin' || ROL === 'lider');
            html += `<tr id="row-${r.fila}">
                <td>${canEdit ? `<input id="m-${r.fila}" value="${r.m}" oninput="marcar(${r.fila})">` : r.m}</td>
                <td>${canEdit ? `<input id="n-${r.fila}" value="${r.n}" oninput="marcar(${r.fila})">` : r.n}</td>
                <td>${canEdit ? `<input id="c-${r.fila}" value="${r.c}" oninput="marcar(${r.fila})">` : r.c}</td>
                <td>${canEdit ? `<input id="z-${r.fila}" value="${r.z}" oninput="marcar(${r.fila})">` : r.z}</td>
                <td>${canEdit ? `<input id="ref-${r.fila}" value="${r.ref}" oninput="marcar(${r.fila})">` : r.ref}</td>
                <td>
                    <div style="display:flex; gap:6px;">
                        <select id="s-${r.fila}" class="badge ${col}" onchange="marcar(${r.fila})">
                            <option value="Sin Datos" ${r.cob=='Sin Datos'?'selected':''}>Sin Datos</option>
                            <option value="Cobertura" ${r.cob=='Cobertura'?'selected':''}>Cobertura</option>
                            <option value="Sin Cobertura" ${r.cob=='Sin Cobertura'?'selected':''}>Sin Cobertura</option>
                            <option value="Consultar" ${r.cob=='Consultar'?'selected':''}>Consultar</option>
                        </select>
                        ${canEdit ? `
                            <button onclick="guardarTodo(${r.fila})" class="btn" style="background:var(--primary); padding:6px;"><i class="fa-solid fa-save"></i></button>
                            <button onclick="eliminarCob(${r.fila}, '${r.n}')" class="btn" style="background:var(--danger); padding:6px;"><i class="fa-solid fa-trash"></i></button>
                        ` : ''}
                    </div>
                </td>
            </tr>`;
        });
        document.getElementById("cuerpo").innerHTML = html;
        document.getElementById("pagTxt").innerText = `P치gina ${pag} de ${totalPags}`;
        document.getElementById("btnAnt").disabled = pag === 1;
        document.getElementById("btnSig").disabled = pag >= totalPags;
    }

    async function guardarTodo(fila) {
        const body = {
            action: 'updateFullCob', fila,
            m: document.getElementById(`m-${fila}`).value,
            n: document.getElementById(`n-${fila}`).value,
            c: document.getElementById(`c-${fila}`).value,
            z: document.getElementById(`z-${fila}`).value,
            ref: document.getElementById(`ref-${fila}`).value,
            val: document.getElementById(`s-${fila}`).value
        };
        showToast("Sincronizando con Excel...");
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify(body) });
        const item = MASTER.find(x => x.fila === fila);
        Object.assign(item, { m: body.m, n: body.n, c: body.c, z: body.z, ref: body.ref, cob: body.val });
        document.getElementById(`row-${fila}`).classList.remove('modified');
        render();
        showToast("춰Cambios guardados!");
    }

    async function crearCobertura() {
        const d = {
            action: 'addCob',
            m: document.getElementById("newMuni").value, n: document.getElementById("newNom").value,
            c: document.getElementById("newCat").value, z: document.getElementById("newZona").value,
            ref: document.getElementById("newRef").value, val: document.getElementById("newEst").value
        };
        if(!d.m || !d.n) return alert("Municipio y Nombre son obligatorios");
        showToast("Agregando registro...");
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify(d) });
        location.reload(); 
    }

    async function eliminarCob(fila, n) {
        if(!confirm(`쮻esea eliminar permanentemente "${n}"?`)) return;
        showToast("Eliminando...");
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'deleteCob', fila }) });
        MASTER = MASTER.filter(x => x.fila !== fila);
        render();
    }

    function exportarExcel() {
        const q = document.getElementById("buscar").value.toLowerCase();
        const filt = MASTER.filter(r => `${r.m} ${r.n} ${r.c} ${r.z} ${r.ref} ${r.cob}`.toLowerCase().includes(q));
        let csv = "Municipio,Nombre,Categoria,Zona,Referencia,Estado\n";
        filt.forEach(r => csv += `"${r.m}","${r.n}","${r.c}","${r.z}","${r.ref}","${r.cob}"\n`);
        const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Reporte_Distelsa_${new Date().toLocaleDateString()}.csv`;
        link.click();
    }

    // Funciones de Usuarios y Auxiliares
    function marcar(f) { document.getElementById(`row-${f}`).classList.add('modified'); }
    function cambiarPag(v) { pag += v; render(); }
    function showToast(m) { const t = document.getElementById("toast"); t.innerText = m; t.style.display="block"; setTimeout(()=>t.style.display="none", 3000); }
    function logout() { localStorage.removeItem("distelsa_auth"); location.reload(); }
    function abrirModal() { document.getElementById("modalUser").classList.remove("hidden"); renderUsers(); }
    function cerrarModal() { document.getElementById("modalUser").classList.add("hidden"); }

    function renderUsers() {
        let html = "";
        USUARIOS.forEach(u => {
            html += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
                <span><b>${u.u}</b> (${u.r})</span>
                <button onclick="eliminarUser('${u.u}')" style="color:var(--danger); border:none; background:none; cursor:pointer;"><i class="fa-solid fa-trash"></i></button>
            </div>`;
        });
        document.getElementById("listaU").innerHTML = html;
    }

    async function guardarUser() {
        const usuario = document.getElementById("uN").value, clave = document.getElementById("uP").value, rol = document.getElementById("uR").value;
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'addUser', usuario, clave, rol }) });
        await cargarDatos(true); abrirModal();
    }

    async function eliminarUser(u) {
        if(!confirm("쮼liminar usuario?")) return;
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'delete', usuarioNombre: u }) });
        await cargarDatos(true); abrirModal();
    }

    window.onload = cargarDatos;
</script>
</body>
</html>
