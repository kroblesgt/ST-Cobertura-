<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DISTELSA - Cobertura 2026</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --p: #003399; --s: #28a745; --d: #dc3545; --w: #ffc107; --g: #95a5a6; --bg: #f4f7f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; }
        .hidden { display: none !important; }
        
        header { background: white; border-bottom: 5px solid var(--p); padding: 10px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo { font-weight: 900; color: var(--p); font-size: 26px; letter-spacing: -1px; text-transform: uppercase; }

        .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        /* Online Status Badge */
        .online-badge { background: #eef2ff; color: var(--p); padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: bold; border: 1px solid #cdd9f7; position: relative; cursor: pointer; }
        .online-list { display: none; position: absolute; top: 110%; right: 0; background: white; border: 1px solid #ddd; width: 180px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 100; border-radius: 6px; padding: 10px; }
        .online-badge:hover .online-list { display: block; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; color: #555; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        
        .btn { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 13px; }
        .btn-p { background: var(--p); color: white; }
        .btn-s { background: var(--s); color: white; }
        .btn-d { background: var(--d); color: white; }
        .btn-export { background: #1d6f42; color: white; }

        /* Colores Solicitados */
        .badge { padding: 5px 8px; border-radius: 4px; color: white; font-size: 11px; font-weight: bold; text-transform: uppercase; border: none; width: 100%; }
        .bg-cob { background: var(--s); }      /* Verde */
        .bg-nocob { background: var(--d); }    /* Rojo */
        .bg-cons { background: var(--w); color: black; } /* Amarillo */
        .bg-null { background: var(--g); }     /* Gris */
        
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; outline: none; }
        .search-bar { flex-grow: 1; border: 2px solid #eee; font-size: 16px; padding: 10px; }
        
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index: 1000; }
        .modal-box { background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto; }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:20px;">
        <div class="logo">DISTELSA</div>
        <div style="width:1.5px; height:25px; background:#ddd;"></div>
        <h2 style="margin:0; font-size:15px; color:#777; letter-spacing: 1px;">COBERTURA</h2>
    </div>
    
    <div id="navRight" class="hidden" style="display:flex; align-items:center; gap:15px;">
        <div class="online-badge" id="onlineWidget">
            <i class="fa-solid fa-circle" style="color:var(--s); font-size:9px;"></i> 
            <span id="onlineCount">0</span> En L√≠nea
            <div id="onlineNames" class="online-list"></div>
        </div>
        <span id="userName" style="font-weight:bold; color:var(--p);"></span>
        <button onclick="logout()" class="btn" style="color:var(--d); border:1px solid var(--d); background:none;"><i class="fa-solid fa-power-off"></i></button>
    </div>
</header>

<div id="loginBox" class="container" style="max-width: 360px; margin-top: 15vh;">
    <div class="card" style="text-align: center; border-top: 4px solid var(--p);">
        <h3 style="color:var(--p)">Acceso al Portal</h3>
        <input type="text" id="user" placeholder="Usuario" style="width:90%; margin-bottom:10px;">
        <input type="password" id="pass" placeholder="Contrase√±a" style="width:90%; margin-bottom:20px;">
        <button onclick="login()" class="btn btn-p" style="width:95%; justify-content:center;">ENTRAR</button>
    </div>
</div>

<div id="app" class="container hidden">
    <div class="card">
        <div style="display:flex; justify-content:space-between; gap:10px; margin-bottom:20px;">
            <input type="text" id="search" class="search-bar" placeholder="üîç Buscar municipio o lugar..." onkeyup="pag=1; render()">
            <div style="display:flex; gap:8px;">
                <button id="btnExcel" onclick="exportarExcel()" class="btn btn-export hidden" title="Exportar"><i class="fa-solid fa-file-excel"></i></button>
                <button id="btnHist" onclick="toggleModal('modalHist', true)" class="btn btn-p hidden" title="Auditor√≠a"><i class="fa-solid fa-clock-rotate-left"></i></button>
                <button id="btnUsers" onclick="toggleModal('modalUsers', true)" class="btn btn-s hidden" title="Usuarios"><i class="fa-solid fa-user-gear"></i></button>
            </div>
        </div>

        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>Municipio</th>
                        <th>Lugar/Punto</th>
                        <th>Zona</th>
                        <th>Referencia</th>
                        <th>Estado</th>
                        <th class="adm-col hidden">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>

        <div style="text-align:center; margin-top:20px; display:flex; justify-content:center; align-items:center; gap:15px;">
            <button onclick="changePag(-1)" id="btnPrev" class="btn btn-p"><i class="fa-solid fa-chevron-left"></i></button>
            <span id="pagInfo" style="font-weight:bold; color:#666;">P√°gina 1</span>
            <button onclick="changePag(1)" id="btnNext" class="btn btn-p"><i class="fa-solid fa-chevron-right"></i></button>
        </div>
    </div>
</div>

<div id="modalUsers" class="modal-overlay hidden">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; color:var(--p);">Gesti√≥n de Usuarios</h3>
            <button onclick="toggleModal('modalUsers', false)" class="btn btn-d">X</button>
        </div>
        <div style="background:#f8f9fa; padding:15px; border-radius:5px; margin-bottom:15px; display:flex; gap:5px;">
            <input id="unN" placeholder="Nombre" style="width:30%;">
            <input id="unP" placeholder="Clave" style="width:30%;">
            <select id="unR" style="width:30%;"><option value="agente">Agente</option><option value="lider">L√≠der</option><option value="admin">Admin</option></select>
            <button onclick="manageUser('add')" class="btn btn-s">A√±adir</button>
        </div>
        <div id="listUsers"></div>
    </div>
</div>

<div id="modalHist" class="modal-overlay hidden">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; color:var(--p);">Historial de Cambios</h3>
            <button onclick="toggleModal('modalHist', false)" class="btn btn-d">X</button>
        </div>
        <div id="histContent" style="font-size:12px;"></div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxQwzjO5hwj0ObxkJIK8jTWuOANGLO90sApgtIzWIm88pZheecy9EuO9lwNkPKXkvscww/exec"; 
    let DATA = { cob: [], logs: [], users: [], tokens: {}, online: [] };
    let SES = { u: "", r: "", tk: "" };
    let pag = 1;

    async function fetchData() {
        try {
            const res = await fetch(API_URL);
            const json = await res.json();
            
            if (SES.u && json.tokens[SES.u.toLowerCase()] !== SES.tk) {
                alert("Sesi√≥n cerrada: Acceso desde otro dispositivo.");
                logout(); return;
            }

            DATA.cob = json.cobertura.slice(1).map((r,i) => ({f:i+2, m:r[0], n:r[1], c:r[2]||"G", z:r[3], ref:r[4], val:r[5]||"Sin Datos"}));
            DATA.logs = json.historial;
            DATA.users = json.usuariosList;
            DATA.online = json.onlineList;

            // Actualizar Widget Online
            document.getElementById("onlineCount").innerText = DATA.online.length;
            if(SES.r === 'admin') {
                document.getElementById("onlineNames").innerHTML = "<b>Activos:</b><hr>" + DATA.online.map(u => `<div>‚Ä¢ ${u}</div>`).join('');
            } else {
                document.getElementById("onlineNames").innerHTML = "<i>Solo visible para Admin</i>";
            }

            if(SES.u) render();
        } catch(e) { console.warn("Error de red"); }
    }

    async function login() {
        const u = document.getElementById("user").value, p = document.getElementById("pass").value;
        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({action:'login', u, p}) });
        const rj = await res.json();
        if(rj.status === 'ok') {
            SES = { u, r: rj.rol, tk: rj.token };
            localStorage.setItem("distelsa_v2", JSON.stringify(SES));
            start();
        } else alert("Datos incorrectos");
    }

    function start() {
        const storage = localStorage.getItem("distelsa_v2");
        if(storage) {
            SES = JSON.parse(storage);
            document.getElementById("loginBox").classList.add("hidden");
            document.getElementById("app").classList.remove("hidden");
            document.getElementById("navRight").classList.remove("hidden");
            document.getElementById("userName").innerText = SES.u.toUpperCase();
            
            if(SES.r === 'admin' || SES.r === 'lider') {
                document.querySelectorAll(".adm-col").forEach(e => e.classList.remove("hidden"));
                document.getElementById("btnExcel").classList.remove("hidden");
            }
            if(SES.r === 'admin') {
                document.getElementById("btnHist").classList.remove("hidden");
                document.getElementById("btnUsers").classList.remove("hidden");
            }
            fetchData();
            setInterval(() => {
                fetch(API_URL, { method:'POST', body: JSON.stringify({action:'heartbeat', u: SES.u}) });
                fetchData();
            }, 30000);
        }
    }

    function render() {
        const q = document.getElementById("search").value.toLowerCase();
        const filtered = DATA.cob.filter(r => `${r.m} ${r.n} ${r.z} ${r.ref}`.toLowerCase().includes(q));
        const totalPags = Math.ceil(filtered.length/10) || 1;
        const slice = filtered.slice((pag-1)*10, pag*10);
        const tbody = document.getElementById("tbody");
        tbody.innerHTML = "";

        const canEdit = SES.r === 'admin' || SES.r === 'lider';

        slice.forEach(r => {
            const cls = r.val=='Cobertura'?'bg-cob':r.val=='Sin Cobertura'?'bg-nocob':r.val=='Consultar'?'bg-cons':'bg-null';
            tbody.innerHTML += `
                <tr>
                    <td>${canEdit ? `<input id="m-${r.f}" value="${r.m}">` : r.m}</td>
                    <td>${canEdit ? `<input id="n-${r.f}" value="${r.n}" style="font-weight:bold">` : `<b>${r.n}</b>`}</td>
                    <td>${canEdit ? `<input id="z-${r.f}" value="${r.z}" style="width:40px">` : r.z}</td>
                    <td>${canEdit ? `<input id="r-${r.f}" value="${r.ref}">` : r.ref}</td>
                    <td>
                        <select id="v-${r.f}" class="badge ${cls}" ${!canEdit?'disabled':''} onchange="this.className='badge '+ (this.value=='Cobertura'?'bg-cob':this.value=='Sin Cobertura'?'bg-nocob':this.value=='Consultar'?'bg-cons':'bg-null')">
                            <option value="Sin Datos" ${r.val=='Sin Datos'?'selected':''}>Sin Datos</option>
                            <option value="Cobertura" ${r.val=='Cobertura'?'selected':''}>Cobertura</option>
                            <option value="Sin Cobertura" ${r.val=='Sin Cobertura'?'selected':''}>Sin Cobertura</option>
                            <option value="Consultar" ${r.val=='Consultar'?'selected':''}>Consultar</option>
                        </select>
                    </td>
                    <td class="adm-col ${canEdit?'':'hidden'}">
                        <button onclick="save(${r.f})" class="btn btn-s"><i class="fa-solid fa-save"></i></button>
                    </td>
                </tr>`;
        });
        document.getElementById("pagInfo").innerText = `P√°gina ${pag} de ${totalPags}`;
        document.getElementById("btnPrev").disabled = pag === 1;
        document.getElementById("btnNext").disabled = pag >= totalPags;
    }

    async function save(f) {
        const d = {
            action:'update', fila: f, userLog: SES.u,
            m: document.getElementById(`m-${f}`).value, n: document.getElementById(`n-${f}`).value,
            z: document.getElementById(`z-${f}`).value, ref: document.getElementById(`r-${f}`).value,
            val: document.getElementById(`v-${f}`).value
        };
        await fetch(API_URL, { method:'POST', mode:'no-cors', body: JSON.stringify(d) });
        alert("Actualizado"); fetchData();
    }

    async function manageUser(type, name) {
        const u = name || document.getElementById("unN").value, p = document.getElementById("unP").value, r = document.getElementById("unR").value;
        await fetch(API_URL, { method:'POST', body: JSON.stringify({action:'manageUser', type, u, p, r, userLog: SES.u}) });
        fetchData(); toggleModal('modalUsers', false);
    }

    function toggleModal(id, show) {
        document.getElementById(id).classList.toggle("hidden", !show);
        if(id === 'modalUsers' && show) {
            document.getElementById("listUsers").innerHTML = DATA.users.map(u => `
                <div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;">
                    <span>${u[0]} (${u[2]})</span>
                    <button onclick="manageUser('del','${u[0]}')" style="color:red; border:none; background:none; cursor:pointer;">Eliminar</button>
                </div>`).join('');
        }
        if(id === 'modalHist' && show) {
            document.getElementById("histContent").innerHTML = `<table><thead><tr><th>Fecha</th><th>Usuario</th><th>Acci√≥n</th><th>Detalle</th></tr></thead><tbody>` + 
                DATA.logs.map(l => `<tr><td>${new Date(l[0]).toLocaleString()}</td><td>${l[1]}</td><td>${l[2]}</td><td>${l[3]}</td></tr>`).join('') + `</tbody></table>`;
        }
    }

    function exportarExcel() {
        const ws = XLSX.utils.json_to_sheet(DATA.cob.map(r => ({ Municipio: r.m, Lugar: r.n, Zona: r.z, Referencia: r.ref, Estado: r.val })));
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Cobertura");
        XLSX.writeFile(wb, "Cobertura_Distelsa_2026.xlsx");
    }

    function changePag(v) { pag = Math.max(1, pag + v); render(); }
    function logout() { localStorage.clear(); location.reload(); }
    start();
</script>
</body>
</html>
