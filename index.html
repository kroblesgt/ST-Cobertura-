<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA COBERTURA | CALL CENTER</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --primary: #0054a6; --success: #00b050; --danger: #c00000; --warning: #f1c40f; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', sans-serif; background:#f0f2f5; margin:0; }

        /* DESTELLO AZUL RECOMENDADO (1.5s) */
        @keyframes destello {
            0% { background-color: white; box-shadow: 0 0 0px rgba(0, 84, 166, 0); }
            50% { background-color: #eef7ff; box-shadow: inset 0 0 15px rgba(0, 84, 166, 0.4); }
            100% { background-color: #f8fbff; box-shadow: inset 0 0 5px rgba(0, 84, 166, 0.1); }
        }
        .mejor-coincidencia { animation: destello 1.5s infinite alternate ease-in-out; border-left: 6px solid var(--primary) !important; font-weight: bold; }

        .header { background: white; padding: 10px 30px; border-bottom: 5px solid var(--primary); display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header img { height: 50px; }

        .container { max-width: 98%; margin: 15px auto; background: white; padding: 20px; border-radius: 10px; }
        .hidden { display: none !important; }

        /* BARRA DE BÚSQUEDA TIPO CALL CENTER */
        .search-area { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; width: 100%; }
        .input-box { position: relative; flex: 1; }
        .input-box i { position: absolute; left: 15px; top: 14px; color: #999; }
        #buscar { width: 100%; padding: 12px 40px; border-radius: 8px; border: 2px solid #0054a6; font-size: 16px; box-sizing: border-box; }
        .btn-clear { position: absolute; right: 10px; top: 8px; background: #eee; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer; color: #666; }

        .btn { padding: 10px 15px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; font-size: 12px; }
        .btn-success { background: var(--success); color: white; }
        .btn-admin { background: var(--warning); color: #222; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: var(--primary); color: white; padding: 10px; font-size: 12px; text-align: left; position: sticky; top: 0; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 13px; }

        .badge { padding: 5px; border-radius: 10px; color: white; font-weight: bold; font-size: 11px; width: 100%; border: none; text-align: center; }
        .bg-verde { background: var(--success); } .bg-rojo { background: var(--danger); } 
        .bg-amarillo { background: var(--warning); color: black; } .bg-gris { background: #95a5a6; }

        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--dark); color: white; padding: 10px 20px; border-radius: 20px; display: none; z-index: 5000; }
    </style>
</head>
<body>

<div id="toast"></div>

<header class="header">
    <img src="https://drive.google.com/thumbnail?id=1bawJf9oARBLy2itsOfA9YE8RVAFNdNef" alt="Logo">
    <div>
        <h2 style="margin:0; color:var(--primary); font-size: 18px;">CONSULTA DE COBERTURA</h2>
        <small id="lastSync" style="color: #666;">Cargando base de datos...</small>
    </div>
    <button onclick="cerrarSesion()" id="logoutBtn" class="btn hidden" style="background:#eee"><i class="fa-solid fa-right-from-bracket"></i> SALIR</button>
</header>

<div class="container">
    <div id="loginPanel" style="max-width: 300px; margin: 50px auto; text-align: center;">
        <input id="userInput" type="text" placeholder="Usuario" style="width:100%; padding:10px; margin-bottom:10px;">
        <input id="passInput" type="password" placeholder="Contraseña" style="width:100%; padding:10px; margin-bottom:15px;">
        <button id="btnLogin" onclick="login()" disabled class="btn" style="background:var(--primary); color:white; width:100%; justify-content:center;">INGRESAR</button>
    </div>

    <div id="appPanel" class="hidden">
        <div class="search-area">
            <div class="input-box">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input id="buscar" placeholder="Busque aquí (ej: milagrw z 6 mixco)" oninput="render()">
                <button class="btn-clear" onclick="limpiarBuscador()"><i class="fa-solid fa-broom"></i> Limpiar</button>
            </div>
            <div id="adminTools" style="display:flex; gap:5px;">
                <button id="btnNuevaDir" onclick="abrirModalDir()" class="btn btn-success hidden"><i class="fa-solid fa-plus"></i> NUEVA</button>
                <button id="btnAdmin" class="btn btn-admin hidden"><i class="fa-solid fa-users"></i></button>
            </div>
        </div>

        <div style="overflow-x: auto; max-height: 65vh;">
            <table>
                <thead>
                    <tr>
                        <th>Municipio</th>
                        <th>Nombre / Lugar</th>
                        <th>Cat.</th>
                        <th>Zona</th>
                        <th>Referencia</th>
                        <th style="width:120px">Estado</th>
                    </tr>
                </thead>
                <tbody id="cuerpo"></tbody>
            </table>
        </div>

        <div style="display:flex; justify-content:center; gap:15px; margin-top:15px; align-items:center;">
            <button class="btn" style="background:#ddd" onclick="cambiarPag(-1)"><i class="fa-solid fa-arrow-left"></i></button>
            <span id="pagTxt" style="font-size:13px; font-weight:bold;">Página 1</span>
            <button class="btn" style="background:#ddd" onclick="cambiarPag(1)"><i class="fa-solid fa-arrow-right"></i></button>
        </div>
    </div>
</div>

<div id="modalDir" class="modal hidden">
    <div style="background:white; padding:20px; border-radius:10px; width:350px; display:flex; flex-direction:column; gap:10px; box-shadow: 0 0 20px rgba(0,0,0,0.3);">
        <h3 style="margin:0">Agregar Nueva Ubicación</h3>
        <input id="addMuni" placeholder="Municipio">
        <input id="addNom" placeholder="Nombre (Colonia/Aldea)">
        <select id="addCat"><option>COLONIA</option><option>ALDEA</option><option>CASERIO</option><option>ZONA</option></select>
        <input id="addZona" placeholder="Zona (solo número)">
        <textarea id="addRef" placeholder="Puntos de referencia" style="height:50px"></textarea>
        <select id="addEst"><option>Cobertura</option><option>Sin Cobertura</option><option>Consultar</option><option>Sin Datos</option></select>
        <button onclick="guardarNuevaDireccion()" class="btn btn-success" style="justify-content:center">GUARDAR EN EXCEL</button>
        <button onclick="cerrarModalDir()" class="btn" style="background:#eee; justify-content:center">CANCELAR</button>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbwxArEj1IaeXjR7b9raMrXtDnDjIq0HH6eGmT_wxoR1QEhJ5cN--pARkOIFJe39aqY16g/exec";
    let MASTER = [], USUARIOS = [], ROL = "", pag = 1;

    // ALGORITMO DE DISTANCIA LEVENSHTEIN (Para errores de escritura)
    function similitud(s1, s2) {
        s1 = s1.toLowerCase(); s2 = s2.toLowerCase();
        let m = s1.length, n = s2.length;
        let d = Array.from(Array(m + 1), () => Array(n + 1).fill(0));
        for (let i = 0; i <= m; i++) d[i][0] = i;
        for (let j = 0; j <= n; j++) d[0][j] = j;
        for (let j = 1; j <= n; j++) {
            for (let i = 1; i <= m; i++) {
                let cost = (s1[i - 1] === s2[j - 1]) ? 0 : 1;
                d[i][j] = Math.min(d[i - 1][j] + 1, d[i][j - 1] + 1, d[i - 1][j - 1] + cost);
            }
        }
        let maxLen = Math.max(m, n);
        return maxLen === 0 ? 1 : (maxLen - d[m][n]) / maxLen;
    }

    async function cargarDatos() {
        try {
            const res = await fetch(API);
            const data = await res.json();
            USUARIOS = data.usuarios.slice(1).map(r => ({ u: String(r[0]).trim().toLowerCase(), p: String(r[1]).trim(), r: String(r[2]).trim().toLowerCase() }));
            MASTER = data.cobertura.slice(1).map((r, i) => ({ 
                fila: i + 2, m: String(r[0]), n: String(r[1]), cat: String(r[2]), z: String(r[3]), ref: String(r[4] || ""), cob: String(r[5] || "Sin Datos") 
            }));
            document.getElementById("lastSync").innerText = "Base de Datos Lista: " + new Date().toLocaleTimeString();
            document.getElementById("btnLogin").disabled = false;
            if (localStorage.getItem("distelsa_session")) login();
        } catch (e) { console.error(e); }
    }

    function login() {
        const u = document.getElementById("userInput").value.trim().toLowerCase() || JSON.parse(localStorage.getItem("distelsa_session"))?.u;
        const p = document.getElementById("passInput").value.trim() || JSON.parse(localStorage.getItem("distelsa_session"))?.p;
        const user = USUARIOS.find(x => x.u === u && x.p === p);
        if(user) {
            ROL = user.r;
            localStorage.setItem("distelsa_session", JSON.stringify({ u, p }));
            document.getElementById("loginPanel").classList.add("hidden");
            document.getElementById("appPanel").classList.remove("hidden");
            document.getElementById("logoutBtn").classList.remove("hidden");
            if(ROL === 'admin' || ROL === 'lider') document.getElementById("btnNuevaDir").classList.remove("hidden");
            if(ROL === 'admin') document.getElementById("btnAdmin").classList.remove("hidden");
            render();
        }
    }

    function render() {
        const query = document.getElementById("buscar").value.toLowerCase().trim();
        const terminos = query.split(/\s+/).filter(t => t.length > 0);
        
        let filtrados = [];

        if (terminos.length > 0) {
            filtrados = MASTER.map(r => {
                let maxScore = 0;
                let contenidoFila = `${r.m} ${r.n} ${r.cat} ${r.z}`.toLowerCase();
                
                // Calculamos qué tan bien coincide la búsqueda con la fila
                let matches = 0;
                terminos.forEach(t => {
                    // Si la palabra está exacta, puntaje alto
                    if (contenidoFila.includes(t)) {
                        matches++;
                    } else {
                        // Si no, buscamos por similitud (ej: milagrw vs milagro)
                        let palabrasFila = contenidoFila.split(/\s+/);
                        let mejorSim = Math.max(...palabrasFila.map(pf => similitud(pf, t)));
                        if (mejorSim > 0.7) matches += mejorSim;
                    }
                });
                return { ...r, score: matches };
            })
            .filter(r => r.score >= terminos.length * 0.6) // Filtro de calidad
            .sort((a, b) => b.score - a.score);
        } else {
            filtrados = MASTER;
        }

        const segment = filtrados.slice((pag - 1) * 10, pag * 10);
        let html = "";
        segment.forEach((r, idx) => {
            let col = r.cob=="Cobertura"?"bg-verde":r.cob=="Sin Cobertura"?"bg-rojo":r.cob=="Consultar"?"bg-amarillo":"bg-gris";
            let destello = (query.length > 2 && idx === 0 && pag === 1) ? "mejor-coincidencia" : "";
            let stHTML = (ROL === 'admin' || ROL === 'lider') ? 
                `<select class="badge ${col}" onchange="guardarEstado(${r.fila}, this.value)">
                    <option value="Sin Datos" ${r.cob=='Sin Datos'?'selected':''}>Sin Datos</option>
                    <option value="Cobertura" ${r.cob=='Cobertura'?'selected':''}>Cobertura</option>
                    <option value="Sin Cobertura" ${r.cob=='Sin Cobertura'?'selected':''}>Sin Cobertura</option>
                    <option value="Consultar" ${r.cob=='Consultar'?'selected':''}>Consultar</option>
                </select>` : `<span class="badge ${col}">${r.cob}</span>`;

            html += `<tr class="${destello}">
                <td>${r.m}</td><td>${r.n}</td><td>${r.cat}</td><td>${r.z}</td>
                <td style="font-size:11px; color: #666;">${r.ref}</td><td>${stHTML}</td>
            </tr>`;
        });
        document.getElementById("cuerpo").innerHTML = html;
        document.getElementById("pagTxt").innerText = `Página ${pag} de ${Math.ceil(filtrados.length/10) || 1}`;
    }

    function limpiarBuscador() { document.getElementById("buscar").value = ""; render(); }
    function abrirModalDir() { document.getElementById("modalDir").classList.remove("hidden"); }
    function cerrarModalDir() { document.getElementById("modalDir").classList.add("hidden"); }
    function cambiarPag(v) { pag += v; render(); }
    function cerrarSesion() { localStorage.removeItem("distelsa_session"); location.reload(); }
    function showToast(m) { const t = document.getElementById("toast"); t.innerText = m; t.style.display = "block"; setTimeout(()=>t.style.display="none", 2500); }

    async function guardarEstado(fila, val) {
        showToast("Actualizando Excel...");
        await fetch(`${API}?action=updateCob&fila=${fila}&valor=${encodeURIComponent(val)}`, { method: 'POST', mode: 'no-cors' });
        showToast("✓ Guardado correctamente");
    }

    async function guardarNuevaDireccion() {
        const p = `?action=addAddress&muni=${encodeURIComponent(document.getElementById("addMuni").value)}&nom=${encodeURIComponent(document.getElementById("addNom").value)}&cat=${encodeURIComponent(document.getElementById("addCat").value)}&zona=${encodeURIComponent(document.getElementById("addZona").value)}&ref=${encodeURIComponent(document.getElementById("addRef").value)}&est=${encodeURIComponent(document.getElementById("addEst").value)}`;
        await fetch(API + p, { method: 'POST', mode: 'no-cors' });
        cerrarModalDir();
        showToast("✓ Nueva ubicación agregada");
        setTimeout(cargarDatos, 1500);
    }

    window.onload = cargarDatos;
</script>
</body>
</html>
