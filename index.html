<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA COBERTURA | DISTELSA MASTER</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --primary: #0054a6; --success: #00b050; --danger: #c00000; --warning: #f1c40f; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', sans-serif; background:#f0f2f5; margin:0; overflow-x: hidden; }

        @keyframes destello {
            0% { background-color: white; box-shadow: 0 0 0px rgba(0, 84, 166, 0); }
            50% { background-color: #eef7ff; box-shadow: inset 0 0 15px rgba(0, 84, 166, 0.4); }
            100% { background-color: #f8fbff; box-shadow: inset 0 0 5px rgba(0, 84, 166, 0.1); }
        }
        .mejor-coincidencia { animation: destello 1.5s infinite alternate ease-in-out; border-left: 6px solid var(--primary) !important; }

        .header { background: white; padding: 10px 30px; border-bottom: 5px solid var(--primary); display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header img { height: 45px; }

        .container { max-width: 98%; margin: 15px auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }

        /* BUSCADOR Y HERRAMIENTAS */
        .search-area { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        .input-box { position: relative; flex: 1; min-width: 300px; }
        .input-box i { position: absolute; left: 15px; top: 14px; color: #999; }
        #buscar { width: 100%; padding: 12px 45px; border-radius: 8px; border: 2px solid var(--primary); font-size: 16px; outline: none; box-sizing: border-box; }
        .btn-clear { position: absolute; right: 10px; top: 8px; background: #eee; border: none; border-radius: 5px; padding: 6px 12px; cursor: pointer; color: #666; }

        /* TABLA */
        .table-container { overflow-x: auto; max-height: 60vh; border: 1px solid #eee; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: var(--primary); color: white; padding: 12px; font-size: 12px; text-align: left; position: sticky; top: 0; z-index: 10; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 13px; vertical-align: middle; }

        .badge { padding: 8px; border-radius: 8px; color: white; font-weight: bold; font-size: 11px; width: 100%; border: none; cursor: pointer; text-align: center; }
        .bg-verde { background: var(--success) !important; }
        .bg-rojo { background: var(--danger) !important; }
        .bg-amarillo { background: var(--warning) !important; color: black !important; }
        .bg-gris { background: #95a5a6 !important; }

        /* MODALES */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index:2000; }
        .modal-content { background:white; padding:25px; border-radius:12px; width:400px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }

        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--dark); color: white; padding: 12px 25px; border-radius: 30px; display: none; z-index: 5000; font-size: 14px; }
    </style>
</head>
<body>

<div id="toast"></div>

<header class="header">
    <img src="https://drive.google.com/thumbnail?id=1bawJf9oARBLy2itsOfA9YE8RVAFNdNef" alt="Logo">
    <div style="text-align:center">
        <h2 style="margin:0; color:var(--primary); font-size: 18px; letter-spacing: 1px;">CONSULTA DE COBERTURA</h2>
        <small id="lastSync" style="color: #888;">Iniciando sistema...</small>
    </div>
    <button onclick="cerrarSesion()" id="logoutBtn" class="hidden" style="border:none; background:none; cursor:pointer; font-size: 22px; color:#c00000;"><i class="fa-solid fa-power-off"></i></button>
</header>

<div class="container">
    <div id="loginPanel" style="max-width: 320px; margin: 60px auto; text-align: center; padding: 20px; border: 1px solid #eee; border-radius: 10px;">
        <h3 style="color: var(--primary);">ACCESO AGENTES</h3>
        <input id="userInput" type="text" placeholder="Usuario" style="width:100%; padding:12px; margin-bottom:12px; border:1px solid #ccc; border-radius:6px; box-sizing: border-box;">
        <input id="passInput" type="password" placeholder="Contraseña" style="width:100%; padding:12px; margin-bottom:18px; border:1px solid #ccc; border-radius:6px; box-sizing: border-box;">
        <button id="btnLogin" onclick="login()" disabled style="width:100%; padding:14px; background:var(--primary); color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">INGRESAR AL PANEL</button>
    </div>

    <div id="appPanel" class="hidden">
        <div class="search-area">
            <div class="input-box">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input id="buscar" placeholder="Busque por nombre, zona o municipio (ej: milagrw z6 mix)..." oninput="render()">
                <button class="btn-clear" onclick="limpiarBuscador()"><i class="fa-solid fa-broom"></i></button>
            </div>
            <div id="adminTools" style="display:flex; gap:8px;">
                <button id="btnNuevaDir" onclick="abrirModalDir()" class="hidden" style="background:var(--success); color:white; border:none; padding:0 15px; height:45px; border-radius:8px; cursor:pointer; font-weight:bold;">+ NUEVA</button>
                <button id="btnAdminUsers" onclick="abrirModalUsers()" class="hidden" style="background:var(--warning); color:black; border:none; padding:0 15px; height:45px; border-radius:8px; cursor:pointer; font-weight:bold;"><i class="fa-solid fa-users-gear"></i> USUARIOS</button>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Municipio</th>
                        <th>Nombre / Lugar</th>
                        <th>Categoría</th>
                        <th style="text-align:center;">Zona</th>
                        <th>Referencia</th>
                        <th style="width:150px">Estado Cobertura</th>
                    </tr>
                </thead>
                <tbody id="cuerpo"></tbody>
            </table>
        </div>

        <div style="display:flex; justify-content:center; gap:20px; margin-top:15px; align-items:center;">
            <button onclick="cambiarPag(-1)" style="padding:10px 20px; cursor:pointer; border-radius:5px; border:1px solid #ccc;">ANTERIOR</button>
            <span id="pagTxt" style="font-weight:bold;">Página 1</span>
            <button onclick="cambiarPag(1)" style="padding:10px 20px; cursor:pointer; border-radius:5px; border:1px solid #ccc;">SIGUIENTE</button>
        </div>
    </div>
</div>

<div id="modalDir" class="modal-overlay hidden">
    <div class="modal-content">
        <h3 style="margin-top:0; color:var(--primary); border-bottom: 2px solid #eee; padding-bottom:10px;">Agregar Cobertura</h3>
        <label style="font-size:12px; font-weight:bold;">Municipio:</label>
        <input id="addMuni" style="width:100%; padding:10px; margin-bottom:10px; box-sizing:border-box;">
        <label style="font-size:12px; font-weight:bold;">Nombre (Colonia/Caserío):</label>
        <input id="addNom" style="width:100%; padding:10px; margin-bottom:10px; box-sizing:border-box;">
        <label style="font-size:12px; font-weight:bold;">Categoría:</label>
        <select id="addCat" style="width:100%; padding:10px; margin-bottom:10px;"><option>COLONIA</option><option>ALDEA</option><option>CASERIO</option><option>ZONA</option><option>KM</option></select>
        <label style="font-size:12px; font-weight:bold;">Zona:</label>
        <input id="addZona" type="number" style="width:100%; padding:10px; margin-bottom:10px; box-sizing:border-box;">
        <label style="font-size:12px; font-weight:bold;">Referencias:</label>
        <textarea id="addRef" style="width:100%; height:60px; padding:10px; margin-bottom:10px; box-sizing:border-box;"></textarea>
        <label style="font-size:12px; font-weight:bold;">Estado Inicial:</label>
        <select id="addEst" style="width:100%; padding:10px; margin-bottom:20px;"><option>Cobertura</option><option>Sin Cobertura</option><option>Consultar</option><option>Sin Datos</option></select>
        <button onclick="guardarNuevaDireccion()" style="width:100%; padding:12px; background:var(--success); color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">GUARDAR REGISTRO</button>
        <button onclick="cerrarModalDir()" style="width:100%; margin-top:8px; padding:10px; background:#eee; border:none; border-radius:6px; cursor:pointer;">CANCELAR</button>
    </div>
</div>

<div id="modalUsers" class="modal-overlay hidden">
    <div class="modal-content" style="width:450px;">
        <h3 style="margin-top:0;">Gestión de Usuarios</h3>
        <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #eee;">
            <input id="uNombre" placeholder="Nuevo Usuario" style="width:100%; padding:8px; margin-bottom:8px; box-sizing:border-box;">
            <input id="uPass" placeholder="Contraseña" style="width:100%; padding:8px; margin-bottom:8px; box-sizing:border-box;">
            <select id="uRol" style="width:100%; padding:8px; margin-bottom:10px;">
                <option value="agente">Agente (Solo Consulta)</option>
                <option value="lider">Líder (Edita Cobertura)</option>
                <option value="admin">Administrador (Control Total)</option>
            </select>
            <button onclick="guardarUsuario()" style="width:100%; padding:10px; background:var(--primary); color:white; border:none; border-radius:5px; cursor:pointer;">AGREGAR / ACTUALIZAR</button>
        </div>
        <div style="max-height: 200px; overflow-y: auto;">
            <table style="width:100%; font-size:12px; text-align:left;">
                <thead><tr style="border-bottom:2px solid #ddd;"><th>Usuario</th><th>Rol</th><th>Eliminar</th></tr></thead>
                <tbody id="listaUsuarios"></tbody>
            </table>
        </div>
        <button onclick="cerrarModalUsers()" style="width:100%; margin-top:15px; padding:10px; background:#eee; border:none; cursor:pointer;">CERRAR</button>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbwxArEj1IaeXjR7b9raMrXtDnDjIq0HH6eGmT_wxoR1QEhJ5cN--pARkOIFJe39aqY16g/exec";
    let MASTER = [], USUARIOS = [], ROL = "", pag = 1;

    // ALGORITMO LEVENSHTEIN PARA ERRORES DE DEDO
    function similitud(s1, s2) {
        let m = s1.length, n = s2.length;
        let d = Array.from(Array(m + 1), () => Array(n + 1).fill(0));
        for (let i = 0; i <= m; i++) d[i][0] = i;
        for (let j = 0; j <= n; j++) d[0][j] = j;
        for (let j = 1; j <= n; j++) {
            for (let i = 1; i <= m; i++) {
                let cost = (s1[i - 1].toLowerCase() === s2[j - 1].toLowerCase()) ? 0 : 1;
                d[i][j] = Math.min(d[i - 1][j] + 1, d[i][j - 1] + 1, d[i - 1][j - 1] + cost);
            }
        }
        return (Math.max(m, n) - d[m][n]) / Math.max(m, n);
    }

    async function cargarDatos(silencioso = false) {
        try {
            const res = await fetch(API);
            const data = await res.json();
            USUARIOS = data.usuarios.slice(1).map(r => ({ u: String(r[0]).trim().toLowerCase(), p: String(r[1]).trim(), r: String(r[2]).trim().toLowerCase() }));
            MASTER = data.cobertura.slice(1).map((r, i) => ({ 
                fila: i + 2, m: String(r[0]), n: String(r[1]), cat: String(r[2]), z: String(r[3]), ref: String(r[4] || ""), cob: String(r[5] || "Sin Datos") 
            }));
            document.getElementById("lastSync").innerText = "Sincronizado: " + new Date().toLocaleTimeString();
            document.getElementById("btnLogin").disabled = false;
            if (!silencioso) render();
        } catch (e) { console.error("Error Sync", e); }
    }

    // SINCRONIZACIÓN CADA 5 SEGUNDOS (Tiempo Real)
    setInterval(() => { if(ROL !== "") cargarDatos(true); }, 5000);

    function login() {
        const u = document.getElementById("userInput").value.trim().toLowerCase() || JSON.parse(localStorage.getItem("distelsa_session"))?.u;
        const p = document.getElementById("passInput").value.trim() || JSON.parse(localStorage.getItem("distelsa_session"))?.p;
        const user = USUARIOS.find(x => x.u === u && x.p === p);
        if(user) {
            ROL = user.r;
            localStorage.setItem("distelsa_session", JSON.stringify({ u, p }));
            document.getElementById("loginPanel").classList.add("hidden");
            document.getElementById("appPanel").classList.remove("hidden");
            document.getElementById("logoutBtn").classList.remove("hidden");
            if(ROL === 'admin' || ROL === 'lider') document.getElementById("btnNuevaDir").classList.remove("hidden");
            if(ROL === 'admin') document.getElementById("btnAdminUsers").classList.remove("hidden");
            render();
        } else { showToast("Usuario o Contraseña incorrectos"); }
    }

    function render() {
        let rawQuery = document.getElementById("buscar").value.toLowerCase().trim();
        
        // DICCIONARIO DE ABREVIATURAS
        const abrev = [
            { r: /\bz\s?(\d+)\b/g, v: 'zona $1' }, { r: /\bzn\s?(\d+)\b/g, v: 'zona $1' },
            { r: /\bcol\b/g, v: 'colonia' }, { r: /\bal\b/g, v: 'aldea' }, { r: /\bgt\b/g, v: 'guatemala' },
            { r: /\bmix\b/g, v: 'mixco' }, { r: /\bxela\b/g, v: 'quetzaltenango' }, { r: /\bkm\b/g, v: 'kilometro' },
            { r: /\bcarr\b/g, v: 'carretera' }, { r: /\bva\b/g, v: 'villanueva' }, { r: /\bvn\b/g, v: 'villanueva' }
        ];
        abrev.forEach(a => { rawQuery = rawQuery.replace(a.r, a.v); });
        const terminos = rawQuery.split(/\s+/).filter(t => t.length > 0);
        
        let filtrados = MASTER;
        if (terminos.length > 0) {
            filtrados = MASTER.map(r => {
                let score = 0;
                const n = r.n.toLowerCase(), z = String(r.z).toLowerCase(), m = r.m.toLowerCase();
                terminos.forEach(t => {
                    if (n.includes(t)) score += 15; // P1: Nombre
                    if (z === t || (t.includes('zona') && z === t.replace('zona','').trim())) score += 8; // P2: Zona
                    if (m.includes(t)) score += 4; // P3: Municipio
                    let mejorSim = Math.max(...n.split(/\s+/).map(p => similitud(p, t)));
                    if (mejorSim > 0.8) score += (mejorSim * 10);
                });
                return { ...r, score };
            }).filter(r => r.score > 3).sort((a, b) => b.score - a.score);
        }

        const totalPags = Math.ceil(filtrados.length / 10) || 1;
        if(pag > totalPags) pag = 1;

        const segment = filtrados.slice((pag - 1) * 10, pag * 10);
        let html = "";
        segment.forEach((r, idx) => {
            const colorClass = (v) => v=="Cobertura"?"bg-verde":v=="Sin Cobertura"?"bg-rojo":v=="Consultar"?"bg-amarillo":"bg-gris";
            let destello = (rawQuery.length > 2 && idx === 0 && pag === 1) ? "mejor-coincidencia" : "";
            
            let stHTML = (ROL === 'admin' || ROL === 'lider') ? 
                `<select class="badge ${colorClass(r.cob)}" onchange="guardarEstado(${r.fila}, this)">
                    <option value="Sin Datos" ${r.cob=='Sin Datos'?'selected':''}>Sin Datos</option>
                    <option value="Cobertura" ${r.cob=='Cobertura'?'selected':''}>Cobertura</option>
                    <option value="Sin Cobertura" ${r.cob=='Sin Cobertura'?'selected':''}>Sin Cobertura</option>
                    <option value="Consultar" ${r.cob=='Consultar'?'selected':''}>Consultar</option>
                </select>` : `<span class="badge ${colorClass(r.cob)}">${r.cob}</span>`;

            html += `<tr class="${destello}">
                <td>${r.m}</td><td style="font-weight:bold; color:var(--primary); font-size:14px;">${r.n}</td>
                <td style="font-size:11px;">${r.cat}</td><td style="text-align:center; font-weight:bold; font-size:16px;">${r.z}</td>
                <td style="font-size:11px; color:#555;">${r.ref}</td><td>${stHTML}</td>
            </tr>`;
        });
        document.getElementById("cuerpo").innerHTML = html || "<tr><td colspan='6' style='text-align:center; padding:30px;'>No se encontraron resultados</td></tr>";
        document.getElementById("pagTxt").innerText = `Página ${pag} de ${totalPags}`;
    }

    // GESTIÓN DE ESTADOS (TIEMPO REAL)
    async function guardarEstado(fila, el) {
        const val = el.value;
        el.className = `badge ${val=="Cobertura"?"bg-verde":val=="Sin Cobertura"?"bg-rojo":val=="Consultar"?"bg-amarillo":"bg-gris"}`;
        showToast("Sincronizando...");
        const item = MASTER.find(x => x.fila === fila);
        if(item) item.cob = val;
        await fetch(`${API}?action=updateCob&fila=${fila}&valor=${encodeURIComponent(val)}`, { method: 'POST', mode: 'no-cors' });
        showToast("✓ Guardado");
    }

    // GESTIÓN DE USUARIOS (ADMIN)
    function abrirModalUsers() {
        document.getElementById("modalUsers").classList.remove("hidden");
        let html = "";
        USUARIOS.forEach(u => {
            html += `<tr><td>${u.u}</td><td>${u.r}</td>
            <td><button onclick="eliminarUsuario('${u.u}')" style="color:red; border:none; background:none; cursor:pointer;"><i class="fa-solid fa-trash"></i></button></td></tr>`;
        });
        document.getElementById("listaUsuarios").innerHTML = html;
    }

    async function guardarUsuario() {
        const u = document.getElementById("uNombre").value.trim().toLowerCase();
        const p = document.getElementById("uPass").value.trim();
        const r = document.getElementById("uRol").value;
        if(!u || !p) return showToast("Complete los datos");
        showToast("Guardando usuario...");
        await fetch(`${API}?action=manageUser&user=${u}&pass=${p}&rol=${r}`, { method: 'POST', mode: 'no-cors' });
        cerrarModalUsers();
        cargarDatos();
    }

    async function eliminarUsuario(u) {
        if(!confirm(`¿Eliminar al usuario ${u}?`)) return;
        showToast("Eliminando...");
        await fetch(`${API}?action=deleteUser&user=${u}`, { method: 'POST', mode: 'no-cors' });
        abrirModalUsers();
        cargarDatos();
    }

    // FUNCIONES GENERALES
    async function guardarNuevaDireccion() {
        const p = `?action=addAddress&muni=${encodeURIComponent(document.getElementById("addMuni").value)}&nom=${encodeURIComponent(document.getElementById("addNom").value)}&cat=${encodeURIComponent(document.getElementById("addCat").value)}&zona=${encodeURIComponent(document.getElementById("addZona").value)}&ref=${encodeURIComponent(document.getElementById("addRef").value)}&est=${encodeURIComponent(document.getElementById("addEst").value)}`;
        showToast("Enviando a Excel...");
        await fetch(API + p, { method: 'POST', mode: 'no-cors' });
        cerrarModalDir();
        cargarDatos();
    }

    function showToast(m) { const t = document.getElementById("toast"); t.innerText = m; t.style.display = "block"; setTimeout(()=>t.style.display="none", 2500); }
    function limpiarBuscador() { document.getElementById("buscar").value = ""; render(); }
    function cambiarPag(v) { pag += v; if(pag < 1) pag = 1; render(); }
    function cerrarModalDir() { document.getElementById("modalDir").classList.add("hidden"); }
    function cerrarModalUsers() {