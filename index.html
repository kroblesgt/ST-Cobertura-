<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA DE COBERTURA | DISTELSA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { 
            --primary: #0054a6; --success: #00b050; --danger: #c00000; 
            --warning: #f1c40f; --dark: #2c3e50; --light-grey: #f4f4f4;
            --edit-highlight: #fff9c4;
        }
        body { font-family: 'Segoe UI', sans-serif; background:#f0f2f5; margin:0; }
        .header { background: white; padding: 10px 40px; border-bottom: 5px solid var(--primary); display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header img { height: 80px; }
        .container { max-width: 1300px; margin: 20px auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .hidden { display: none !important; }
        .btn { padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; color: white; display: inline-flex; align-items: center; gap: 8px; }
        .btn-save { background: var(--primary); color: white; padding: 8px; border-radius: 6px; border: none; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: var(--primary); color: white; padding: 12px; text-align: left; font-size: 14px; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        input[type="text"] { padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 90%; }
        .badge { padding: 6px 12px; border-radius: 20px; color: white; font-weight: bold; font-size: 11px; text-transform: uppercase; border: none; cursor: pointer; }
        .bg-verde { background: var(--success); } .bg-rojo { background: var(--danger); } 
        .bg-amarillo { background: var(--warning); color: black; } .bg-gris { background: #95a5a6; }
        .modified { background-color: var(--edit-highlight) !important; }
        #toast { position: fixed; bottom: 20px; right: 20px; background: var(--dark); color: white; padding: 15px 25px; border-radius: 8px; display: none; z-index: 3000; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 800px; max-width: 95%; }
        .row-focus { background-color: #e3f2fd !important; border-left: 5px solid var(--primary); }
    </style>
</head>
<body>

<div id="toast"></div>

<header class="header">
    <img src="https://drive.google.com/thumbnail?id=1bawJf9oARBLy2itsOfA9YE8RVAFNdNef" alt="Logo">
    <div style="text-align:center;">
        <h2 style="margin:0; color:var(--primary);">SISTEMA DE COBERTURA</h2>
        <small id="syncStatus" style="color:var(--success); font-weight:bold;">‚óè CONECTADO</small>
    </div>
    <button onclick="logout()" id="logoutBtn" class="btn hidden" style="background:var(--dark)"><i class="fa-solid fa-power-off"></i> SALIR</button>
</header>

<div class="container">
    <div id="loginPanel" style="max-width: 400px; margin: 60px auto; text-align: center;">
        <h3>Acceso al Sistema</h3>
        <input id="userInput" type="text" placeholder="Usuario" style="width:100%; margin-bottom:15px; padding:12px;">
        <input id="passInput" type="password" placeholder="Contrase√±a" style="width:100%; margin-bottom:20px; padding:12px; border:1px solid #ddd; border-radius:5px;">
        <button id="btnLogin" onclick="login()" disabled class="btn" style="background:var(--primary); width:100%; justify-content:center;">CARGANDO...</button>
    </div>

    <div id="appPanel" class="hidden">
        <div id="panelNuevo" class="hidden" style="background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:20px; display:grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap:10px; align-items:end; border: 1px solid #e0e0e0;">
            <div><label style="font-size:11px; font-weight:bold;">MUNICIPIO</label><input id="newMuni" type="text" placeholder="Ej. Mixco"></div>
            <div><label style="font-size:11px; font-weight:bold;">NOMBRE / REFERENCIA</label><input id="newNom" type="text" placeholder="Ej. El Milagro"></div>
            <div><label style="font-size:11px; font-weight:bold;">ZONA</label><input id="newZona" type="text" placeholder="Ej. Zona 6"></div>
            <div><label style="font-size:11px; font-weight:bold;">ESTADO</label>
                <select id="newEst" style="width:100%; padding:8px;">
                    <option value="Sin Datos">Sin Datos</option>
                    <option value="Cobertura">Cobertura</option>
                    <option value="Sin Cobertura">Sin Cobertura</option>
                    <option value="Consultar">Consultar</option>
                </select>
            </div>
            <button onclick="crearCobertura()" class="btn" style="background:var(--success); height:38px;"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div style="display:flex; gap:15px; margin-bottom:20px;">
            <input id="buscar" style="flex-grow:1; padding:12px; font-size:16px;" placeholder="üîç Buscar ubicaci√≥n..." oninput="pag=1; render()">
            <button id="btnAdmin" onclick="abrirModal()" class="btn hidden" style="background:var(--warning); color:black;">USUARIOS</button>
        </div>

        <table>
            <thead><tr><th>Municipio</th><th>Nombre / Referencia</th><th>Zona</th><th style="width:250px;">Estado / Acciones</th></tr></thead>
            <tbody id="cuerpo"></tbody>
        </table>

        <div style="display:flex; justify-content:center; gap:20px; margin-top:20px;">
            <button id="btnAnt" class="btn" style="background:var(--primary);" onclick="cambiarPag(-1)">ANTERIOR</button>
            <span id="pagTxt" style="font-weight:bold; padding-top:10px;">P√°gina 1</span>
            <button id="btnSig" class="btn" style="background:var(--primary);" onclick="cambiarPag(1)">SIGUIENTE</button>
        </div>
    </div>
</div>

<div id="modalUser" class="modal hidden">
    <div class="modal-content">
        <h3>Gesti√≥n de Usuarios</h3>
        <div id="listaU" style="max-height:400px; overflow-y:auto;"></div>
        <button onclick="cerrarModal()" class="btn" style="background:var(--dark); width:100%; margin-top:15px; justify-content:center;">CERRAR</button>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbyZa7PXf9pE5G6QOSGbE1dHonjri7itazlPsHj2l3ezU-P6hYs-WdsLNOsS-9lf4CGXOQ/exec"; 
    let MASTER = [], USUARIOS = [], ROL = "", pag = 1;

    async function cargarDatos(silencioso = false) {
        try {
            const res = await fetch(API);
            const data = await res.json();
            USUARIOS = data.usuarios.slice(1).map((r, i) => ({ fila: i + 2, u: String(r[0]), p: String(r[1]), r: String(r[2]) }));
            MASTER = data.cobertura.slice(1).map((r, i) => ({ fila: i + 2, m: r[0], n: r[1], z: r[3], cob: r[5] || "Sin Datos" }));
            document.getElementById("btnLogin").innerText = "INGRESAR";
            document.getElementById("btnLogin").disabled = false;
            if(!silencioso) checkSession();
            render();
        } catch (e) { document.getElementById("syncStatus").innerText = "‚óè ERROR DE CONEXI√ìN"; }
    }

    function checkSession() {
        const session = localStorage.getItem("distelsa_auth");
        if(session) {
            const user = JSON.parse(session);
            const valid = USUARIOS.find(x => x.u === user.u && x.p === user.p);
            if(valid) authOk(valid.r);
        }
    }

    function login() {
        const u = document.getElementById("userInput").value.trim();
        const p = document.getElementById("passInput").value.trim();
        const user = USUARIOS.find(x => x.u === u && x.p === p);
        if(user) {
            localStorage.setItem("distelsa_auth", JSON.stringify({u, p}));
            authOk(user.r);
        } else alert("Datos incorrectos");
    }

    function authOk(rol) {
        ROL = rol.toLowerCase();
        document.getElementById("loginPanel").classList.add("hidden");
        document.getElementById("appPanel").classList.remove("hidden");
        document.getElementById("logoutBtn").classList.remove("hidden");
        if(ROL === 'admin' || ROL === 'lider') document.getElementById("panelNuevo").classList.remove("hidden");
        if(ROL === 'admin') document.getElementById("btnAdmin").classList.remove("hidden");
        render();
    }

    function logout() { localStorage.removeItem("distelsa_auth"); location.reload(); }

    function render() {
        const q = document.getElementById("buscar").value.toLowerCase();
        let filtrados = MASTER.filter(r => `${r.m} ${r.n} ${r.z}`.toLowerCase().includes(q));
        
        const totalPags = Math.ceil(filtrados.length / 10) || 1;
        const segment = filtrados.slice((pag-1)*10, pag*10);
        let html = "";

        segment.forEach(r => {
            const col = r.cob=="Cobertura"?"bg-verde":r.cob=="Sin Cobertura"?"bg-rojo":r.cob=="Consultar"?"bg-amarillo":"bg-gris";
            const canEdit = (ROL === 'admin' || ROL === 'lider');

            html += `<tr id="row-${r.fila}">
                <td>${canEdit ? `<input id="m-${r.fila}" value="${r.m}" oninput="marcar(${r.fila})">` : r.m}</td>
                <td>${canEdit ? `<input id="n-${r.fila}" style="font-weight:bold" value="${r.n}" oninput="marcar(${r.fila})">` : r.n}</td>
                <td>${canEdit ? `<input id="z-${r.fila}" value="${r.z}" oninput="marcar(${r.fila})">` : r.z}</td>
                <td>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <select id="s-${r.fila}" class="badge ${col}" onchange="marcar(${r.fila}); if(!${canEdit}) guardarTodo(${r.fila})">
                            <option value="Sin Datos" ${r.cob=='Sin Datos'?'selected':''}>Sin Datos</option>
                            <option value="Cobertura" ${r.cob=='Cobertura'?'selected':''}>Cobertura</option>
                            <option value="Sin Cobertura" ${r.cob=='Sin Cobertura'?'selected':''}>Sin Cobertura</option>
                            <option value="Consultar" ${r.cob=='Consultar'?'selected':''}>Consultar</option>
                        </select>
                        ${canEdit ? `
                            <button onclick="guardarTodo(${r.fila})" class="btn-save"><i class="fa-solid fa-floppy-disk"></i></button>
                            <button onclick="eliminarCob(${r.fila}, '${r.n}')" class="btn-save" style="background:var(--danger)"><i class="fa-solid fa-trash"></i></button>
                        ` : ''}
                    </div>
                </td>
            </tr>`;
        });

        document.getElementById("cuerpo").innerHTML = html;
        document.getElementById("pagTxt").innerText = `P√°gina ${pag} de ${totalPags}`;
        document.getElementById("btnAnt").disabled = pag === 1;
        document.getElementById("btnSig").disabled = pag >= totalPags;
    }

    function marcar(f) { document.getElementById(`row-${f}`).classList.add('modified'); }

    async function guardarTodo(fila) {
        const m = document.getElementById(`m-${fila}`)?.value || MASTER.find(x=>x.fila===fila).m;
        const n = document.getElementById(`n-${fila}`)?.value || MASTER.find(x=>x.fila===fila).n;
        const z = document.getElementById(`z-${fila}`)?.value || MASTER.find(x=>x.fila===fila).z;
        const val = document.getElementById(`s-${fila}`).value;

        showToast("Guardando...");
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'updateFullCob', fila, m, n, z, val }) });
        const item = MASTER.find(x => x.fila === fila);
        Object.assign(item, { m, n, z, cob: val });
        document.getElementById(`row-${fila}`).classList.remove('modified');
        showToast("Sincronizado");
        render();
    }

    async function crearCobertura() {
        const m = document.getElementById("newMuni").value, n = document.getElementById("newNom").value, z = document.getElementById("newZona").value, val = document.getElementById("newEst").value;
        if(!m || !n) return alert("Faltan datos");
        showToast("Agregando...");
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'addCob', m, n, z, val }) });
        location.reload();
    }

    async function eliminarCob(fila, nombre) {
        if(!confirm(`¬øEliminar ${nombre}?`)) return;
        showToast("Eliminando...");
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'deleteCob', fila }) });
        MASTER = MASTER.filter(x => x.fila !== fila);
        render();
        showToast("Eliminado");
    }

    function showToast(m) {
        const t = document.getElementById("toast"); t.innerText = m; t.style.display = "block";
        setTimeout(() => t.style.display = "none", 3000);
    }

    function cambiarPag(v) { pag += v; render(); }
    function abrirModal() { document.getElementById("modalUser").classList.remove("hidden"); }
    function cerrarModal() { document.getElementById("modalUser").classList.add("hidden"); }

    window.onload = cargarDatos;
</script>
</body>
</html>
