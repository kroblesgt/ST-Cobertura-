<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA DE COBERTURA | DISTELSA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { 
            --primary: #0054a6; 
            --success: #00b050; 
            --danger: #c00000; 
            --warning: #f1c40f; 
            --dark: #2c3e50; 
            --light-grey: #dcdcdc; 
        }
        body { font-family: 'Segoe UI', sans-serif; background:#f0f2f5; margin:0; }
        
        /* Header Mejorado */
        .header { background: white; padding: 10px 40px; border-bottom: 5px solid var(--primary); display: flex; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); position: relative; }
        .header img { height: 100px; width: auto; }
        .header-title { flex-grow: 1; text-align: center; }
        .header-title h1 { margin: 0; color: var(--primary); font-size: 26px; font-weight: 800; }
        .header-title small { color: var(--primary); font-weight: bold; letter-spacing: 1px; }

        .container { max-width: 1250px; margin: 30px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); position: relative; }
        .hidden { display: none !important; }

        /* Bot칩n Cerrar Sesi칩n (Esquina Superior Derecha del Header) */
        .btn-exit-top { 
            background: var(--dark); color: white; border: none; 
            padding: 10px 15px; border-radius: 8px; cursor: pointer; 
            font-size: 14px; display: flex; align-items: center; gap: 8px; 
            transition: all 0.3s;
        }
        .btn-exit-top:hover { background: var(--danger); }

        /* Buscador y Escoba */
        .toolbar { display: flex; gap: 15px; margin-bottom: 25px; align-items: center; }
        .search-container { position: relative; flex-grow: 1; }
        .search-box { width: 100%; padding: 14px 45px 14px 14px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; box-sizing: border-box; outline: none; }
        .clear-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--primary); font-size: 20px; display: none; }

        .btn { padding: 12px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; color: white; display: inline-flex; align-items: center; gap: 10px; }
        .btn-admin { background: var(--warning); color: #000; }
        .btn-nav { background: var(--primary); min-width: 120px; justify-content: center; }

        /* Bot칩n Cassette Mejorado */
        .btn-save { background: var(--success); padding: 8px 15px; border-radius: 6px; border: none; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .btn-save i { font-size: 22px; color: white; }
        .btn-save:hover { transform: scale(1.1); background: #008c40; }

        /* Selectores Coloreados */
        .sel-status { padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-weight: bold; color: white; cursor: pointer; width: 150px; }
        .sel-sin-datos { background-color: var(--light-grey); color: #666 !important; }
        .sel-cobertura { background-color: var(--success); }
        .sel-sin-cobertura { background-color: var(--danger); }
        .sel-consultar { background-color: var(--warning); color: black !important; }

        table { width: 100%; border-collapse: collapse; }
        th { background: var(--primary); color: white; padding: 15px; text-align: left; font-size: 13px; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        
        .badge { padding: 6px 12px; border-radius: 20px; color: white; font-weight: bold; font-size: 11px; text-transform: uppercase; }
        .bg-verde { background: var(--success); }
        .bg-rojo { background: var(--danger); }
        .bg-amarillo { background: var(--warning); color: black; }
        .bg-gris { background: var(--light-grey); color: #666; }

        .pagination { display: flex; justify-content: center; gap: 20px; margin-top: 30px; align-items: center; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<header class="header">
    <img src="https://drive.google.com/thumbnail?id=1bawJf9oARBLy2itsOfA9YE8RVAFNdNef" alt="Logo Distelsa">
    <div class="header-title">
        <h1>SISTEMA DE COBERTURA</h1>
        <small id="statText">CALL CENTER - ONLINE</small>
    </div>
    <button id="logoutBtn" onclick="logout()" class="btn-exit-top hidden">
        <i class="fa-solid fa-power-off"></i> SALIR
    </button>
</header>

<div class="container">
    <div id="loginPanel" style="max-width: 400px; margin: 60px auto; text-align: center;">
        <h2 style="color:var(--primary)">Acceso al Sistema</h2>
        <input id="userInput" type="text" placeholder="Usuario" style="width:100%; padding:14px; margin-bottom:15px; border-radius:8px; border:1px solid #ddd;">
        <input id="passInput" type="password" placeholder="Contrase침a" style="width:100%; padding:14px; margin-bottom:20px; border-radius:8px; border:1px solid #ddd;">
        <button id="btnLogin" onclick="login()" disabled class="btn" style="background:var(--primary); width:100%; justify-content:center;">CARGANDO...</button>
    </div>

    <div id="appPanel" class="hidden">
        <div class="toolbar">
            <div class="search-container">
                <input id="buscar" class="search-box" placeholder="游댌 Buscar municipio, zona o nombre..." oninput="manejarBusqueda()">
                <i id="clearBtn" class="fa-solid fa-broom clear-icon" title="Limpiar" onclick="limpiarBusqueda()"></i>
            </div>
            <button id="btnAdmin" onclick="abrirModal()" class="btn btn-admin hidden">USUARIOS</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Municipio</th>
                    <th>Nombre / Referencia</th>
                    <th>Zona</th>
                    <th>Cobertura</th>
                </tr>
            </thead>
            <tbody id="cuerpo"></tbody>
        </table>

        <div class="pagination">
            <button id="btnAnt" class="btn btn-nav" onclick="cambiarPag(-1)">ANTERIOR</button>
            <span id="pagTxt">P치gina 1</span>
            <button id="btnSig" class="btn btn-nav" onclick="cambiarPag(1)">SIGUIENTE</button>
        </div>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbx4GK4eRKjRXD5AqukR-lpjo_1jloeSjKlk7GYpihbYlo8YwRAEUwaj6TbUUDg0aODEOg/exec";
    let MASTER = [], USUARIOS = [], ROL = "", pag = 1;
    const limite = 10;

    window.onload = cargarDatos;

    async function cargarDatos() {
        try {
            const res = await fetch(API);
            const data = await res.json();
            USUARIOS = data.usuarios.slice(1).map(r => ({u: String(r[0]), p: String(r[1]), r: String(r[2])}));
            MASTER = data.cobertura.slice(1).map((r, i) => ({ 
                fila: i+2, m: r[0], n: r[1], z: r[3], cob: r[5] || "Sin Datos" 
            }));
            document.getElementById("btnLogin").innerText = "INGRESAR";
            document.getElementById("btnLogin").disabled = false;
        } catch (e) { document.getElementById("statText").innerText = "ERROR DE CONEXI칍N"; }
    }

    function manejarBusqueda() {
        const val = document.getElementById("buscar").value;
        document.getElementById("clearBtn").style.display = val.length > 0 ? "block" : "none";
        pag = 1;
        render();
    }

    function limpiarBusqueda() {
        document.getElementById("buscar").value = "";
        manejarBusqueda();
    }

    function getColorClass(val) {
        if (val === "Cobertura") return "sel-cobertura";
        if (val === "Sin Cobertura") return "sel-sin-cobertura";
        if (val === "Consultar") return "sel-consultar";
        return "sel-sin-datos";
    }

    function render() {
        const q = document.getElementById("buscar").value.toLowerCase().split(" ");
        const filtrados = MASTER.filter(r => q.every(w => `${r.m} ${r.n} ${r.z}`.toLowerCase().includes(w)));
        const segment = filtrados.slice((pag-1)*limite, pag*limite);
        
        let html = "";
        segment.forEach(r => {
            const canEdit = (ROL === 'admin' || ROL === 'lider');
            if (canEdit) {
                html += `<tr>
                    <td>${r.m}</td>
                    <td><b>${r.n}</b></td>
                    <td>${r.z}</td>
                    <td>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <select id="s-${r.fila}" class="sel-status ${getColorClass(r.cob)}" onchange="this.className='sel-status ' + getColorClass(this.value)">
                                <option value="Sin Datos" ${r.cob=='Sin Datos'?'selected':''}>Sin Datos</option>
                                <option value="Cobertura" ${r.cob=='Cobertura'?'selected':''}>Cobertura</option>
                                <option value="Sin Cobertura" ${r.cob=='Sin Cobertura'?'selected':''}>Sin Cobertura</option>
                                <option value="Consultar" ${r.cob=='Consultar'?'selected':''}>Consultar</option>
                            </select>
                            <button class="btn-save" title="Guardar" onclick="guardarEstado(${r.fila})">
                                <i class="fa-solid fa-floppy-disk"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            } else {
                let badgeCls = r.cob === "Cobertura" ? "bg-verde" : r.cob === "Sin Cobertura" ? "bg-rojo" : r.cob === "Consultar" ? "bg-amarillo" : "bg-gris";
                html += `<tr><td>${r.m}</td><td><b>${r.n}</b></td><td>${r.z}</td><td><span class="badge ${badgeCls}">${r.cob}</span></td></tr>`;
            }
        });
        document.getElementById("cuerpo").innerHTML = html;
        document.getElementById("pagTxt").innerText = `P치gina ${pag} de ${Math.ceil(filtrados.length/limite) || 1}`;
        document.getElementById("btnAnt").disabled = pag === 1;
        document.getElementById("btnSig").disabled = pag*limite >= filtrados.length;
    }

    async function guardarEstado(fila) {
        const val = document.getElementById(`s-${fila}`).value;
        const btn = event.currentTarget;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'updateCob', fila, valor: val }) });
        const item = MASTER.find(x => x.fila === fila);
        if(item) item.cob = val;
        btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i>';
        render();
    }

    function login() {
        const u = document.getElementById("userInput").value.trim().toLowerCase();
        const p = document.getElementById("passInput").value.trim();
        const user = USUARIOS.find(x => x.u.toLowerCase() === u && x.p === p);
        if(user) {
            ROL = user.r.toLowerCase();
            document.getElementById("loginPanel").classList.add("hidden");
            document.getElementById("appPanel").classList.remove("hidden");
            document.getElementById("logoutBtn").classList.remove("hidden");
            if(ROL === 'admin') document.getElementById("btnAdmin").classList.remove("hidden");
            render();
        } else { alert("Usuario o contrase침a incorrectos"); }
    }

    function cambiarPag(v) { pag += v; render(); }
    function logout() { location.reload(); }
</script>
</body>
</html>
