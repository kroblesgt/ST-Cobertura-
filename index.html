<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grupo Distelsa | Sistema de Cobertura</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  :root { --blue: #002855; --light-blue: #0056b3; --green: #217346; --red: #dc3545; --bg: #f4f6f8; --gray: #6c757d; }
  body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; color: #333; }
  .hidden { display: none !important; }

  /* HEADER */
  header { background: white; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; border-bottom: 3px solid var(--blue); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
  .logo { font-size: 20px; font-weight: 800; color: var(--blue); display: flex; align-items: center; gap: 10px; }
  .user-info { text-align: right; font-size: 13px; line-height: 1.2; }

  /* LOGIN */
  .login-wrapper { height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #e9ecef 0%, #ffffff 100%); }
  .login-box { background: white; padding: 40px; width: 320px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 5px solid var(--blue); text-align: center; }
  .inp { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
  .inp:focus { border-color: var(--light-blue); outline: none; }
  
  /* APP */
  .container { max-width: 1300px; margin: 20px auto; padding: 0 20px; }
  .card { background: white; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; }
  .tools { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
  .search-wrap { flex: 1; position: relative; }
  .search-wrap i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #adb5bd; }
  .search-inp { width: 100%; padding: 12px 12px 12px 35px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; }

  .btn { border: none; padding: 10px 15px; border-radius: 4px; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; font-size: 13px; color: white; }
  .btn-p { background: var(--blue); } 
  .btn-s { background: #28a745; } 
  .btn-x { background: var(--green); } 
  .btn-d { background: var(--red); } 
  .btn:hover { opacity: 0.9; }

  /* TABLA */
  table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed; }
  th { text-align: left; padding: 12px 15px; background: #f8f9fa; color: #495057; border-bottom: 2px solid #e9ecef; }
  td { padding: 10px 15px; border-bottom: 1px solid #f1f3f5; vertical-align: middle; }
  tr:hover td { background-color: #f8f9fa; }

  .badge { display: block; padding: 6px 0; text-align: center; border-radius: 4px; font-weight: bold; font-size: 11px; text-transform: uppercase; color: white; width: 110px; }
  
  /* ONLINE */
  .online-indicator { font-size: 11px; color: #28a745; font-weight: bold; margin-right: 15px; background: #e8f8f5; padding: 6px 12px; border-radius: 20px; border: 1px solid #d1f2eb; cursor: pointer; position: relative; }
  .online-list-popup { display: none; position: absolute; top: 120%; right: 0; background: white; border: 1px solid #ddd; width: 200px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-radius: 6px; padding: 10px; z-index: 100; color: #333; font-weight: normal; }
  .online-indicator:hover .online-list-popup { display: block; }
  .online-item { padding: 4px 0; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 6px; }

  /* MODALS */
  .modal-backdrop { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px); }
  .modal { background: white; width: 95%; max-width: 700px; padding: 25px; border-radius: 8px; box-shadow: 0 15px 50px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
  .user-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
  .user-row:hover { background: #f8f9fa; }
</style>
</head>
<body>

<div id="viewLogin" class="login-wrapper">
  <div class="login-box">
    <h3 style="color:var(--blue); margin-top:0;">GRUPO DISTELSA</h3>
    <p style="font-size:12px; color:#6c757d; margin-bottom:20px;">ACCESO AL SISTEMA</p>
    <input id="txtUser" class="inp" placeholder="Usuario">
    <input id="txtPass" type="password" class="inp" placeholder="Contraseña">
    <button id="btnLogin" onclick="login()" class="btn btn-p" style="width:100%; justify-content: center; margin-top: 15px; height: 45px;">INGRESAR</button>
  </div>
</div>

<div id="viewApp" class="hidden">
  <header>
    <div class="logo"><i class="fa-solid fa-satellite-dish"></i> GRUPO DISTELSA</div>
    <div style="display: flex; align-items: center; gap: 15px;">
      <div id="onlineMonitor" class="hidden online-indicator">
        <i class="fa-solid fa-circle" style="font-size: 8px;"></i> Online: <span id="onlineCount">0</span>
        <div id="onlineList" class="online-list-popup">Cargando...</div>
      </div>
      <div class="user-info">
        <div id="lblUser" style="font-weight: bold;">Usuario</div>
        <div id="lblRol" style="color: #6c757d; text-transform: uppercase; font-size: 11px;">Rol</div>
      </div>
      <button onclick="logout()" class="btn btn-d" title="Salir"><i class="fa-solid fa-power-off"></i></button>
    </div>
  </header>

  <div class="container">
    <div class="tools">
      <div class="search-wrap">
        <i class="fa-solid fa-search"></i>
        <input id="searchBox" class="search-inp" placeholder="Buscar..." onkeyup="renderTable(true)">
      </div>
      <button id="btnAdd" onclick="openModal('modalAdd')" class="btn btn-s hidden"><i class="fa-solid fa-plus"></i> Nuevo</button>
      <button id="btnExp" onclick="exportToExcel()" class="btn btn-x hidden"><i class="fa-solid fa-file-excel"></i> Excel</button>
      <button id="btnHis" onclick="openHistory()" class="btn btn-p hidden"><i class="fa-solid fa-clock-rotate-left"></i> Historial</button>
      <button id="btnUsr" onclick="openUsers()" class="btn btn-p hidden" style="background:#343a40"><i class="fa-solid fa-users-gear"></i> Usuarios</button>
    </div>

    <div class="card">
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th width="12%">Municipio</th>
              <th width="20%">Nombre</th>
              <th width="12%">Categoría</th>
              <th width="8%">Zona</th>
              <th width="25%">Referencia</th>
              <th width="15%">Estado</th>
              <th width="8%" class="col-action hidden">Editar</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <div style="padding: 15px; display: flex; justify-content: center; align-items: center; gap: 20px;">
        <button onclick="changePage(-1)" class="btn btn-p"><i class="fa-solid fa-chevron-left"></i></button>
        <span id="pageLabel" style="font-weight: bold; font-size: 13px;">1 / 1</span>
        <button onclick="changePage(1)" class="btn btn-p"><i class="fa-solid fa-chevron-right"></i></button>
      </div>
    </div>
  </div>
</div>

<div id="modalAdd" class="modal-backdrop hidden">
  <div class="modal">
    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
      <h3 style="margin:0; color:var(--blue)">Nueva Ubicación</h3>
      <button onclick="closeModal('modalAdd')" class="btn btn-d"><i class="fa-solid fa-times"></i></button>
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
      <input id="newMun" class="inp" placeholder="Municipio">
      <input id="newNom" class="inp" placeholder="Nombre">
      <input id="newCat" class="inp" placeholder="Categoría">
      <input id="newZon" class="inp" placeholder="Zona">
      <input id="newRef" class="inp" style="grid-column: span 2;" placeholder="Referencia">
      <select id="newCob" class="inp" style="grid-column: span 2;">
        <option value="Cobertura">Cobertura (Verde)</option>
        <option value="Sin Cobertura">Sin Cobertura (Rojo)</option>
        <option value="Consultar">Consultar (Amarillo)</option>
        <option value="">Sin Datos (Gris)</option>
      </select>
    </div>
    <div style="margin-top: 20px; text-align: right;">
      <button onclick="saveNewLocation()" class="btn btn-s" style="width: 100%;">Guardar</button>
    </div>
  </div>
</div>

<div id="modalUsr" class="modal-backdrop hidden">
  <div class="modal">
    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
      <h3 style="margin:0">Usuarios</h3>
      <button onclick="closeModal('modalUsr')" class="btn btn-d"><i class="fa-solid fa-times"></i></button>
    </div>
    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
      <input id="uUser" class="inp" placeholder="Usuario" style="margin:0">
      <input id="uPass" class="inp" placeholder="Clave" style="margin:0">
      <select id="uRol" class="inp" style="margin:0; width: 120px;">
        <option value="agente">Agente</option>
        <option value="lider">Lider</option>
        <option value="admin">Admin</option>
      </select>
      <button id="btnUserAction" onclick="submitUser()" class="btn btn-s"><i class="fa-solid fa-plus"></i></button>
      <button onclick="clearUserForm()" class="btn btn-d"><i class="fa-solid fa-eraser"></i></button>
    </div>
    <input id="searchUserBox" class="inp" placeholder="Buscar usuario..." onkeyup="renderUserList()">
    <div id="userListContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid #eee;"></div>
    <div style="text-align: center; margin-top: 10px; font-weight:bold; font-size:12px;" id="userPageLabel"></div>
  </div>
</div>

<div id="modalHis" class="modal-backdrop hidden">
  <div class="modal" style="max-width: 800px;">
    <div style="display: flex; justify-content: space-between;">
      <h3>Historial</h3>
      <button onclick="closeModal('modalHis')" class="btn btn-d"><i class="fa-solid fa-times"></i></button>
    </div>
    <div style="max-height: 400px; overflow-y: auto;">
      <table id="tableHistory"></table>
    </div>
  </div>
</div>

<script>
// ================== PEGAR URL DEL APPS SCRIPT AQUÍ ==================
const API_URL = "https://script.google.com/macros/s/AKfycbwA3pVRK7QzEj4a9cr6olwgmAeKnbB8XttRngmTg8cqgO6AWeK5dSwAD5C9J72nPVwQ5w/exec"; 
// ====================================================================

let DB = { cob: [], users: [], history: [], online: [] };
let SESION = { u: null, r: null, t: null };
let PAGE = 1; let USER_PAGE = 1; let EDITING_USER = false;

window.onload = () => {
  const saved = localStorage.getItem('distelsa_pro_v6');
  if(saved) { SESION = JSON.parse(saved); startApp(); }
};

async function login() {
  const u = document.getElementById('txtUser').value.trim();
  const p = document.getElementById('txtPass').value.trim();
  const btn = document.getElementById('btnLogin');
  if(!u || !p) return alert("Ingrese datos");
  btn.innerText = 'Cargando...'; btn.disabled = true;
  try {
    const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'login', u, p }) });
    const d = await res.json();
    if(d.status === 'ok') {
      SESION = { u: u, r: d.rol, t: d.token };
      localStorage.setItem('distelsa_pro_v6', JSON.stringify(SESION));
      startApp();
    } else alert(d.msg || "Error login");
  } catch(e) { alert("Error conexión"); }
  btn.innerText = 'INGRESAR'; btn.disabled = false;
}

function startApp() {
  document.getElementById('viewLogin').classList.add('hidden');
  document.getElementById('viewApp').classList.remove('hidden');
  document.getElementById('lblUser').innerText = SESION.u;
  document.getElementById('lblRol').innerText = SESION.r;

  const isLiderOrAdmin = (SESION.r === 'admin' || SESION.r === 'lider');
  const isAdmin = (SESION.r === 'admin');

  if(isLiderOrAdmin) {
    document.getElementById('btnAdd').classList.remove('hidden');
    document.getElementById('btnExp').classList.remove('hidden');
    document.querySelectorAll('.col-action').forEach(e => e.classList.remove('hidden'));
  }
  if(isAdmin) {
    document.getElementById('btnHis').classList.remove('hidden');
    document.getElementById('btnUsr').classList.remove('hidden');
    document.getElementById('onlineMonitor').classList.remove('hidden');
  }
  loadData();
  setInterval(heartbeat, 20000);
}

async function loadData() {
  try {
    const res = await fetch(API_URL);
    const json = await res.json();
    if(json.status === 'success') {
      DB.cob = json.data.map((r, i) => ({ i, m:r[0], n:r[1], c:r[2], z:r[3], r:r[4], s:r[5] }));
      DB.users = json.users; DB.history = json.history; DB.online = json.online;
      renderTable(); updateOnline();
      if(!document.getElementById('modalUsr').classList.contains('hidden')) renderUserList();
    }
  } catch(e) { console.error(e); }
}

async function heartbeat() {
  try {
    const res = await fetch(API_URL, { method:'POST', body:JSON.stringify({action:'heartbeat', u:SESION.u, t:SESION.t}) });
    const d = await res.json();
    if(d.status === 'force_logout') { logout(); alert("Sesión duplicada"); }
    else loadData();
  } catch(e) {}
}

function renderTable(reset = false) {
  if(reset) PAGE = 1;
  const q = document.getElementById('searchBox').value.toLowerCase();
  const filtered = DB.cob.filter(item => (String(item.m)+" "+String(item.n)+" "+String(item.z)+" "+String(item.r)).toLowerCase().includes(q));
  
  const totalPages = Math.ceil(filtered.length / 10) || 1;
  if(PAGE > totalPages) PAGE = totalPages;
  document.getElementById('pageLabel').innerText = `${PAGE} / ${totalPages}`;
  
  const start = (PAGE - 1) * 10;
  const chunk = filtered.slice(start, start + 10);
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';
  const canEdit = (SESION.r === 'admin' || SESION.r === 'lider');

  chunk.forEach(row => {
    // === LÓGICA DE COLORES CORREGIDA ===
    let bg = '#6c757d'; // Gris por defecto (si está vacío)
    let colorTexto = 'white';
    
    if(row.s === 'Cobertura') bg = '#28a745';
    else if(row.s === 'Sin Cobertura') bg = '#dc3545';
    else if(row.s === 'Consultar') { bg = '#ffc107'; colorTexto = 'black'; }
    // Si row.s es "" (vacío), se queda con bg gris

    let statusHtml = `<span class="badge" style="background:${bg}; color:${colorTexto}">${row.s || "Sin Datos"}</span>`;
    
    if(canEdit) {
      statusHtml = `
      <select id="st_${row.i}" onchange="updateRowColor(this)" style="background:${bg}; color:${colorTexto}; border:none; padding:5px; border-radius:4px; font-weight:bold; cursor:pointer;">
        <option value="Cobertura" style="background:#28a745; color:white" ${row.s==='Cobertura'?'selected':''}>Cobertura</option>
        <option value="Sin Cobertura" style="background:#dc3545; color:white" ${row.s==='Sin Cobertura'?'selected':''}>Sin Cobertura</option>
        <option value="Consultar" style="background:#ffc107; color:black" ${row.s==='Consultar'?'selected':''}>Consultar</option>
        <option value="" style="background:#6c757d; color:white" ${!row.s?'selected':''}>Sin Datos</option>
      </select>`;
    }

    tbody.innerHTML += `
      <tr>
        <td>${row.m}</td><td><b>${row.n}</b></td><td>${row.c}</td><td>${row.z}</td><td>${row.r}</td>
        <td>${statusHtml}</td>
        <td class="col-action ${canEdit?'':'hidden'}">
          <button onclick="saveEdit(${row.i})" class="btn btn-p" style="padding:5px"><i class="fa-solid fa-save"></i></button>
        </td>
      </tr>`;
  });
}

function updateRowColor(select) {
  const val = select.value;
  if(val==='Cobertura') { select.style.background='#28a745'; select.style.color='white'; }
  else if(val==='Sin Cobertura') { select.style.background='#dc3545'; select.style.color='white'; }
  else if(val==='Consultar') { select.style.background='#ffc107'; select.style.color='black'; }
  else { select.style.background='#6c757d'; select.style.color='white'; } // Gris para vacío
}

async function saveNewLocation() {
  const m = document.getElementById('newMun').value;
  const n = document.getElementById('newNom').value;
  if(!m || !n) return alert("Faltan datos");
  
  const d = { 
    action: 'saveCob', type: 'new', userLog: SESION.u,
    m, n, 
    c: document.getElementById('newCat').value, 
    z: document.getElementById('newZon').value, 
    r: document.getElementById('newRef').value, 
    cob: document.getElementById('newCob').value 
  };
  
  await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(d) });
  alert("Guardado"); closeModal('modalAdd'); loadData();
}

async function saveEdit(idx) {
  const item = DB.cob.find(x => x.i === idx);
  const newStatus = document.getElementById(`st_${idx}`).value;
  await fetch(API_URL, {
    method: 'POST', mode: 'no-cors',
    body: JSON.stringify({ 
      action: 'saveCob', type: 'edit', idx: idx, userLog: SESION.u,
      m: item.m, n: item.n, c: item.c, z: item.z, r: item.r, cob: newStatus 
    })
  });
  alert("Actualizado"); loadData();
}

function exportToExcel() {
  if(!DB.cob.length) return alert("Sin datos");
  const ws = XLSX.utils.json_to_sheet(DB.cob.map(r => ({ "Municipio":r.m, "Nombre":r.n, "Categoria":r.c, "Zona":r.z, "Referencia":r.r, "Estado":r.s || "Sin Datos" })));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Datos");
  XLSX.writeFile(wb, "Cobertura_Distelsa.xlsx");
}

function renderUserList() {
  const q = document.getElementById('searchUserBox').value.toLowerCase();
  const c = document.getElementById('userListContainer');
  const f = DB.users.filter(u => u.u.toLowerCase().includes(q));
  const tot = Math.ceil(f.length/10)||1; if(USER_PAGE>tot) USER_PAGE=tot;
  const chunk = f.slice((USER_PAGE-1)*10, USER_PAGE*10);
  
  c.innerHTML = chunk.map(u => `
    <div class="user-row">
      <div><b>${u.u}</b> ${DB.online.includes(u.u)?'<span class="badge" style="display:inline;padding:2px 5px;background:#d1e7dd;color:#0f5132">ON</span>':''} <br><small>${u.r}</small></div>
      <div>
        <button onclick="editUser('${u.u}','${u.p}','${u.r}')" class="btn btn-p" style="padding:4px"><i class="fa-solid fa-pencil"></i></button>
        <button onclick="sendUserReq('del','${u.u}')" class="btn btn-d" style="padding:4px"><i class="fa-solid fa-trash"></i></button>
      </div>
    </div>`).join('') || '<p align="center">Sin resultados</p>';
    
  document.getElementById('userPageLabel').innerHTML = `<button onclick="if(USER_PAGE>1){USER_PAGE--;renderUserList()}" class="btn btn-p"><</button> ${USER_PAGE}/${tot} <button onclick="if(USER_PAGE<${tot}){USER_PAGE++;renderUserList()}" class="btn btn-p">></button>`;
}

async function sendUserReq(type, u, p, r) {
  if(type==='del' && !confirm("¿Eliminar?")) return;
  const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'manageUser', type, u, p, r, userLog: SESION.u }) });
  const d = await res.json();
  if(d.status==='ok') { clearUserForm(); await loadData(); renderUserList(); alert("Listo"); } else alert(d.msg);
}

function submitUser() {
  const u=document.getElementById('uUser').value, p=document.getElementById('uPass').value, r=document.getElementById('uRol').value;
  if(u&&p) sendUserReq(EDITING_USER?'edit':'add', u, p, r); else alert("Datos incompletos");
}

function editUser(u,p,r) { EDITING_USER=true; document.getElementById('uUser').value=u; document.getElementById('uUser').disabled=true; document.getElementById('uPass').value=p; document.getElementById('uRol').value=r; document.getElementById('btnUserAction').innerHTML='<i class="fa-solid fa-save"></i>'; }
function clearUserForm() { EDITING_USER=false; document.getElementById('uUser').value=''; document.getElementById('uUser').disabled=false; document.getElementById('uPass').value=''; document.getElementById('uRol').value='agente'; document.getElementById('btnUserAction').innerHTML='<i class="fa-solid fa-plus"></i>'; }

function changePage(d) { PAGE += d; renderTable(); }
function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
function openUsers() { openModal('modalUsr'); renderUserList(); }
function openHistory() { openModal('modalHis'); document.getElementById('tableHistory').innerHTML = `<thead><tr style="background:#eee"><th>Fecha</th><th>Usuario</th><th>Acción</th><th>Detalle</th></tr></thead><tbody>${DB.history.map(h => `<tr><td>${new Date(h[0]).toLocaleString()}</td><td>${h[1]}</td><td>${h[2]}</td><td>${h[3]}</td></tr>`).join('')}</tbody>`; }
function updateOnline() { document.getElementById('onlineCount').innerText = DB.online.length; document.getElementById('onlineList').innerHTML = DB.online.length ? DB.online.map(u => `<div class="online-item"><i class="fa-solid fa-user"></i> ${u}</div>`).join('') : 'Nadie'; }
function logout() { localStorage.removeItem('distelsa_pro_v6'); location.reload(); }
</script>
</body>
</html>
