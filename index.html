<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA COBERTURA DISTELSA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --primary: #0054a6; --success: #00b050; --danger: #c00000; --warning: #f1c40f; --dark: #2c3e50; --highlight: #00e5ff; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; }
        
        .header { 
            background: white; 
            padding: 15px 40px; 
            border-bottom: 4px solid var(--primary); 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .header img { height: 70px; width: auto; }
        .header-title { text-align: center; }
        .header-title h1 { margin: 0; color: var(--primary); font-size: 28px; }
        .sync-status { color: var(--success); font-weight: bold; font-size: 13px; }

        .container { max-width: 1500px; margin: 30px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.08); }
        .hidden { display: none !important; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th { background: var(--primary); color: white; padding: 15px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; transition: background 0.3s; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
        table input { width: 90%; }
        
        .badge { padding: 8px 12px; border-radius: 30px; color: white; font-weight: bold; border: none; cursor: pointer; text-align: center; width: 100%; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .badge:disabled { cursor: default; opacity: 1; -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        .bg-verde { background: var(--success); } .bg-rojo { background: var(--danger); } 
        .bg-amarillo { background: var(--warning); color: black; } .bg-gris { background: #95a5a6; }
        .modified { background-color: #fff9c4 !important; border: 1px solid #f1c40f !important;}
        
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; }
        .btn:hover:not(:disabled) { opacity: 0.9; transform: translateY(-1px); }
        
        #toast { position: fixed; bottom: 30px; right: 30px; background: var(--dark); color: white; padding: 15px 30px; border-radius: 10px; display: none; z-index: 10000; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        .login-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 40vh; }
        .login-input { width: 320px; padding: 15px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; background: #f9f9f9; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 5000; backdrop-filter: blur(3px); }
        .modal-content { background: white; padding: 40px; border-radius: 15px; width: 700px; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }

        /* --- EFECTO SOMBRERO AZUL / PARPADEO DINÁMICO --- */
        @keyframes bluePulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 84, 166, 0.4); border-left: 5px solid var(--primary); transform: scale(1); }
            50% { box-shadow: 0 0 15px 0 rgba(0, 84, 166, 0.2); border-left: 5px solid var(--highlight); transform: scale(1.005); }
            100% { box-shadow: 0 0 0 0 rgba(0, 84, 166, 0.4); border-left: 5px solid var(--primary); transform: scale(1); }
        }

        .mejor-coincidencia {
            animation: bluePulse 2s infinite ease-in-out;
            background-color: #e3f2fd !important; /* Azul muy suave */
            position: relative;
            z-index: 10;
            font-weight: 500;
        }
        
        /* Icono de estrella para el mejor resultado */
        .star-icon { color: var(--warning); margin-right: 5px; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div id="toast"></div>

<header class="header">
    <img src="https://drive.google.com/thumbnail?id=1bawJf9oARBLy2itsOfA9YE8RVAFNdNef" alt="Logo Distelsa">
    <div class="header-title">
        <h1>SISTEMA DE COBERTURA</h1>
        <div id="syncStatus" class="sync-status">● CONECTADO EN VIVO</div>
    </div>
    <div style="width: 70px;"></div>
</header>

<div class="container">
    <div id="loginPanel" class="login-wrapper">
        <h2 style="color:var(--primary); margin-bottom: 30px;">Acceso al Sistema</h2>
        <input id="userInput" placeholder="Usuario" class="login-input">
        <input id="passInput" type="password" placeholder="Contraseña" class="login-input">
        <button id="btnLogin" onclick="login()" class="btn" style="background:var(--primary); width: 350px; font-size: 16px;">INGRESAR</button>
    </div>

    <div id="appPanel" class="hidden">
        <div id="panelNuevo" class="hidden" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px; background:#f0f4f8; padding:25px; border-radius:12px; margin-bottom:30px; border: 1px solid #e1e5eb;">
            <div><label style="font-weight:bold; font-size:12px; color:#666;">MUNICIPIO</label><input id="newMuni" style="width:100%"></div>
            <div><label style="font-weight:bold; font-size:12px; color:#666;">NOMBRE</label><input id="newNom" style="width:100%"></div>
            <div><label style="font-weight:bold; font-size:12px; color:#666;">CATEGORÍA</label><input id="newCat" style="width:100%"></div>
            <div><label style="font-weight:bold; font-size:12px; color:#666;">ZONA</label><input id="newZona" style="width:100%"></div>
            <div><label style="font-weight:bold; font-size:12px; color:#666;">REFERENCIA</label><input id="newRef" style="width:100%"></div>
            <div><label style="font-weight:bold; font-size:12px; color:#666;">ESTADO INICIAL</label>
                <select id="newEst" style="width:100%; padding:11px;">
                    <option value="Sin Datos">Sin Datos</option>
                    <option value="Cobertura">Cobertura</option>
                    <option value="Sin Cobertura">Sin Cobertura</option>
                    <option value="Consultar">Consultar</option>
                </select>
            </div>
            <button onclick="crearCobertura()" class="btn" style="background:var(--success); grid-column: span 3; font-size:15px;">+ AGREGAR NUEVA UBICACIÓN</button>
        </div>

        <div style="display:flex; gap:15px; margin-bottom:25px; align-items: center; background: #f8f9fa; padding: 15px; border-radius: 10px;">
            <i class="fa-solid fa-search" style="color:var(--primary); font-size: 1.2em;"></i>
            <input id="buscar" placeholder="Ej: Mixco Col Milagr Z 6 (Usa abreviaturas)" oninput="pag=1; render()" style="flex-grow:1; padding:12px; font-size:16px; border:1px solid #ddd; background: white; outline: none; box-shadow: inset 0 2px 5px rgba(0,0,0,0.03);">
            <button id="btnExport" onclick="exportarExcel()" class="btn hidden" style="background:#217346;"><i class="fa-solid fa-file-excel"></i> Exportar</button>
            <button id="btnAdmin" onclick="abrirModal()" class="btn hidden" style="background:var(--warning); color:black;"><i class="fa-solid fa-users-gear"></i> Usuarios</button>
            <button onclick="logout()" class="btn" style="background:var(--dark);"><i class="fa-solid fa-right-from-bracket"></i> Salir</button>
        </div>

        <table style="box-shadow: 0 2px 15px rgba(0,0,0,0.05); border-radius: 8px; overflow: hidden;">
            <thead>
                <tr>
                    <th style="width:12%">Municipio</th>
                    <th style="width:18%">Nombre</th>
                    <th style="width:10%">Categoría</th>
                    <th style="width:8%">Zona</th>
                    <th style="width:20%">Referencia</th>
                    <th style="width:220px; text-align:center;">Estado / Acciones</th>
                </tr>
            </thead>
            <tbody id="cuerpo"></tbody>
        </table>

        <div style="text-align:center; margin-top:30px; display:flex; justify-content:center; align-items:center; gap:25px;">
            <button id="btnAnt" onclick="cambiarPag(-1)" class="btn" style="background:var(--primary); padding: 10px 25px;">Anterior</button>
            <span id="pagTxt" style="font-weight:bold; font-size:16px; color:var(--dark);">Página 1</span>
            <button id="btnSig" onclick="cambiarPag(1)" class="btn" style="background:var(--primary); padding: 10px 25px;">Siguiente</button>
        </div>
    </div>
</div>

<div id="modalUser" class="modal hidden">
    <div class="modal-content">
        <h2 style="color:var(--primary); margin-top:0;">Gestión de Usuarios</h2>
        <div style="background:#f0f4f8; padding:20px; border-radius:10px; margin-bottom:20px;">
            <h4 style="margin:0 0 15px 0; color:#666;">Agregar / Editar Usuario</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:10px;">
                <input id="uN" placeholder="Usuario">
                <input id="uP" placeholder="Contraseña">
                <select id="uR"><option value="Agente">Agente</option><option value="Lider">Lider</option><option value="Admin">Admin</option></select>
                <button onclick="guardarUser()" class="btn" style="background:var(--success); padding:10px 15px;"><i class="fa-solid fa-plus"></i></button>
            </div>
        </div>
        <div id="listaU" style="max-height: 400px; overflow-y: auto;"></div>
        <button onclick="cerrarModal()" class="btn" style="background:var(--dark); width:100%; margin-top:25px; padding: 15px;">CERRAR VENTANA</button>
    </div>
</div>

<script>
    // --- IMPORTANTE: Reemplaza esta URL con la tuya del Deployment de Apps Script ---
    const API = "https://script.google.com/macros/s/AKfycbzKAH4lBrQiuR1ODOmt7lAqz6FYsM_119SRo2aHzarSnyEhx4hMRqAD2l-btyceic2Tdg/exec"; 
    
    let MASTER = [], USUARIOS = [], ROL = "", pag = 1;

    // --- DICCIONARIO DE ABREVIATURAS PARA BÚSQUEDA INTELIGENTE ---
    const ABREVIATURAS = {
        "col": "colonia", "res": "residencial", "urb": "urbanizacion", 
        "av": "avenida", "z": "zona", "zn": "zona", "sta": "santa", "sto": "santo",
        "km": "kilometro", "blvd": "bulevar", "san": "san", "vill": "villa", 
        "cond": "condominio", "asent": "asentamiento", "lot": "lotificacion",
        "sec": "sector", "mz": "manzana"
    };

    async function cargarDatos(silencioso = false) {
        try {
            if(!silencioso) document.getElementById("btnLogin").innerText = "Conectando...";
            const res = await fetch(API);
            const data = await res.json();
            USUARIOS = data.usuarios.slice(1).map(r => ({ u: String(r[0]), p: String(r[1]), r: String(r[2]) }));
            MASTER = data.cobertura.slice(1).map((r, i) => ({ 
                fila: i + 2, m: r[0], n: r[1], c: r[2], z: r[3], ref: r[4], cob: r[5] || "Sin Datos",
                // Creamos un campo de texto completo normalizado para búsquedas rápidas
                full_search: normalizar(`${r[0]} ${r[1]} ${r[2]} ${r[3]} ${r[4]} ${r[5]}`)
            }));
            
            document.getElementById("btnLogin").innerText = "INGRESAR";
            document.getElementById("syncStatus").innerText = "● CONECTADO EN VIVO";
            
            if(ROL) render(); else if(!silencioso) checkSession();
        } catch (e) { 
            showToast("Error de conexión");
            console.error(e);
            document.getElementById("syncStatus").innerText = "● DESCONECTADO";
            document.getElementById("syncStatus").style.color = "var(--danger)";
        }
    }

    function checkSession() {
        const s = localStorage.getItem("distelsa_auth");
        if(s) { const d = JSON.parse(s); const u = USUARIOS.find(x => x.u === d.u && x.p === d.p); if(u) authOk(u.r); }
    }

    function login() {
        const u = document.getElementById("userInput").value.trim(), p = document.getElementById("passInput").value.trim();
        const user = USUARIOS.find(x => x.u === u && x.p === p);
        if(user) { localStorage.setItem("distelsa_auth", JSON.stringify({u, p})); authOk(user.r); } 
        else alert("Credenciales incorrectas");
    }

    function authOk(rol) {
        ROL = rol.toLowerCase();
        document.getElementById("loginPanel").classList.add("hidden");
        document.getElementById("appPanel").classList.remove("hidden");
        if(ROL === 'admin' || ROL === 'lider') {
            document.getElementById("panelNuevo").classList.remove("hidden");
            document.getElementById("btnExport").classList.remove("hidden");
        }
        if(ROL === 'admin') document.getElementById("btnAdmin").classList.remove("hidden");
        render();
    }

    // --- FUNCIÓN DE NORMALIZACIÓN (Quita tildes, minúsculas) ---
    function normalizar(texto) {
        if(!texto) return "";
        return texto.toString().toLowerCase()
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            .replace(/\./g, ""); // Quitar puntos también
    }

    // --- MOTOR DE BÚSQUEDA INTELIGENTE ---
    function render() {
        const queryRaw = document.getElementById("buscar").value;
        const query = normalizar(queryRaw);
        
        let resultados = [];

        if (!query) {
            resultados = MASTER; // Si no hay búsqueda, mostramos todo orden natural
        } else {
            // Dividir búsqueda en palabras clave (tokens)
            const tokens = query.split(" ").filter(t => t.length > 0);

            // Calcular puntaje para cada fila
            resultados = MASTER.map(row => {
                let puntos = 0;
                let coincidenTodos = true;

                tokens.forEach(token => {
                    // Verificar si el token existe directamente O si es una abreviatura expandida
                    const expansion = ABREVIATURAS[token] || token;
                    
                    // Lógica: La fila debe contener EL TOKEN exacto O su EXPANSIÓN
                    const matchDirecto = row.full_search.includes(token);
                    const matchExpansion = row.full_search.includes(expansion);

                    if (matchDirecto || matchExpansion) {
                        // Dar más puntos si coincide la palabra completa (expansión)
                        if (matchExpansion) puntos += 10;
                        if (matchDirecto) puntos += 5;
                    } else {
                        coincidenTodos = false;
                    }
                });

                return { ...row, score: puntos, match: coincidenTodos };
            });

            // Filtrar solo los que coinciden con TODOS los términos (lógica AND)
            resultados = resultados.filter(r => r.match);

            // Ordenar por puntaje (mayor a menor) para que el "sombrero azul" sea el #1
            resultados.sort((a, b) => b.score - a.score);
        }

        // Paginación
        const totalPags = Math.ceil(resultados.length / 10) || 1;
        const segment = resultados.slice((pag-1)*10, pag*10); 
        
        let html = "";
        segment.forEach((r, index) => {
            const col = r.cob=="Cobertura"?"bg-verde":r.cob=="Sin Cobertura"?"bg-rojo":r.cob=="Consultar"?"bg-amarillo":"bg-gris";
            const canEdit = (ROL === 'admin' || ROL === 'lider');
            
            // --- APLICAR EFECTO SOMBRERO AZUL AL PRIMER RESULTADO SI HAY BÚSQUEDA ---
            // Solo si hay búsqueda activa (query) y es el primer elemento de la primera página
            const esElMejor = (query !== "" && pag === 1 && index === 0);
            const claseFila = esElMejor ? "mejor-coincidencia" : "";
            const iconoMejor = esElMejor ? '<i class="fa-solid fa-star star-icon"></i>' : '';

            html += `<tr id="row-${r.fila}" class="${claseFila}">
                <td>${esElMejor ? iconoMejor : ''}${canEdit ? `<input id="m-${r.fila}" value="${r.m}" oninput="marcar(${r.fila})">` : r.m}</td>
                <td>${canEdit ? `<input id="n-${r.fila}" value="${r.n}" style="font-weight:bold;" oninput="marcar(${r.fila})">` : `<b>${r.n}</b>`}</td>
                <td>${canEdit ? `<input id="c-${r.fila}" value="${r.c}" oninput="marcar(${r.fila})">` : r.c}</td>
                <td>${canEdit ? `<input id="z-${r.fila}" value="${r.z}" oninput="marcar(${r.fila})">` : r.z}</td>
                <td>${canEdit ? `<input id="ref-${r.fila}" value="${r.ref}" oninput="marcar(${r.fila})">` : r.ref}</td>
                <td>
                    <div style="display:flex; gap:8px; justify-content:center;">
                        <select id="s-${r.fila}" class="badge ${col}" onchange="marcar(${r.fila})" ${!canEdit ? 'disabled' : ''}>
                            <option value="Sin Datos" ${r.cob=='Sin Datos'?'selected':''}>Sin Datos</option>
                            <option value="Cobertura" ${r.cob=='Cobertura'?'selected':''}>Cobertura</option>
                            <option value="Sin Cobertura" ${r.cob=='Sin Cobertura'?'selected':''}>Sin Cobertura</option>
                            <option value="Consultar" ${r.cob=='Consultar'?'selected':''}>Consultar</option>
                        </select>
                        ${canEdit ? `
                            <button onclick="guardarTodo(${r.fila})" class="btn" style="background:var(--primary); padding:8px 12px;"><i class="fa-solid fa-floppy-disk"></i></button>
                            <button onclick="eliminarCob(${r.fila}, '${r.n}')" class="btn" style="background:var(--danger); padding:8px 12px;"><i class="fa-solid fa-trash-can"></i></button>
                        ` : ''}
                    </div>
                </td>
            </tr>`;
        });
        document.getElementById("cuerpo").innerHTML = html || '<tr><td colspan="6" style="text-align:center;">No hay resultados</td></tr>';
        document.getElementById("pagTxt").innerText = `Página ${pag} de ${totalPags}`;
        document.getElementById("btnAnt").disabled = pag <= 1;
        document.getElementById("btnSig").disabled = pag >= totalPags;
    }

    async function guardarTodo(fila) {
        const body = {
            action: 'updateFullCob', fila,
            m: document.getElementById(`m-${fila}`).value,
            n: document.getElementById(`n-${fila}`).value,
            c: document.getElementById(`c-${fila}`).value,
            z: document.getElementById(`z-${fila}`).value,
            ref: document.getElementById(`ref-${fila}`).value,
            val: document.getElementById(`s-${fila}`).value
        };
        showToast("Sincronizando...");
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify(body) });
        // Actualizar MASTER localmente
        const item = MASTER.find(x => x.fila === fila);
        if(item) {
            Object.assign(item, { m: body.m, n: body.n, c: body.c, z: body.z, ref: body.ref, cob: body.val });
            // Recalcular el texto de búsqueda por si cambió algo
            item.full_search = normalizar(`${body.m} ${body.n} ${body.c} ${body.z} ${body.ref} ${body.val}`);
        }
        document.getElementById(`row-${fila}`).classList.remove('modified');
        render(); showToast("Guardado");
    }

    async function crearCobertura() {
        const d = {
            action: 'addCob',
            m: document.getElementById("newMuni").value, n: document.getElementById("newNom").value,
            c: document.getElementById("newCat").value, z: document.getElementById("newZona").value,
            ref: document.getElementById("newRef").value, val: document.getElementById("newEst").value
        };
        if(!d.m || !d.n) return alert("Municipio y Nombre son obligatorios");
        showToast("Guardando...");
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify(d) });
        ["newMuni","newNom","newCat","newZona","newRef"].forEach(id => document.getElementById(id).value = "");
        await cargarDatos(true);
        showToast("Agregado exitosamente");
    }

    async function eliminarCob(fila, n) {
        if(!confirm(`¿Eliminar permanentemente: "${n}"?`)) return;
        showToast("Eliminando...");
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'deleteCob', fila }) });
        MASTER = MASTER.filter(x => x.fila !== fila);
        render(); showToast("Eliminado");
    }

    function exportarExcel() {
        const queryRaw = document.getElementById("buscar").value;
        const query = normalizar(queryRaw);
        // Usamos la misma lógica de filtrado para el excel
        let exportData = MASTER;
        if(query) {
            const tokens = query.split(" ").filter(t => t.length > 0);
            exportData = MASTER.filter(r => {
                return tokens.every(token => {
                    const expansion = ABREVIATURAS[token] || token;
                    return r.full_search.includes(token) || r.full_search.includes(expansion);
                });
            });
        }
        
        let csv = "Municipio,Nombre,Categoria,Zona,Referencia,Estado\n";
        exportData.forEach(r => csv += `"${r.m}","${r.n}","${r.c}","${r.z}","${r.ref}","${r.cob}"\n`);
        const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Reporte_Cobertura.csv`;
        link.click();
    }

    function marcar(f) { document.getElementById(`row-${f}`).classList.add('modified'); }
    function cambiarPag(v) { pag += v; render(); }
    function showToast(m) { const t = document.getElementById("toast"); t.innerText = m; t.style.display="block"; setTimeout(()=>t.style.display="none", 3000); }
    function logout() { localStorage.removeItem("distelsa_auth"); location.reload(); }
    function abrirModal() { document.getElementById("modalUser").classList.remove("hidden"); renderUsers(); }
    function cerrarModal() { document.getElementById("modalUser").classList.add("hidden"); }

    function renderUsers() {
        let html = "";
        USUARIOS.forEach(u => {
            html += `<div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #eee; align-items:center;">
                <div><b>${u.u}</b> <span class="badge bg-gris" style="width:auto; margin-left:10px;">${u.r}</span></div>
                <button onclick="eliminarUser('${u.u}')" class="btn" style="background:var(--danger); padding:8px 12px;"><i class="fa-solid fa-trash-can"></i></button>
            </div>`;
        });
        document.getElementById("listaU").innerHTML = html;
    }

    async function guardarUser() {
        const usuario = document.getElementById("uN").value, clave = document.getElementById("uP").value, rol = document.getElementById("uR").value;
        if(!usuario || !clave) return alert("Faltan datos");
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'addUser', usuario, clave, rol }) });
        await cargarDatos(true); renderUsers();
    }

    async function eliminarUser(u) {
        if(!confirm(`¿Eliminar al usuario ${u}?`)) return;
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'deleteUser', usuarioNombre: u }) }); // Corregido action
        await cargarDatos(true); renderUsers();
    }

    window.onload = cargarDatos;
</script>
</body>
</html>
