<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DISTELSA PRO V3.1</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --p: #003399; --s: #27ae60; --d: #c0392b; --w: #f39c12; --g: #7f8c8d; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; color: #333; }
        .hidden { display: none !important; }
        
        /* HEADER PREMIUM */
        header { background: #fff; border-bottom: 4px solid var(--p); padding: 10px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); sticky; top:0; z-index:100; }
        .logo { font-weight: 800; font-size: 24px; color: var(--p); letter-spacing: -1px; }

        .container { max-width: 1450px; margin: 25px auto; padding: 0 20px; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }

        /* TABLA Y ESTADOS */
        .table-container { overflow-x: auto; margin-top: 20px; border-radius: 8px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f1f4f9; padding: 15px; text-align: left; color: #555; text-transform: uppercase; font-size: 12px; }
        td { padding: 12px; border-bottom: 1px solid #f2f2f2; }
        
        .badge { padding: 6px 12px; border-radius: 20px; color: white; font-weight: 700; font-size: 11px; text-transform: uppercase; border: none; width: 100%; text-align: center; display: block; }
        .bg-cob { background: var(--s) !important; }
        .bg-nocob { background: var(--d) !important; }
        .bg-cons { background: var(--w) !important; color: #000; }
        .bg-null { background: var(--g) !important; }

        /* BOTONES */
        .btn { padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-p { background: var(--p); color: white; }
        .btn-s { background: var(--s); color: white; }
        .btn-d { background: var(--d); color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* WIDGET ONLINE */
        .online-box { background: #eef2ff; color: var(--p); padding: 8px 15px; border-radius: 25px; font-weight: bold; font-size: 13px; border: 1px solid #d0d9f0; position: relative; cursor: help; }
        .online-dot { width: 8px; height: 8px; background: var(--s); border-radius: 50%; display: inline-block; margin-right: 5px; animation: pulse 2s infinite; }
        .online-list { display: none; position: absolute; top: 110%; right: 0; background: white; border: 1px solid #ddd; width: 180px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 100; border-radius: 8px; padding: 12px; }
        .online-box:hover .online-list { display: block; }

        /* MODALES */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 700px; max-height: 85vh; overflow-y: auto; position: relative; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; width: 100%; box-sizing: border-box; }
        
        /* HISTORIAL COLORES */
        .h-badge { padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; color: white; }
        .h-crear { background: var(--s); }
        .h-editar { background: var(--p); }
        .h-eliminar { background: var(--d); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:20px;">
        <span class="logo">DISTELSA</span>
        <div style="width:2px; height:25px; background:#eee;"></div>
        <span style="font-size:12px; color:#999; font-weight:bold; letter-spacing:1px;">COBERTURA PRO V3.1</span>
    </div>
    
    <div id="navTools" class="hidden" style="display:flex; align-items:center; gap:20px;">
        <div class="online-box">
            <div class="online-dot"></div> <span id="onCount">0</span> Conectados
            <div id="onList" class="online-list"></div>
        </div>
        <div style="text-align:right">
            <div id="uDisplay" style="font-weight:bold; color:var(--p);">USUARIO</div>
            <div id="rDisplay" style="font-size:10px; color:#777; text-transform:uppercase;">ROL</div>
        </div>
        <button onclick="logout()" class="btn btn-d" style="padding:8px;"><i class="fa-solid fa-power-off"></i></button>
    </div>
</header>

<div id="loginBox" class="container" style="max-width: 400px; margin-top: 10vh;">
    <div class="card" style="text-align: center;">
        <h2 style="color:var(--p);">Iniciar Sesión</h2>
        <p style="font-size:13px; color:#888;">Acceso restringido para personal autorizado</p>
        <div style="margin-top:20px;">
            <input type="text" id="user" placeholder="Usuario" style="margin-bottom:12px;">
            <input type="password" id="pass" placeholder="Contraseña" style="margin-bottom:20px;">
            <button onclick="login()" class="btn btn-p" style="width:100%; justify-content:center; padding:15px;">INGRESAR</button>
        </div>
    </div>
</div>

<div id="app" class="container hidden">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:15px; margin-bottom:20px;">
            <div style="position:relative; flex-grow:1;">
                <i class="fa-solid fa-magnifying-glass" style="position:absolute; left:15px; top:15px; color:#aaa;"></i>
                <input type="text" id="search" placeholder="Buscar por municipio, nombre o referencia..." style="padding-left:45px;" onkeyup="resetPag(); render()">
            </div>
            <div style="display:flex; gap:10px;">
                <button id="btnAdd" onclick="toggleModal('modalAdd', true)" class="btn btn-s hidden"><i class="fa-solid fa-plus"></i> NUEVO</button>
                <button id="btnExcel" onclick="exportarExcel()" class="btn btn-p hidden" style="background:#1d6f42;"><i class="fa-solid fa-file-excel"></i> EXPORTAR</button>
                <button id="btnHist" onclick="toggleModal('modalHist', true)" class="btn btn-p hidden"><i class="fa-solid fa-clock-rotate-left"></i> HISTORIAL</button>
                <button id="btnUsers" onclick="toggleModal('modalUsers', true)" class="btn btn-p hidden" style="background:#444;"><i class="fa-solid fa-user-gear"></i></button>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th width="15%">Municipio</th>
                        <th width="20%">Nombre</th>
                        <th width="15%">Categoría</th>
                        <th width="5%">Zona</th>
                        <th width="25%">Referencia</th>
                        <th width="15%">Cobertura</th>
                        <th class="adm-cell hidden" width="5%"></th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>

        <div style="display:flex; justify-content:center; align-items:center; gap:20px; margin-top:25px;">
            <button onclick="changePag(-1)" id="btnPrev" class="btn btn-p"><i class="fa-solid fa-chevron-left"></i></button>
            <span id="pagInfo" style="font-weight:bold; color:var(--p);">Página 1</span>
            <button onclick="changePag(1)" id="btnNext" class="btn btn-p"><i class="fa-solid fa-chevron-right"></i></button>
        </div>
    </div>
</div>

<div id="modalAdd" class="modal-overlay hidden">
    <div class="modal-content">
        <h3 style="color:var(--p); margin-top:0;">Nueva Ubicación de Cobertura</h3>
        <div class="form-grid">
            <div><label>Municipio</label><input id="nM"></div>
            <div><label>Nombre</label><input id="nN"></div>
            <div><label>Categoría</label><input id="nC" placeholder="Ej: Fibra, GPON, etc."></div>
            <div><label>Zona</label><input id="nZ"></div>
            <div style="grid-column: span 2;"><label>Referencia</label><input id="nR"></div>
            <div style="grid-column: span 2;">
                <label>Estado de Cobertura</label>
                <select id="nCob">
                    <option value="Cobertura">Cobertura</option>
                    <option value="Sin Cobertura">Sin Cobertura</option>
                    <option value="Consultar">Consultar</option>
                    <option value="Sin Datos">Sin Datos</option>
                </select>
            </div>
        </div>
        <div style="margin-top:25px; display:flex; justify-content:flex-end; gap:10px;">
            <button onclick="toggleModal('modalAdd', false)" class="btn btn-d">Cancelar</button>
            <button onclick="addCoverage()" class="btn btn-s">Guardar Registro</button>
        </div>
    </div>
</div>

<div id="modalHist" class="modal-overlay hidden">
    <div class="modal-content" style="max-width:850px;">
        <h3 style="color:var(--p);">Auditoría de Actividad</h3>
        <div class="table-container" style="max-height:400px; overflow-y:auto;">
            <table>
                <thead><tr><th>Fecha</th><th>Usuario</th><th>Acción</th><th>Detalle</th></tr></thead>
                <tbody id="hBody"></tbody>
            </table>
        </div>
        <button onclick="toggleModal('modalHist', false)" class="btn btn-p" style="margin-top:15px; width:100%; justify-content:center;">Cerrar</button>
    </div>
</div>

<div id="modalUsers" class="modal-overlay hidden">
    <div class="modal-content">
        <h3 style="color:var(--p);">Administración de Usuarios</h3>
        <div style="display:flex; gap:5px; margin-bottom:15px;">
            <input id="uN" placeholder="Usuario">
            <input id="uP" placeholder="Clave">
            <select id="uR"><option value="agente">Agente</option><option value="lider">Líder</option><option value="admin">Admin</option></select>
            <button onclick="manageUser('add')" class="btn btn-s"><i class="fa-solid fa-plus"></i></button>
        </div>
        <div id="uList" style="border-top:1px solid #eee;"></div>
        <button onclick="toggleModal('modalUsers', false)" class="btn btn-d" style="margin-top:15px; width:100%; justify-content:center;">Cerrar</button>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwkQ4J8EzuhtKzCHHi-BjHAUCc-S2SenPJdscB-Fvw1FuR-cP-K_2rVdImqK2cuqXbi6g/exec"; 
    let DATA = { cob: [], logs: [], users: [], online: [], tokens: {} };
    let SES = { u: "", r: "", tk: "" };
    let pag = 1;

    async function fetchData() {
        try {
            const res = await fetch(API_URL);
            const json = await res.json();
            if (SES.u && json.tokens[SES.u.toLowerCase()] !== SES.tk) { logout(); return; }
            
            // Mapeo 6 columnas: Municipio | Nombre | Categoria | Zona | Referencia | Cobertura
            DATA.cob = json.cobertura.slice(1).map((r, i) => ({
                f: i + 2, m: r[0], n: r[1], c: r[2], z: r[3], r: r[4], cob: r[5] || "Sin Datos"
            }));
            DATA.users = json.usuariosList;
            DATA.logs = json.historial;
            DATA.online = json.onlineList;
            
            updateWidgets();
            if(SES.u) render();
        } catch(e) { console.warn("Sincronizando..."); }
    }

    function updateWidgets() {
        document.getElementById("onCount").innerText = DATA.online.length;
        document.getElementById("onList").innerHTML = (SES.r==='admin') ? 
            "<b>Usuarios Activos:</b><hr>" + DATA.online.map(u => `<div style='padding:3px 0'>• ${u}</div>`).join('') : "<i>Privilegio de Admin</i>";
    }

    async function login() {
        const u = document.getElementById("user").value, p = document.getElementById("pass").value;
        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({action:'login', u, p}) });
        const rj = await res.json();
        if(rj.status === 'ok') {
            SES = { u, r: rj.rol, tk: rj.token };
            localStorage.setItem("dist_v31", JSON.stringify(SES));
            start();
        } else alert("Credenciales Incorrectas");
    }

    function start() {
        const storage = localStorage.getItem("dist_v31");
        if(storage) {
            SES = JSON.parse(storage);
            document.getElementById("loginBox").classList.add("hidden");
            document.getElementById("app").classList.remove("hidden");
            document.getElementById("navTools").classList.remove("hidden");
            document.getElementById("uDisplay").innerText = SES.u.toUpperCase();
            document.getElementById("rDisplay").innerText = SES.r;
            
            const isAL = (SES.r==='admin' || SES.r==='lider');
            if(isAL) {
                document.querySelectorAll(".adm-cell").forEach(e => e.classList.remove("hidden"));
                document.getElementById("btnExcel").classList.remove("hidden");
                document.getElementById("btnAdd").classList.remove("hidden");
            }
            if(SES.r==='admin') {
                document.getElementById("btnHist").classList.remove("hidden");
                document.getElementById("btnUsers").classList.remove("hidden");
            }
            fetchData();
            setInterval(() => {
                fetch(API_URL, { method:'POST', body: JSON.stringify({action:'heartbeat', u: SES.u}) });
                fetchData();
            }, 30000);
        }
    }

    function render() {
        const q = document.getElementById("search").value.toLowerCase();
        const filtered = DATA.cob.filter(r => `${r.m} ${r.n} ${r.c} ${r.r}`.toLowerCase().includes(q));
        const totalPags = Math.ceil(filtered.length / 10) || 1;
        const slice = filtered.slice((pag-1)*10, pag*10);
        const tbody = document.getElementById("tbody");
        tbody.innerHTML = "";
        
        const canEdit = (SES.r==='admin' || SES.r==='lider');

        slice.forEach(r => {
            const cls = r.cob=='Cobertura'?'bg-cob':r.cob=='Sin Cobertura'?'bg-nocob':r.cob=='Consultar'?'bg-cons':'bg-null';
            tbody.innerHTML += `
                <tr>
                    <td>${canEdit ? `<input id="m-${r.f}" value="${r.m}">` : r.m}</td>
                    <td>${canEdit ? `<input id="n-${r.f}" value="${r.n}" style="font-weight:bold">` : `<b>${r.n}</b>`}</td>
                    <td>${canEdit ? `<input id="c-${r.f}" value="${r.c}">` : r.c}</td>
                    <td>${canEdit ? `<input id="z-${r.f}" value="${r.z}" style="text-align:center">` : r.z}</td>
                    <td>${canEdit ? `<input id="r-${r.f}" value="${r.r}">` : r.r}</td>
                    <td>
                        <select id="v-${r.f}" class="badge ${cls}" ${!canEdit?'disabled':''} onchange="this.className='badge '+ (this.value=='Cobertura'?'bg-cob':this.value=='Sin Cobertura'?'bg-nocob':this.value=='Consultar'?'bg-cons':'bg-null')">
                            <option value="Sin Datos" ${r.cob=='Sin Datos'?'selected':''}>Sin Datos</option>
                            <option value="Cobertura" ${r.cob=='Cobertura'?'selected':''}>Cobertura</option>
                            <option value="Sin Cobertura" ${r.cob=='Sin Cobertura'?'selected':''}>Sin Cobertura</option>
                            <option value="Consultar" ${r.cob=='Consultar'?'selected':''}>Consultar</option>
                        </select>
                    </td>
                    <td class="adm-cell ${canEdit?'':'hidden'}">
                        <button onclick="save(${r.f})" class="btn btn-p" style="padding:5px 10px"><i class="fa-solid fa-save"></i></button>
                    </td>
                </tr>`;
        });
        document.getElementById("pagInfo").innerText = `Página ${pag} de ${totalPags}`;
    }

    async function save(f) {
        const d = {
            action:'update', fila: f, userLog: SES.u,
            m: document.getElementById(`m-${f}`).value, n: document.getElementById(`n-${f}`).value,
            c: document.getElementById(`c-${f}`).value, z: document.getElementById(`z-${f}`).value, 
            r: document.getElementById(`r-${f}`).value, cob: document.getElementById(`v-${f}`).value
        };
        await fetch(API_URL, { method:'POST', mode:'no-cors', body: JSON.stringify(d) });
        alert("¡Actualizado!"); fetchData();
    }

    async function addCoverage() {
        const d = {
            action:'addCoverage', userLog: SES.u,
            m: document.getElementById("nM").value, n: document.getElementById("nN").value,
            c: document.getElementById("nC").value, z: document.getElementById("nZ").value,
            r: document.getElementById("nR").value, cob: document.getElementById("nCob").value
        };
        if(!d.m || !d.n) return alert("Municipio y Nombre son obligatorios");
        await fetch(API_URL, { method:'POST', mode:'no-cors', body: JSON.stringify(d) });
        toggleModal('modalAdd', false);
        alert("Agregado exitosamente"); fetchData();
    }

    function toggleModal(id, show) {
        document.getElementById(id).classList.toggle("hidden", !show);
        if(id === 'modalUsers' && show) {
            document.getElementById("uList").innerHTML = DATA.users.map(u => `
                <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
                    <span><b>${u[0]}</b> (${u[2]})</span>
                    <button onclick="manageUser('del','${u[0]}')" class="btn btn-d" style="padding:4px 8px; font-size:10px;">Eliminar</button>
                </div>`).join('');
        }
        if(id === 'modalHist' && show) {
            document.getElementById("hBody").innerHTML = DATA.logs.map(l => {
                let badge = l[2]==='CREAR'?'h-crear':l[2]==='EDITAR'?'h-editar':'h-eliminar';
                return `<tr><td>${new Date(l[0]).toLocaleString()}</td><td><b>${l[1]}</b></td><td><span class="h-badge ${badge}">${l[2]}</span></td><td>${l[3]}</td></tr>`;
            }).join('');
        }
    }

    async function manageUser(type, name) {
        const u = name || document.getElementById("uN").value, p = document.getElementById("uP").value, r = document.getElementById("uR").value;
        await fetch(API_URL, { method:'POST', body: JSON.stringify({action:'manageUser', type, u, p, r, userLog: SES.u}) });
        fetchData(); toggleModal('modalUsers', false);
    }

    function exportarExcel() {
        const ws = XLSX.utils.json_to_sheet(DATA.cob.map(r => ({ Municipio: r.m, Nombre: r.n, Categoria: r.c, Zona: r.z, Referencia: r.r, Cobertura: r.cob })));
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Cobertura");
        XLSX.writeFile(wb, "Reporte_Distelsa_2026.xlsx");
    }

    function changePag(v) { pag = Math.max(1, pag + v); render(); }
    function resetPag() { pag = 1; }
    function logout() { localStorage.clear(); location.reload(); }
    start();
</script>
</body>
</html>

