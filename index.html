<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grupo Distelsa | Cobertura</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root { 
    --blue: #002855; /* Azul Corporativo Oscuro */
    --light-blue: #0056b3; 
    --green: #28a745; 
    --red: #dc3545; 
    --yellow: #ffc107; 
    --bg: #f4f6f8; 
  }
  body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; color: #333; }
  .hidden { display: none !important; }

  /* HEADER */
  header { background: white; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; border-bottom: 3px solid var(--blue); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
  .logo { font-size: 20px; font-weight: 800; color: var(--blue); letter-spacing: -0.5px; display: flex; align-items: center; gap: 10px; }
  .user-info { text-align: right; font-size: 13px; line-height: 1.2; }
  
  /* LOGIN */
  .login-wrapper { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background: linear-gradient(135deg, #e9ecef 0%, #ffffff 100%); }
  .login-box { background: white; padding: 40px; width: 320px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 5px solid var(--blue); text-align: center; }
  .inp { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
  .inp:focus { border-color: var(--light-blue); outline: none; box-shadow: 0 0 0 3px rgba(0,86,179,0.1); }
  
  /* BOTONES */
  .btn { border: none; padding: 10px 15px; border-radius: 4px; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; font-size: 13px; }
  .btn-p { background: var(--blue); color: white; }
  .btn-s { background: var(--green); color: white; }
  .btn-d { background: var(--red); color: white; }
  .btn:hover { opacity: 0.9; }
  .btn:disabled { background: #6c757d; cursor: not-allowed; }

  /* APP CONTAINER */
  .container { max-width: 1300px; margin: 20px auto; padding: 0 20px; }
  
  /* SEARCH BAR & TOOLS */
  .tools { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
  .search-wrap { flex: 1; position: relative; }
  .search-wrap i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #adb5bd; }
  .search-inp { width: 100%; padding: 12px 12px 12px 35px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; }

  /* TABLA PRINCIPAL */
  .card { background: white; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed; }
  th { text-align: left; padding: 12px 15px; background: #f8f9fa; color: #495057; font-weight: 700; border-bottom: 2px solid #e9ecef; }
  td { padding: 10px 15px; border-bottom: 1px solid #f1f3f5; vertical-align: middle; }
  tr:hover td { background-color: #f8f9fa; }

  /* BADGES (ESTADO) - SIN OPACIDAD */
  .badge { display: block; padding: 6px 0; text-align: center; border-radius: 4px; font-weight: bold; font-size: 11px; text-transform: uppercase; color: white; }
  .bg-ok { background: var(--green); }
  .bg-no { background: var(--red); }
  .bg-warn { background: var(--yellow); color: #212529; }
  .bg-none { background: #dee2e6; color: #6c757d; }

  /* SELECTOR ADMIN */
  .status-select { width: 100%; padding: 5px; border-radius: 4px; font-weight: bold; border: 1px solid #ccc; cursor: pointer; }

  /* MODALES */
  .modal-backdrop { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px); }
  .modal { background: white; width: 95%; max-width: 700px; padding: 25px; border-radius: 8px; box-shadow: 0 15px 50px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
  .modal-title { font-size: 18px; font-weight: 700; color: var(--blue); margin: 0; }

  /* EDITOR DE USUARIOS */
  .user-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
  .user-item:last-child { border-bottom: none; }
  .online-badge { font-size: 10px; padding: 2px 6px; background: #e8f5e9; color: #2e7d32; border-radius: 10px; margin-left: 5px; border: 1px solid #c8e6c9; }

  /* EDIT IN PLACE */
  .edit-field { width: 100%; border: 1px solid transparent; background: transparent; font-family: inherit; font-size: inherit; color: inherit; padding: 4px; }
  .edit-field:focus { border-color: var(--light-blue); background: white; }

</style>
</head>
<body>

<div id="viewLogin" class="login-wrapper">
  <div class="login-box">
    <h3 style="color:var(--blue); margin-top:0;">GRUPO DISTELSA</h3>
    <p style="font-size:12px; color:#6c757d; margin-bottom:20px;">SISTEMA DE COBERTURA PRO</p>
    
    <input id="txtUser" class="inp" placeholder="Usuario">
    <input id="txtPass" type="password" class="inp" placeholder="Contraseña">
    
    <button id="btnLogin" onclick="login()" class="btn btn-p" style="width:100%; justify-content: center; margin-top: 15px; height: 45px;">
      INGRESAR AL SISTEMA
    </button>
  </div>
</div>

<div id="viewApp" class="hidden">
  <header>
    <div class="logo">
      <i class="fa-solid fa-satellite-dish"></i> GRUPO DISTELSA
    </div>
    <div style="display: flex; align-items: center; gap: 15px;">
      <div id="onlineMonitor" class="hidden" style="font-size: 11px; background: #e3f2fd; color: #0d47a1; padding: 5px 10px; border-radius: 20px; font-weight: bold;">
        <i class="fa-solid fa-circle" style="font-size: 8px;"></i> Online: <span id="onlineCount">0</span>
      </div>

      <div class="user-info">
        <div id="lblUser" style="font-weight: bold;">Usuario</div>
        <div id="lblRol" style="color: #6c757d; text-transform: uppercase; font-size: 11px;">Rol</div>
      </div>
      <button onclick="logout()" class="btn btn-d" title="Cerrar Sesión"><i class="fa-solid fa-power-off"></i></button>
    </div>
  </header>

  <div class="container">
    <div class="tools">
      <div class="search-wrap">
        <i class="fa-solid fa-search"></i>
        <input id="searchBox" class="search-inp" placeholder="Búsqueda Inteligente (Ej: 'Guate' encuentra 'Guatemala', 'Zna 1' encuentra 'Zona 1')..." onkeyup="renderTable(true)">
      </div>
      
      <button id="btnAdd" onclick="openModal('modalAdd')" class="btn btn-s hidden"><i class="fa-solid fa-plus"></i> Nuevo</button>
      <button id="btnExp" onclick="exportToExcel()" class="btn btn-p hidden" style="background:#217346"><i class="fa-solid fa-file-excel"></i> Excel</button>
      
      <button id="btnHis" onclick="openHistorial()" class="btn btn-p hidden"><i class="fa-solid fa-clock-rotate-left"></i> Historial</button>
      <button id="btnUsr" onclick="openUsers()" class="btn btn-p hidden" style="background:#343a40"><i class="fa-solid fa-users-gear"></i> Usuarios</button>
    </div>

    <div class="card">
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th width="12%">Municipio</th>
              <th width="20%">Nombre</th>
              <th width="12%">Categoría</th>
              <th width="8%">Zona</th>
              <th width="25%">Referencia</th>
              <th width="15%">Cobertura</th>
              <th width="8%" class="col-action hidden"></th>
            </tr>
          </thead>
          <tbody id="tableBody">
            </tbody>
        </table>
      </div>
      
      <div style="padding: 15px; display: flex; justify-content: center; align-items: center; gap: 20px;">
        <button onclick="changePage(-1)" class="btn btn-p"><i class="fa-solid fa-chevron-left"></i></button>
        <span id="pageLabel" style="font-weight: bold; font-size: 13px;">1 / 1</span>
        <button onclick="changePage(1)" class="btn btn-p"><i class="fa-solid fa-chevron-right"></i></button>
      </div>
    </div>
  </div>
</div>

<div id="modalAdd" class="modal-backdrop hidden">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Nueva Ubicación</h3>
      <button onclick="closeModal('modalAdd')" class="btn btn-d" style="padding: 5px 10px;"><i class="fa-solid fa-times"></i></button>
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
      <input id="newMun" class="inp" placeholder="Municipio">
      <input id="newNom" class="inp" placeholder="Nombre Lugar">
      <input id="newCat" class="inp" placeholder="Categoría">
      <input id="newZon" class="inp" placeholder="Zona">
      <input id="newRef" class="inp" style="grid-column: span 2;" placeholder="Referencia">
      <select id="newCob" class="inp" style="grid-column: span 2;">
        <option value="Cobertura">Cobertura</option>
        <option value="Sin Cobertura">Sin Cobertura</option>
        <option value="Consultar">Consultar</option>
      </select>
    </div>
    <div style="margin-top: 20px; text-align: right;">
      <button onclick="saveLocation('new')" class="btn btn-s">Guardar Registro</button>
    </div>
  </div>
</div>

<div id="modalUsr" class="modal-backdrop hidden">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Administración de Usuarios</h3>
      <button onclick="closeModal('modalUsr')" class="btn btn-d" style="padding: 5px 10px;"><i class="fa-solid fa-times"></i></button>
    </div>
    
    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
      <input id="uUser" class="inp" placeholder="Usuario" style="margin:0">
      <input id="uPass" class="inp" placeholder="Clave" style="margin:0">
      <select id="uRol" class="inp" style="margin:0; width: 120px;">
        <option value="agente">Agente</option>
        <option value="lider">Lider</option>
        <option value="admin">Admin</option>
      </select>
      <button id="btnUserAction" onclick="submitUser()" class="btn btn-s" title="Guardar"><i class="fa-solid fa-plus"></i></button>
      <button onclick="clearUserForm()" class="btn btn-d" title="Limpiar"><i class="fa-solid fa-eraser"></i></button>
    </div>

    <input id="searchUserBox" class="inp" placeholder="Buscar usuario..." onkeyup="renderUserList()">
    
    <div style="max-height: 350px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px;">
      <div id="userListContainer"></div>
    </div>
    
    <div style="text-align: center; margin-top: 10px; display: flex; justify-content: center; gap: 15px;">
        <button onclick="changeUserPage(-1)" class="btn btn-p btn-sm"><i class="fa-solid fa-chevron-left"></i></button>
        <span id="userPageLabel" style="font-weight:bold; font-size:12px; align-self:center;"></span>
        <button onclick="changeUserPage(1)" class="btn btn-p btn-sm"><i class="fa-solid fa-chevron-right"></i></button>
    </div>
  </div>
</div>

<div id="modalHis" class="modal-backdrop hidden">
  <div class="modal" style="max-width: 800px;">
    <div class="modal-header">
      <h3 class="modal-title">Historial de Eventos</h3>
      <button onclick="closeModal('modalHis')" class="btn btn-d"><i class="fa-solid fa-times"></i></button>
    </div>
    <div style="max-height: 400px; overflow-y: auto;">
      <table id="tableHistory"></table>
    </div>
  </div>
</div>

<script>
// ==========================================
// CONFIGURACIÓN CENTRAL
// ==========================================
const API_URL = "https://script.google.com/macros/s/AKfycbzjKBO-ZtGUR4kLAFMS8cXcWq-8CbK-ehgI2lMxcHpwAC8ksrRZBMLyrlPKOFBbwgluOQ/exec"; 

// Variables Globales
let DB = { cob: [], users: [], history: [], online: [] };
let SESION = { u: null, r: null, t: null };
let PAGE = 1;
const ROWS_PER_PAGE = 10;
let USER_PAGE = 1;
let EDITING_USER = false;

// ==========================================
// CICLO DE VIDA
// ==========================================
window.onload = () => {
  const savedSession = localStorage.getItem('distelsa_session_v5');
  if(savedSession) {
    SESION = JSON.parse(savedSession);
    startApp();
  }
};

// 1. LOGIN SEGURO
async function login() {
  const u = document.getElementById('txtUser').value.trim();
  const p = document.getElementById('txtPass').value.trim();
  const btn = document.getElementById('btnLogin');

  if(!u || !p) return alert("Por favor ingresa usuario y contraseña.");

  btn.disabled = true;
  btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Validando credenciales...';

  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'login', u: u, p: p })
    });
    const data = await res.json();

    if(data.status === 'ok') {
      SESION = { u: u, r: data.rol, t: data.token };
      localStorage.setItem('distelsa_session_v5', JSON.stringify(SESION));
      startApp();
    } else {
      alert(data.msg || "Error de acceso");
      btn.disabled = false;
      btn.innerHTML = 'INGRESAR AL SISTEMA';
    }
  } catch(e) {
    alert("Error de conexión. Verifica tu internet.");
    btn.disabled = false;
    btn.innerHTML = 'INGRESAR AL SISTEMA';
  }
}

function startApp() {
  document.getElementById('viewLogin').classList.add('hidden');
  document.getElementById('viewApp').classList.remove('hidden');
  
  // UI Info
  document.getElementById('lblUser').innerText = SESION.u;
  document.getElementById('lblRol').innerText = SESION.r;

  // Permisos
  const isAdmin = (SESION.r === 'admin');
  const isLider = (SESION.r === 'lider' || isAdmin);

  if(isLider) {
    document.getElementById('btnAdd').classList.remove('hidden');
    document.getElementById('btnExp').classList.remove('hidden');
    document.querySelectorAll('.col-action').forEach(el => el.classList.remove('hidden'));
  }
  
  if(isAdmin) {
    document.getElementById('btnHis').classList.remove('hidden');
    document.getElementById('btnUsr').classList.remove('hidden');
    document.getElementById('onlineMonitor').classList.remove('hidden');
  }

  // Cargar datos
  loadData();

  // Heartbeat Loop (Cada 20s verifica sesión)
  setInterval(heartbeat, 20000);
}

// 2. SINCRONIZACIÓN Y HEARTBEAT
async function loadData() {
  try {
    const res = await fetch(API_URL);
    const json = await res.json();
    if(json.status === 'success') {
      // Mapeamos cobertura y agregamos índice original
      DB.cob = json.data.map((row, idx) => ({
        i: idx, m: row[0], n: row[1], c: row[2], z: row[3], r: row[4], s: row[5]
      }));
      DB.users = json.users;
      DB.history = json.history;
      DB.online = json.online;

      updateOnlineCounter();
      renderTable(); // Si se estaba buscando algo, se refresca
    }
  } catch(e) { console.error("Error sync", e); }
}

async function heartbeat() {
  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'heartbeat', u: SESION.u, t: SESION.t })
    });
    const json = await res.json();

    if(json.status === 'force_logout') {
      alert("⚠️ Tu sesión ha sido cerrada porque se detectó un ingreso en otro dispositivo.");
      logout();
    } else {
      loadData(); // Aprovechamos para actualizar datos
    }
  } catch(e) { console.log("Offline?"); }
}

// 3. IA LIGERA: BÚSQUEDA FUZZY (LEVENSHTEIN)
function levenshtein(a, b) {
  const matrix = [];
  for(let i=0; i<=b.length; i++) matrix[i] = [i];
  for(let j=0; j<=a.length; j++) matrix[0][j] = j;

  for(let i=1; i<=b.length; i++){
    for(let j=1; j<=a.length; j++){
      if(b.charAt(i-1) == a.charAt(j-1)) matrix[i][j] = matrix[i-1][j-1];
      else matrix[i][j] = Math.min(matrix[i-1][j-1] + 1, Math.min(matrix[i][j-1] + 1, matrix[i-1][j] + 1));
    }
  }
  return matrix[b.length][a.length];
}

function getSearchScore(item, query) {
  // Concatena todos los campos clave
  const text = `${item.m} ${item.n} ${item.z} ${item.r}`.toLowerCase();
  const q = query.toLowerCase();

  // 1. Coincidencia exacta o parcial fuerte
  if(text.includes(q)) return 100;

  // 2. Proximidad (Levenshtein)
  // Si la palabra query es corta (<3 chars), no hacemos fuzzy para evitar ruido
  if(q.length < 3) return 0;

  const words = text.split(" ");
  let maxScore = 0;

  words.forEach(w => {
    const dist = levenshtein(w, q);
    const len = Math.max(w.length, q.length);
    const similarity = 1 - (dist / len); // 0 a 1
    if(similarity > maxScore) maxScore = similarity;
  });

  return maxScore * 100; // Retorna 0 a 100
}

function renderTable(resetPage = false) {
  if(resetPage) PAGE = 1;
  const q = document.getElementById('searchBox').value.trim();
  let results = [];

  if(!q) {
    results = DB.cob;
  } else {
    // Filtrar y ordenar por score
    results = DB.cob.map(item => ({...item, score: getSearchScore(item, q)}))
                    .filter(item => item.score > 60) // Umbral de "inteligencia"
                    .sort((a, b) => b.score - a.score);
  }

  // Paginación
  const totalPages = Math.ceil(results.length / ROWS_PER_PAGE) || 1;
  if(PAGE > totalPages) PAGE = totalPages;
  document.getElementById('pageLabel').innerText = `${PAGE} / ${totalPages}`;

  const start = (PAGE - 1) * ROWS_PER_PAGE;
  const pageData = results.slice(start, start + ROWS_PER_PAGE);
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';

  const canEdit = (SESION.r === 'admin' || SESION.r === 'lider');

  pageData.forEach(row => {
    // Definir estilo según estado
    let badgeClass = 'bg-none';
    let colorHex = '#ccc';
    if(row.s === 'Cobertura') { badgeClass = 'bg-ok'; colorHex = '#28a745'; }
    else if(row.s === 'Sin Cobertura') { badgeClass = 'bg-no'; colorHex = '#dc3545'; }
    else if(row.s === 'Consultar') { badgeClass = 'bg-warn'; colorHex = '#ffc107'; }

    // Renderizar Estado
    let statusHtml = `<span class="badge ${badgeClass}">${row.s}</span>`;
    
    if(canEdit) {
      statusHtml = `
      <select id="st_${row.i}" class="status-select" style="border-color:${colorHex}; color:${row.s==='Consultar'?'#333':'white'}; background:${colorHex}" onchange="this.style.background = this.options[this.selectedIndex].style.background; this.style.color = this.options[this.selectedIndex].style.color;">
        <option value="Cobertura" style="background:#28a745; color:white" ${row.s==='Cobertura'?'selected':''}>Cobertura</option>
        <option value="Sin Cobertura" style="background:#dc3545; color:white" ${row.s==='Sin Cobertura'?'selected':''}>Sin Cobertura</option>
        <option value="Consultar" style="background:#ffc107; color:black" ${row.s==='Consultar'?'selected':''}>Consultar</option>
      </select>`;
    }

    // Renderizar Fila
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${canEdit ? `<input id="m_${row.i}" value="${row.m}" class="edit-field">` : row.m}</td>
      <td>${canEdit ? `<input id="n_${row.i}" value="${row.n}" class="edit-field" style="font-weight:bold">` : `<b>${row.n}</b>`}</td>
      <td>${canEdit ? `<input id="c_${row.i}" value="${row.c}" class="edit-field">` : row.c}</td>
      <td>${canEdit ? `<input id="z_${row.i}" value="${row.z}" class="edit-field">` : row.z}</td>
      <td>${canEdit ? `<input id="r_${row.i}" value="${row.r}" class="edit-field">` : row.r}</td>
      <td>${statusHtml}</td>
      <td class="col-action ${canEdit ? '' : 'hidden'}">
        <button onclick="saveLocation('edit', ${row.i})" class="btn btn-p" style="padding:5px 8px" title="Guardar cambios"><i class="fa-solid fa-save"></i></button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// 4. GESTIÓN DE USUARIOS
function renderUserList() {
  const q = document.getElementById('searchUserBox').value.toLowerCase();
  const filtered = DB.users.filter(u => u.u.toLowerCase().includes(q));
  
  // Paginación Usuarios
  const totalP = Math.ceil(filtered.length / ROWS_PER_PAGE) || 1;
  if(USER_PAGE > totalP) USER_PAGE = totalP;
  document.getElementById('userPageLabel').innerText = `${USER_PAGE} / ${totalP}`;

  const start = (USER_PAGE - 1) * ROWS_PER_PAGE;
  const pageUsers = filtered.slice(start, start + ROWS_PER_PAGE);
  const container = document.getElementById('userListContainer');
  container.innerHTML = '';

  pageUsers.forEach(u => {
    const isOnline = DB.online.includes(u.u);
    container.innerHTML += `
      <div class="user-item">
        <div>
          <div style="font-weight:bold; display:flex; align-items:center;">
            ${u.u} 
            ${isOnline ? '<span class="online-badge">ONLINE</span>' : ''}
          </div>
          <div style="font-size:11px; color:#777">Rol: ${u.r}</div>
        </div>
        <div>
          <button onclick="editUser('${u.u}', '${u.p}', '${u.r}')" class="btn btn-p" style="padding:4px 8px"><i class="fa-solid fa-pencil"></i></button>
          <button onclick="sendUserReq('del', '${u.u}')" class="btn btn-d" style="padding:4px 8px"><i class="fa-solid fa-trash"></i></button>
        </div>
      </div>
    `;
  });
}

function submitUser() {
  const u = document.getElementById('uUser').value;
  const p = document.getElementById('uPass').value;
  const r = document.getElementById('uRol').value;
  if(!u || !p) return alert("Complete todos los campos");

  const type = EDITING_USER ? 'edit' : 'add';
  sendUserReq(type, u, p, r);
}

async function sendUserReq(type, u, p=null, r=null) {
  if(type === 'del' && !confirm(`¿Eliminar usuario ${u}?`)) return;

  const body = { action: 'manageUser', type, u, p, r, userLog: SESION.u };
  
  // Feedback visual rápido
  const btn = document.getElementById('btnUserAction');
  const orgHtml = btn.innerHTML;
  btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';

  try {
    const res = await fetch(API_URL, {method:'POST', body:JSON.stringify(body)});
    const json = await res.json();
    if(json.status === 'ok') {
      clearUserForm();
      // Recargar datos para ver reflejado en lista
      await loadData();
      renderUserList();
      alert("Operación exitosa");
    } else {
      alert("Error: " + json.msg);
    }
  } catch(e) { alert("Error de red"); }
  
  btn.innerHTML = orgHtml;
}

function editUser(u, p, r) {
  EDITING_USER = true;
  document.getElementById('uUser').value = u;
  document.getElementById('uUser').disabled = true; // No se edita el ID (usuario)
  document.getElementById('uPass').value = p;
  document.getElementById('uRol').value = r;
  
  const btn = document.getElementById('btnUserAction');
  btn.className = 'btn btn-p'; // Azul para update
  btn.innerHTML = '<i class="fa-solid fa-check"></i>';
}

function clearUserForm() {
  EDITING_USER = false;
  document.getElementById('uUser').value = '';
  document.getElementById('uUser').disabled = false;
  document.getElementById('uPass').value = '';
  document.getElementById('btnUserAction').className = 'btn btn-s'; // Verde para add
  document.getElementById('btnUserAction').innerHTML = '<i class="fa-solid fa-plus"></i>';
}

// 5. GUARDAR / EDITAR COBERTURA
async function saveLocation(type, idx = null) {
  const data = { action: 'saveCob', type, userLog: SESION.u };

  if(type === 'new') {
    data.m = document.getElementById('newMun').value;
    data.n = document.getElementById('newNom').value;
    data.c = document.getElementById('newCat').value;
    data.z = document.getElementById('newZon').value;
    data.r = document.getElementById('newRef').value;
    data.cob = document.getElementById('newCob').value;
    if(!data.m || !data.n) return alert("Municipio y Nombre son obligatorios");
  } else {
    data.idx = idx;
    data.m = document.getElementById(`m_${idx}`).value;
    data.n = document.getElementById(`n_${idx}`).value;
    data.c = document.getElementById(`c_${idx}`).value;
    data.z = document.getElementById(`z_${idx}`).value;
    data.r = document.getElementById(`r_${idx}`).value;
    data.cob = document.getElementById(`st_${idx}`).value;
  }

  // Enviar
  await fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify(data)});
  
  if(type === 'new') closeModal('modalAdd');
  alert("Guardado correctamente");
  loadData();
}

// UTILIDADES VARIAS
function changePage(d) { PAGE += d; renderTable(); }
function changeUserPage(d) { USER_PAGE += d; renderUserList(); }
function updateOnlineCounter() {
  const c = DB.online.length;
  document.getElementById('onlineCount').innerText = c;
}

function openModal(id) { 
  document.getElementById(id).classList.remove('hidden');
  if(id === 'modalUsr') renderUserList();
}
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
function openUsers() { openModal('modalUsr'); }
function openHistorial() {
  openModal('modalHis');
  const tb = document.getElementById('tableHistory');
  tb.innerHTML = `<thead><tr><th>Fecha</th><th>Usuario</th><th>Acción</th><th>Detalle</th></tr></thead>` +
    DB.history.map(h => {
      return `<tr><td>${new Date(h[0]).toLocaleString()}</td><td>${h[1]}</td><td>${h[2]}</td><td>${h[3]}</td></tr>`;
    }).join('');
}
function logout() {
  localStorage.removeItem('distelsa_session_v5');
  location.reload();
}
function exportToExcel() {
  const ws = XLSX.utils.json_to_sheet(DB.cob);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Cobertura Distelsa");
  XLSX.writeFile(wb, "Reporte_Cobertura.xlsx");
}
</script>
</body>
</html>
