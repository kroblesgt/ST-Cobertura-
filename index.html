<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA DE COBERTURA | DISTELSA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { 
            --primary: #0054a6; --success: #00b050; --danger: #c00000; 
            --warning: #f1c40f; --dark: #2c3e50; 
        }
        body { font-family: 'Segoe UI', sans-serif; background:#f0f2f5; margin:0; }

        /* --- DESTELLO AZUL --- */
        @keyframes destello {
            0% { background-color: white; box-shadow: 0 0 0px rgba(0, 84, 166, 0); }
            50% { background-color: #eef7ff; box-shadow: inset 0 0 15px rgba(0, 84, 166, 0.3); }
            100% { background-color: #f8fbff; box-shadow: inset 0 0 5px rgba(0, 84, 166, 0.1); }
        }
        .mejor-coincidencia { animation: destello 1.5s infinite alternate ease-in-out; border-left: 6px solid var(--primary) !important; }

        .header { background: white; padding: 10px 40px; border-bottom: 5px solid var(--primary); display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header img { height: 70px; }

        .container { max-width: 98%; margin: 20px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }

        /* BUSCADOR CON ESCOBITA */
        .search-wrapper { position: relative; flex-grow: 1; display: flex; align-items: center; }
        .search-wrapper i.fa-magnifying-glass { position: absolute; left: 15px; color: #999; }
        #buscar { width: 100%; padding: 12px 45px; border-radius: 8px; border: 2px solid #ddd; font-size: 15px; outline: none; }
        #buscar:focus { border-color: var(--primary); }
        .btn-clear { position: absolute; right: 10px; background: none; border: none; color: #999; cursor: pointer; font-size: 18px; transition: 0.2s; }
        .btn-clear:hover { color: var(--danger); }

        /* BOTONES LATERALES */
        .actions-panel { display: flex; flex-direction: column; gap: 8px; min-width: 180px; }
        .btn { padding: 10px 15px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; font-size: 12px; justify-content: center; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-admin { background: var(--warning); color: #222; }

        .table-wrapper { overflow-x: auto; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--primary); color: white; padding: 12px; text-align: left; font-size: 12px; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 13px; }

        .badge { padding: 6px; border-radius: 15px; color: white; font-weight: bold; font-size: 10px; width: 100%; border: none; text-align: center; cursor: pointer; }
        .bg-verde { background: var(--success); } .bg-rojo { background: var(--danger); } 
        .bg-amarillo { background: var(--warning); color: black; } .bg-gris { background: #95a5a6; }

        #toast { position: fixed; bottom: 20px; right: 20px; background: var(--dark); color: white; padding: 12px 20px; border-radius: 8px; display: none; z-index: 3000; }
    </style>
</head>
<body>

<div id="toast"></div>

<header class="header">
    <img src="https://drive.google.com/thumbnail?id=1bawJf9oARBLy2itsOfA9YE8RVAFNdNef" alt="Logo">
    <div style="text-align:center;">
        <h2 style="margin:0; color:var(--primary); font-size: 1.2rem;">SISTEMA DE COBERTURA</h2>
        <small id="lastSync">Cargando...</small>
    </div>
    <button onclick="cerrarSesion()" id="logoutBtn" class="btn btn-primary hidden" style="background:var(--dark)"><i class="fa-solid fa-power-off"></i> SALIR</button>
</header>

<div class="container">
    <div id="loginPanel" style="max-width: 350px; margin: 40px auto; text-align: center;">
        <h3>Ingreso de Usuario</h3>
        <input id="userInput" type="text" placeholder="Usuario" style="width:100%; padding:12px; margin-bottom:10px; border-radius:6px; border:1px solid #ccc;">
        <input id="passInput" type="password" placeholder="Contraseña" style="width:100%; padding:12px; margin-bottom:20px; border-radius:6px; border:1px solid #ccc;">
        <button id="btnLogin" onclick="login()" disabled class="btn btn-primary" style="width:100%">CONECTANDO...</button>
    </div>

    <div id="appPanel" class="hidden">
        <div style="display:flex; gap:15px; align-items: flex-start; flex-wrap: wrap;">
            
            <div class="search-wrapper">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input id="buscar" placeholder="Ej: Milagrw, Mixco, Zona 6..." oninput="render()">
                <button class="btn-clear" onclick="limpiarBuscador()"><i class="fa-solid fa-broom"></i></button>
            </div>

            <div class="actions-panel">
                <button id="btnNuevaDir" onclick="abrirModalDir()" class="btn btn-success hidden"><i class="fa-solid fa-location-dot"></i> + NUEVA COBERTURA</button>
                <button id="btnAdmin" onclick="abrirModalAdmin()" class="btn btn-admin hidden"><i class="fa-solid fa-users-gear"></i> GESTIÓN USUARIOS</button>
            </div>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th style="width:15%">Municipio</th>
                        <th style="width:20%">Nombre</th>
                        <th style="width:10%">Cat.</th>
                        <th style="width:5%">Zona</th>
                        <th>Referencia</th>
                        <th style="width:15%">Estado</th>
                    </tr>
                </thead>
                <tbody id="cuerpo"></tbody>
            </table>
        </div>

        <div style="display:flex; justify-content:center; gap:20px; margin-top:15px; align-items:center;">
            <button id="btnAnt" class="btn btn-primary" onclick="cambiarPag(-1)"><i class="fa-solid fa-chevron-left"></i></button>
            <span id="pagTxt">Página 1</span>
            <button id="btnSig" class="btn btn-primary" onclick="cambiarPag(1)"><i class="fa-solid fa-chevron-right"></i></button>
        </div>
    </div>
</div>

<div id="modalDir" class="modal hidden">
    <div class="modal-content">
        <h3 style="margin-top:0">Nueva Cobertura</h3>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <input id="addMuni" type="text" placeholder="Municipio">
            <input id="addNom" type="text" placeholder="Nombre">
            <select id="addCat">
                <option>COLONIA</option><option>ALDEA</option><option>CIUDAD</option><option>CASERIO</option>
            </select>
            <input id="addZona" type="text" placeholder="Zona">
            <textarea id="addRef" placeholder="Referencia" style="height:60px"></textarea>
            <select id="addEst">
                <option>Sin Datos</option><option>Cobertura</option><option>Sin Cobertura</option>
            </select>
            <button onclick="guardarNuevaDireccion()" class="btn btn-success">GUARDAR</button>
            <button onclick="cerrarModalDir()" class="btn btn-primary" style="background:#666">CERRAR</button>
        </div>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbwxArEj1IaeXjR7b9raMrXtDnDjIq0HH6eGmT_wxoR1QEhJ5cN--pARkOIFJe39aqY16g/exec";
    let MASTER = [], USUARIOS = [], ROL = "", pag = 1;

    // FUZZY SEARCH (Mejorado)
    function similitud(s1, s2) {
        let longer = s1.length < s2.length ? s2 : s1;
        let shorter = s1.length < s2.length ? s1 : s2;
        if (longer.length === 0) return 1.0;
        return (longer.length - editDistance(longer, shorter)) / parseFloat(longer.length);
    }
    function editDistance(s1, s2) {
        s1 = s1.toLowerCase(); s2 = s2.toLowerCase();
        let costs = [];
        for (let i = 0; i <= s1.length; i++) {
            let lastValue = i;
            for (let j = 0; j <= s2.length; j++) {
                if (i == 0) costs[j] = j;
                else if (j > 0) {
                    let newValue = costs[j - 1];
                    if (s1.charAt(i - 1) != s2.charAt(j - 1))
                        newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                    costs[j - 1] = lastValue; lastValue = newValue;
                }
            }
            if (i > 0) costs[s2.length] = lastValue;
        }
        return costs[s2.length];
    }

    async function cargarDatos() {
        try {
            const res = await fetch(API);
            const data = await res.json();
            USUARIOS = data.usuarios.slice(1).map(r => ({ u: String(r[0]).trim().toLowerCase(), p: String(r[1]).trim(), r: String(r[2]).trim().toLowerCase() }));
            MASTER = data.cobertura.slice(1).map((r, i) => ({ 
                fila: i + 2, m: r[0], n: r[1], cat: r[2], z: r[3], ref: r[4] || "", cob: r[5] || "Sin Datos" 
            }));
            document.getElementById("lastSync").innerText = "Sincronizado: " + new Date().toLocaleTimeString();
            document.getElementById("btnLogin").innerText = "INGRESAR";
            document.getElementById("btnLogin").disabled = false;
            
            const session = JSON.parse(localStorage.getItem("distelsa_session"));
            if (session) {
                document.getElementById("userInput").value = session.u;
                document.getElementById("passInput").value = session.p;
                login();
            }
        } catch (e) { console.error(e); }
    }

    function login() {
        const u = document.getElementById("userInput").value.trim().toLowerCase();
        const p = document.getElementById("passInput").value.trim();
        const user = USUARIOS.find(x => x.u === u && x.p === p);
        if(user) {
            ROL = user.r;
            localStorage.setItem("distelsa_session", JSON.stringify({ u, p }));
            document.getElementById("loginPanel").classList.add("hidden");
            document.getElementById("appPanel").classList.remove("hidden");
            document.getElementById("logoutBtn").classList.remove("hidden");
            
            if(ROL === 'admin' || ROL === 'lider') {
                document.getElementById("btnNuevaDir").classList.remove("hidden");
            }
            if(ROL === 'admin') {
                document.getElementById("btnAdmin").classList.remove("hidden");
            }
            render();
        } else { alert("Credenciales incorrectas"); }
    }

    function render() {
        const query = document.getElementById("buscar").value.toLowerCase().trim();
        let filtrados = [];

        if(query.length > 2) {
            filtrados = MASTER.map(r => {
                const terminos = `${r.m} ${r.n} ${r.cat} ${r.z}`.toLowerCase().split(/\s+/);
                const score = Math.max(...terminos.map(t => similitud(t, query)));
                return { ...r, score };
            }).filter(r => r.score > 0.65).sort((a, b) => b.score - a.score);
        } else {
            filtrados = MASTER;
        }

        const segment = filtrados.slice((pag - 1) * 10, pag * 10);
        let html = "";
        segment.forEach((r, idx) => {
            let col = r.cob=="Cobertura"?"bg-verde":r.cob=="Sin Cobertura"?"bg-rojo":r.cob=="Consultar"?"bg-amarillo":"bg-gris";
            let destello = (query.length > 2 && idx === 0 && pag === 1) ? "mejor-coincidencia" : "";
            let editable = (ROL === 'admin' || ROL === 'lider');

            let stHTML = editable ? `<select class="badge ${col}" onchange="guardarEstado(${r.fila}, this.value)">
                <option value="Sin Datos" ${r.cob=='Sin Datos'?'selected':''}>Sin Datos</option>
                <option value="Cobertura" ${r.cob=='Cobertura'?'selected':''}>Cobertura</option>
                <option value="Sin Cobertura" ${r.cob=='Sin Cobertura'?'selected':''}>Sin Cobertura</option>
            </select>` : `<span class="badge ${col}">${r.cob}</span>`;

            html += `<tr class="${destello}"><td>${r.m}</td><td style="font-weight:bold">${r.n}</td><td>${r.cat}</td><td>${r.z}</td><td style="font-size:11px">${r.ref}</td><td>${stHTML}</td></tr>`;
        });
        document.getElementById("cuerpo").innerHTML = html;
        document.getElementById("pagTxt").innerText = `Página ${pag} de ${Math.ceil(filtrados.length/10) || 1}`;
    }

    function limpiarBuscador() {
        document.getElementById("buscar").value = "";
        render();
    }

    async function guardarEstado(fila, val) {
        showToast("Sincronizando...");
        await fetch(`${API}?action=updateCob&fila=${fila}&valor=${encodeURIComponent(val)}`, { method: 'POST', mode: 'no-cors' });
        showToast("✓ Guardado");
    }

    async function guardarNuevaDireccion() {
        const p = `?action=addAddress&muni=${encodeURIComponent(document.getElementById("addMuni").value)}&nom=${encodeURIComponent(document.getElementById("addNom").value)}&cat=${encodeURIComponent(document.getElementById("addCat").value)}&zona=${encodeURIComponent(document.getElementById("addZona").value)}&ref=${encodeURIComponent(document.getElementById("addRef").value)}&est=${encodeURIComponent(document.getElementById("addEst").value)}`;
        await fetch(API + p, { method: 'POST', mode: 'no-cors' });
        cerrarModalDir();
        showToast("✓ Agregado");
        setTimeout(cargarDatos, 1500);
    }

    function showToast(m) { const t = document.getElementById("toast"); t.innerText = m; t.style.display = "block"; setTimeout(()=>t.style.display="none", 2500); }
    function abrirModalDir() { document.getElementById("modalDir").classList.remove("hidden"); }
    function cerrarModalDir() { document.getElementById("modalDir").classList.add("hidden"); }
    function cambiarPag(v) { pag += v; render(); }
    function cerrarSesion() { localStorage.removeItem("distelsa_session"); location.reload(); }
    window.onload = cargarDatos;
</script>
</body>
</html>
