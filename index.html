<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA DISTELSA | 6 COLUMNAS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --primary: #0054a6; --success: #00b050; --danger: #c00000; --warning: #f1c40f; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', sans-serif; background:#f4f7f9; margin:0; }
        
        /* Ajuste de Contenedor para máximo ancho */
        .container { width: 98%; max-width: 1600px; margin: 20px auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* FUERZA LAS 6 COLUMNAS */
        table { width: 100%; border-collapse: collapse; table-layout: auto; }
        th { background: var(--primary); color: white; padding: 12px 8px; text-align: left; font-size: 13px; white-space: nowrap; }
        
        td { 
            padding: 10px 8px; 
            border-bottom: 1px solid #eee; 
            font-size: 13px; 
            color: #333;
            /* Ajuste de línea para textos largos */
            word-wrap: break-word; 
            overflow-wrap: break-word; 
            white-space: normal !important; 
        }

        /* Estilos de Insignias (Estado) */
        .badge { padding: 6px 8px; border-radius: 4px; color: white; font-weight: bold; font-size: 11px; width: 100%; border: none; cursor: pointer; text-align: center; }
        .bg-verde { background: var(--success); } 
        .bg-rojo { background: var(--danger); } 
        .bg-amarillo { background: var(--warning); color: black; } 
        .bg-gris { background: #bdc3c7; color: #fff; }

        .header { background: white; padding: 5px 20px; border-bottom: 4px solid var(--primary); display: flex; align-items: center; justify-content: space-between; }
        .header img { height: 60px; }
        .hidden { display: none !important; }
        input#buscar { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
    </style>
</head>
<body>

<header class="header">
    <img src="https://drive.google.com/thumbnail?id=1bawJf9oARBLy2itsOfA9YE8RVAFNdNef" alt="Logo">
    <h3 style="color:var(--primary);">CONTROL DE COBERTURA</h3>
    <button onclick="cerrarSesion()" id="logoutBtn" class="hidden" style="padding:8px 15px; cursor:pointer;">SALIR</button>
</header>

<div class="container">
    <div id="loginPanel" style="max-width:300px; margin: 40px auto; text-align:center;">
        <input id="userInput" type="text" placeholder="Usuario" style="width:100%; padding:10px; margin-bottom:10px;">
        <input id="passInput" type="password" placeholder="Contraseña" style="width:100%; padding:10px; margin-bottom:10px;">
        <button id="btnLogin" onclick="login()" disabled style="width:100%; padding:10px; background:var(--primary); color:white; border:none;">CARGANDO...</button>
    </div>

    <div id="appPanel" class="hidden">
        <input id="buscar" type="text" placeholder="Buscar por municipio, nombre, categoría, zona o referencia..." oninput="render()">
        
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th style="width:12%">Municipio</th>
                        <th style="width:18%">Nombre</th>
                        <th style="width:12%">Categoría</th>
                        <th style="width:8%">Zona</th>
                        <th style="width:35%">Referencia</th>
                        <th style="width:15%">Estado</th>
                    </tr>
                </thead>
                <tbody id="cuerpo"></tbody>
            </table>
        </div>

        <div style="display:flex; justify-content:center; gap:20px; margin-top:15px;">
            <button onclick="cambiarPag(-1)" id="btnAnt">Anterior</button>
            <span id="pagTxt">Página 1</span>
            <button onclick="cambiarPag(1)" id="btnSig">Siguiente</button>
        </div>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbyDdFUGrMnZfmoAkiGgMBIPLhcEd18o5H11KQTAyPjN0xav0kNUV5ka-FeYbhsOf5pxsA/exec";
    let MASTER = [], USUARIOS = [], ROL = "", pag = 1;

    async function cargarDatos() {
        try {
            const res = await fetch(API);
            const data = await res.json();
            USUARIOS = data.usuarios.slice(1).map(r => ({ u: String(r[0]), p: String(r[1]), r: String(r[2]) }));
            
            // MAPEO DE LAS 6 COLUMNAS (A, B, C, D, E, F)
            MASTER = data.cobertura.slice(1).map((r, i) => ({ 
                fila: i + 2, 
                m: r[0],   // Municipio
                n: r[1],   // Nombre
                cat: r[2], // Categoria
                z: r[3],   // Zona
                ref: r[4], // Referencia
                cob: r[5] || "Sin Datos" // Cobertura
            }));
            
            document.getElementById("btnLogin").innerText = "INGRESAR";
            document.getElementById("btnLogin").disabled = false;
            
            const session = JSON.parse(localStorage.getItem("distelsa_session"));
            if (session) {
                document.getElementById("userInput").value = session.u;
                document.getElementById("passInput").value = session.p;
                login();
            }
        } catch (e) { console.error(e); }
    }

    function login() {
        const u = document.getElementById("userInput").value.trim().toLowerCase();
        const p = document.getElementById("passInput").value.trim();
        const user = USUARIOS.find(x => x.u.toLowerCase() === u && x.p === p);
        if(user) {
            ROL = user.r.toLowerCase();
            localStorage.setItem("distelsa_session", JSON.stringify({ u: u, p: p }));
            document.getElementById("loginPanel").classList.add("hidden");
            document.getElementById("appPanel").classList.remove("hidden");
            document.getElementById("logoutBtn").classList.remove("hidden");
            render();
        } else { alert("Usuario o clave incorrecta"); }
    }

    function render() {
        const q = document.getElementById("buscar").value.toLowerCase().trim();
        let filtrados = MASTER.filter(r => {
            const texto = `${r.m} ${r.n} ${r.cat} ${r.z} ${r.ref}`.toLowerCase();
            return texto.includes(q);
        });

        const totalPags = Math.ceil(filtrados.length / 10) || 1;
        const segment = filtrados.slice((pag - 1) * 10, pag * 10);
        
        let html = "";
        segment.forEach(r => {
            let col = r.cob=="Cobertura"?"bg-verde":r.cob=="Sin Cobertura"?"bg-rojo":r.cob=="Consultar"?"bg-amarillo":"bg-gris";
            let editable = (ROL === 'admin' || ROL === 'lider');
            
            let selector = editable ? 
                `<select class="badge ${col}" onchange="guardarEstado(${r.fila}, this.value)">
                    <option value="Sin Datos" ${r.cob=='Sin Datos'?'selected':''}>SIN DATOS</option>
                    <option value="Cobertura" ${r.cob=='Cobertura'?'selected':''}>COBERTURA</option>
                    <option value="Sin Cobertura" ${r.cob=='Sin Cobertura'?'selected':''}>SIN COBERTURA</option>
                    <option value="Consultar" ${r.cob=='Consultar'?'selected':''}>CONSULTAR</option>
                </select>` : `<span class="badge ${col}">${r.cob}</span>`;
            
            html += `<tr>
                <td>${r.m}</td>
                <td style="font-weight:bold">${r.n}</td>
                <td>${r.cat}</td>
                <td>${r.z}</td>
                <td>${r.ref}</td>
                <td>${selector}</td>
            </tr>`;
        });

        document.getElementById("cuerpo").innerHTML = html;
        document.getElementById("pagTxt").innerText = `Página ${pag} de ${totalPags}`;
        document.getElementById("btnAnt").disabled = pag === 1;
        document.getElementById("btnSig").disabled = pag >= totalPags;
    }

    async function guardarEstado(fila, val) {
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'updateCob', fila, valor: val }) });
        const item = MASTER.find(x => x.fila === fila);
        if(item) item.cob = val;
        render();
    }

    function cambiarPag(v) { pag += v; render(); }
    function cerrarSesion() { localStorage.removeItem("distelsa_session"); location.reload(); }
    window.onload = cargarDatos;
</script>
</body>
</html>
