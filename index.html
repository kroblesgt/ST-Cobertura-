<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA DE COBERTURA | DISTELSA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { 
            --primary: #0054a6; --success: #00b050; --danger: #c00000; 
            --warning: #f1c40f; --dark: #2c3e50; --light-grey: #dcdcdc; 
        }
        body { font-family: 'Segoe UI', sans-serif; background:#f0f2f5; margin:0; }
        
        /* --- DIFERENCIA VISUAL: RESALTADO FUERTE --- */
        .row-focus { 
            background-color: #e3f2fd !important; /* Azul suave de fondo */
            border-left: 10px solid var(--primary) !important; /* Barra lateral gruesa */
            transform: scale(1.01); 
            box-shadow: 0 4px 20px rgba(0,84,166,0.25);
        }
        .row-focus td { color: var(--primary) !important; font-weight: bold; }

        .header { background: white; padding: 10px 40px; border-bottom: 5px solid var(--primary); display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header img { height: 100px; width: auto; }
        .container { max-width: 1250px; margin: 30px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .hidden { display: none !important; }
        
        .btn { padding: 12px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; color: white; display: inline-flex; align-items: center; gap: 10px; }
        .btn-exit-top { background: var(--dark); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: var(--primary); color: white; padding: 15px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; transition: all 0.2s ease; }
        
        .badge { padding: 8px 15px; border-radius: 20px; color: white; font-weight: bold; font-size: 12px; text-transform: uppercase; min-width: 110px; text-align: center; display: inline-block; border: none; }
        .bg-verde { background: var(--success); } .bg-rojo { background: var(--danger); } 
        .bg-amarillo { background: var(--warning); color: black; } .bg-gris { background: var(--light-grey); color: #666; }

        #toast { position: fixed; bottom: 20px; right: 20px; background: var(--dark); color: white; padding: 15px 25px; border-radius: 8px; display: none; z-index: 3000; }
        .sync-indicator { font-size: 11px; color: var(--success); font-weight: bold; }
    </style>
</head>
<body>

<div id="toast"></div>

<header class="header">
    <img src="https://drive.google.com/thumbnail?id=1bawJf9oARBLy2itsOfA9YE8RVAFNdNef" alt="Logo">
    <div style="text-align: center;">
        <h1 style="margin:0; color:var(--primary);">SISTEMA DE COBERTURA</h1>
        <div id="syncStatus" class="sync-indicator">‚óè SISTEMA CONECTADO</div>
    </div>
    <button onclick="location.reload()" id="logoutBtn" class="btn-exit-top hidden"><i class="fa-solid fa-power-off"></i> CERRAR SESI√ìN</button>
</header>

<div class="container">
    <div id="loginPanel" style="max-width: 400px; margin: 60px auto; text-align: center;">
        <h2 style="color:var(--primary)">Acceso de Agentes</h2>
        <input id="userInput" type="text" placeholder="Nombre de Usuario" style="width:100%; padding:14px; margin-bottom:15px; border-radius:8px; border:1px solid #ddd;">
        <input id="passInput" type="password" placeholder="Contrase√±a" style="width:100%; padding:14px; margin-bottom:20px; border-radius:8px; border:1px solid #ddd;">
        <button id="btnLogin" onclick="login()" disabled class="btn" style="background:var(--primary); width:100%; justify-content:center;">SINCRONIZANDO...</button>
    </div>

    <div id="appPanel" class="hidden">
        <div style="display:flex; gap:15px; margin-bottom:25px;">
            <input id="buscar" style="flex-grow:1; padding:15px; border-radius:10px; border:2px solid #e0e0e0; font-size: 16px;" placeholder="üîç Escriba aqu√≠ (Ej: milago z 6 mixco...)" oninput="render()">
        </div>
        <table>
            <thead><tr><th>Municipio</th><th>Nombre / Referencia</th><th>Zona</th><th>Estado</th></tr></thead>
            <tbody id="cuerpo"></tbody>
        </table>
        <div style="display:flex; justify-content:center; gap:20px; margin-top:20px;">
            <button id="btnAnt" class="btn" style="background:var(--primary);" onclick="cambiarPag(-1)">ANTERIOR</button>
            <span id="pagTxt" style="font-weight:bold; padding-top:10px;">P√°gina 1</span>
            <button id="btnSig" class="btn" style="background:var(--primary);" onclick="cambiarPag(1)">SIGUIENTE</button>
        </div>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbx4GK4eRKjRXD5AqukR-lpjo_1jloeSjKlk7GYpihbYlo8YwRAEUwaj6TbUUDg0aODEOg/exec";
    let MASTER = [], USUARIOS = [], ROL = "", pag = 1;

    // --- DICCIONARIO PARA VELOCIDAD DE AGENTE ---
    const ABREVIATURAS = { 
        "z": "zona", "zn": "zona", "z.": "zona", 
        "col": "colonia", "muni": "municipio", 
        "gt": "guatemala", "mix": "mixco", 
        "vn": "villa nueva", "vc": "villa canales" 
    };

    async function cargarDatos() {
        try {
            const res = await fetch(API);
            const data = await res.json();
            USUARIOS = data.usuarios.slice(1).map(r => ({ u: String(r[0]), p: String(r[1]), r: String(r[2]) }));
            MASTER = data.cobertura.slice(1).map((r, i) => ({ fila: i+2, m: r[0], n: r[1], z: r[3], cob: r[5] || "Sin Datos" }));
            document.getElementById("btnLogin").innerText = "INGRESAR";
            document.getElementById("btnLogin").disabled = false;
            if(document.getElementById("appPanel").offsetParent !== null) render();
        } catch (e) { document.getElementById("syncStatus").innerText = "‚óè RECONECTANDO..."; }
    }

    window.onload = () => { cargarDatos(); setInterval(() => cargarDatos(), 30000); };

    function login() {
        const u = document.getElementById("userInput").value.trim().toLowerCase();
        const p = document.getElementById("passInput").value.trim();
        const user = USUARIOS.find(x => x.u.toLowerCase() === u && x.p === p);
        if(user) {
            ROL = user.r.toLowerCase();
            document.getElementById("loginPanel").classList.add("hidden");
            document.getElementById("appPanel").classList.remove("hidden");
            document.getElementById("logoutBtn").classList.remove("hidden");
            render();
        } else { alert("Usuario o Contrase√±a incorrectos."); }
    }

    // --- BUSCADOR INTELIGENTE Y PLUS VISUAL ---
    function render() {
        const q = document.getElementById("buscar").value.toLowerCase().trim();
        let filtrados = [];

        if (q === "") {
            filtrados = MASTER;
        } else {
            // Traducir abreviaturas (z -> zona)
            let palabrasBusqueda = q.split(/\s+/).map(p => ABREVIATURAS[p] || p);
            
            filtrados = MASTER.map(r => {
                const textoFila = `${r.m} ${r.n} ${r.z}`.toLowerCase();
                let score = 0;
                palabrasBusqueda.forEach(p => {
                    if (textoFila.includes(p)) score += 10;
                    else if (p.length > 3 && esSimilar(p, textoFila)) score += 5;
                });
                return { ...r, score };
            }).filter(r => r.score > 0).sort((a, b) => b.score - a.score);
        }

        const totalPags = Math.ceil(filtrados.length / 10) || 1;
        const segment = filtrados.slice((pag-1)*10, pag*10);
        let html = "";
        
        // CONDICI√ìN DEL PLUS VISUAL: Si quedan 3 resultados o menos
        const esExito = (q !== "" && filtrados.length > 0 && filtrados.length <= 3);

        segment.forEach(r => {
            let col = r.cob=="Cobertura"?"bg-verde":r.cob=="Sin Cobertura"?"bg-rojo":r.cob=="Consultar"?"bg-amarillo":"bg-gris";
            
            html += `<tr class="${esExito ? 'row-focus' : ''}">
                <td>${r.m}</td>
                <td><b>${r.n}</b></td>
                <td>${r.z}</td>
                <td><span class="badge ${col}">${r.cob}</span></td>
            </tr>`;
        });

        document.getElementById("cuerpo").innerHTML = html;
        document.getElementById("pagTxt").innerText = `P√°gina ${pag} de ${totalPags}`;
        document.getElementById("btnAnt").disabled = pag === 1;
        document.getElementById("btnSig").disabled = pag >= totalPags;
    }

    // Compara letras para permitir errores de dedo
    function esSimilar(p, txt) {
        let coincidencias = 0;
        let pSet = new Set(p);
        for(let char of txt) { if(pSet.has(char)) coincidencias++; }
        return (coincidencias / p.length) > 0.85;
    }

    function cambiarPag(v) { pag += v; render(); }
</script>
</body>
</html>
