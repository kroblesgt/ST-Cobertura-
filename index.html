<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA DE COBERTURA</title>
    <style>
        :root { --primary: #0054a6; --success: #00b050; --danger: #c00000; --warning: #f1c40f; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', sans-serif; background:#f0f2f5; margin:0; color: #333; }
        
        /* Header con logos grandes */
        .header { background: white; padding: 15px 40px; border-bottom: 5px solid var(--primary); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header img { height: 50px; width: auto; object-fit: contain; }
        .header-title { text-align: center; }
        .header-title h1 { margin: 0; color: var(--primary); font-size: 28px; letter-spacing: 1px; }
        
        .container { max-width: 1200px; margin: 20px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .hidden { display: none !important; }

        /* Controles de b칰squeda y botones */
        .search-box { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        .btn { padding: 12px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-admin { background: var(--warning); color: #000; }
        .btn-exit { background: var(--dark); }
        .btn-save { background: var(--success); padding: 8px 15px; font-size: 12px; margin-left: 5px; }

        /* Tabla y visualizaci칩n */
        table { width: 100%; border-collapse: collapse; margin-top: 25px; }
        th { background: var(--primary); color: white; padding: 15px; text-align: left; font-size: 13px; text-transform: uppercase; }
        td { padding: 14px; border-bottom: 1px solid #eee; font-size: 15px; }
        .badge { padding: 6px 12px; border-radius: 20px; color: white; font-weight: bold; font-size: 11px; text-transform: uppercase; }
        .bg-verde { background: var(--success); }
        .bg-rojo { background: var(--danger); }
        .bg-amarillo { background: var(--warning); color: black; }

        /* Ventana Modal de Usuarios */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal-content { background: white; padding: 40px; border-radius: 20px; width: 500px; position: relative; }
        .close-btn { position: absolute; top: 20px; right: 20px; font-size: 28px; cursor: pointer; color: #999; }
        .form-user { display: flex; flex-direction: column; gap: 12px; background: #f9f9f9; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .form-user input, .form-user select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; }

        .pagination { display: flex; justify-content: center; gap: 20px; margin-top: 30px; align-items: center; font-weight: bold; }
    </style>
</head>
<body>

<header class="header">
    <img src="https://drive.google.com/thumbnail?id=1bawJf9oARBLy2itsOfA9YE8RVAFNdNef" alt="Logo">
    <div class="header-title">
        <h1>SISTEMA DE COBERTURA</h1>
        <small id="statText" style="color: var(--primary); font-weight: bold;">SINCRONIZANDO...</small>
    </div>
    <img src="https://drive.google.com/thumbnail?id=1zh0lISfhL33lIht-Iis1TtQBEeqahnJg" alt="Logo">
</header>

<div class="container">
    <div id="loginPanel" style="max-width: 400px; margin: 60px auto; text-align: center;">
        <h2 style="color:var(--primary)">Bienvenido</h2>
        <input id="userInput" type="text" placeholder="Usuario" style="width:100%; padding:14px; margin-bottom:15px; border:1px solid #ddd; border-radius:8px; box-sizing: border-box;">
        <input id="passInput" type="password" placeholder="Contrase침a" style="width:100%; padding:14px; margin-bottom:20px; border:1px solid #ddd; border-radius:8px; box-sizing: border-box;">
        <button id="btnLogin" onclick="login()" disabled class="btn" style="background:var(--primary); width:100%; justify-content: center;">CARGANDO...</button>
    </div>

    <div id="appPanel" class="hidden">
        <div style="display:flex; gap:15px; margin-bottom:25px;">
            <input id="buscar" class="search-box" placeholder="游댌 Buscar municipio, zona o nombre (ej: milagro zona 6)..." oninput="pag=1; render()">
            <button id="btnAdmin" onclick="abrirModal()" class="btn btn-admin hidden">USUARIOS</button>
            <button onclick="logout()" class="btn btn-exit">SALIR</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Municipio</th>
                    <th>Nombre / Referencia</th>
                    <th>Zona</th>
                    <th>Cobertura</th>
                </tr>
            </thead>
            <tbody id="cuerpo"></tbody>
        </table>

        <div class="pagination">
            <button id="btnAnt" class="btn" style="background:var(--primary)" onclick="cambiarPag(-1)">Anterior</button>
            <span id="pagTxt">P치gina 1</span>
            <button id="btnSig" class="btn" style="background:var(--primary)" onclick="cambiarPag(1)">Siguiente</button>
        </div>
    </div>
</div>

<div id="modalUser" class="modal hidden">
    <div class="modal-content">
        <span class="close-btn" onclick="cerrarModal()">&times;</span>
        <h2 style="color:var(--primary); margin-top:0;">Gesti칩n de Cuentas</h2>
        <div class="form-user">
            <input id="newU" type="text" placeholder="Nuevo Usuario">
            <input id="newP" type="text" placeholder="Contrase침a">
            <select id="newR">
                <option value="vendedor">Vendedor</option>
                <option value="lider">L칤der</option>
                <option value="admin">Administrador</option>
            </select>
            <button onclick="crearUsuario()" class="btn" style="background:var(--primary); justify-content: center;">AGREGAR</button>
        </div>
        <div id="listaU" style="max-height: 200px; overflow-y: auto; border-top: 1px solid #eee;"></div>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbx4GK4eRKjRXD5AqukR-lpjo_1jloeSjKlk7GYpihbYlo8YwRAEUwaj6TbUUDg0aODEOg/exec";
    let MASTER = [], USUARIOS = [], ROL = "", pag = 1;
    const limite = 10;

    window.onload = async () => {
        await cargarDatos();
        const cache = localStorage.getItem("sesion_master");
        if(cache) login(JSON.parse(cache));
    };

    async function cargarDatos() {
        try {
            const res = await fetch(API);
            const data = await res.json();
            USUARIOS = data.usuarios.slice(1).map(r => ({u: String(r[0]), p: String(r[1]), r: String(r[2])}));
            MASTER = data.cobertura.slice(1).map((r, i) => ({ fila: i+2, m: r[0], n: r[1], z: r[3], cob: r[5] || "Sin Cobertura" }));
            document.getElementById("btnLogin").innerText = "INGRESAR";
            document.getElementById("btnLogin").disabled = false;
            document.getElementById("statText").innerText = "SISTEMA ONLINE";
        } catch (e) { document.getElementById("statText").innerText = "ERROR DE CONEXI칍N"; }
    }

    function login(cached = null) {
        const u = cached ? cached.u : document.getElementById("userInput").value.trim().toLowerCase();
        const p = cached ? cached.p : document.getElementById("passInput").value.trim();
        const user = USUARIOS.find(x => x.u.toLowerCase() === u && x.p === p);

        if(user) {
            ROL = user.r.toLowerCase();
            localStorage.setItem("sesion_master", JSON.stringify(user));
            document.getElementById("loginPanel").classList.add("hidden");
            document.getElementById("appPanel").classList.remove("hidden");
            if(ROL === 'admin') document.getElementById("btnAdmin").classList.remove("hidden");
            render();
        } else if(!cached) alert("Credenciales incorrectas");
    }

    function render() {
        const query = document.getElementById("buscar").value.toLowerCase().split(" ");
        const filtrados = MASTER.filter(r => query.every(w => `${r.m} ${r.n} ${r.z}`.toLowerCase().includes(w)));
        const segment = filtrados.slice((pag-1)*limite, pag*limite);
        
        let html = "";
        segment.forEach(r => {
            const badge = r.cob.includes("Sin") ? "bg-rojo" : r.cob.includes("Consultar") ? "bg-amarillo" : "bg-verde";
            const canEdit = (ROL === 'admin' || ROL === 'lider');

            const colCob = canEdit ? 
                `<div><select id="s-${r.fila}"><option ${r.cob=='Cobertura'?'selected':''}>Cobertura</option><option ${r.cob=='Sin Cobertura'?'selected':''}>Sin Cobertura</option><option ${r.cob=='Consultar'?'selected':''}>Consultar</option></select><button class="btn btn-save" onclick="guardarEstado(${r.fila})">Guardar</button></div>` : 
                `<span class="badge ${badge}">${r.cob}</span>`;

            html += `<tr><td>${r.m}</td><td><b>${r.n}</b></td><td>${r.z}</td><td>${colCob}</td></tr>`;
        });
        document.getElementById("cuerpo").innerHTML = html;
        document.getElementById("pagTxt").innerText = `P치gina ${pag} de ${Math.ceil(filtrados.length/limite) || 1}`;
        document.getElementById("btnAnt").disabled = pag === 1;
        document.getElementById("btnSig").disabled = pag*limite >= filtrados.length;
    }

    async function guardarEstado(fila) {
        const val = document.getElementById(`s-${fila}`).value;
        document.getElementById("statText").innerText = "GUARDANDO...";
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'updateCob', fila, valor: val }) });
        const item = MASTER.find(x => x.fila === fila);
        if(item) item.cob = val;
        document.getElementById("statText").innerText = "SISTEMA ONLINE";
        render();
    }

    function abrirModal() { document.getElementById("modalUser").classList.remove("hidden"); listarU(); }
    function cerrarModal() { document.getElementById("modalUser").classList.add("hidden"); }

    function listarU() {
        let h = "<table style='width:100%; font-size:12px;'>";
        USUARIOS.forEach(u => h += `<tr><td>${u.u}</td><td>${u.r}</td><td><button onclick="delU('${u.u}')" style="color:red; border:none; background:none; cursor:pointer">Eliminar</button></td></tr>`);
        document.getElementById("listaU").innerHTML = h + "</table>";
    }

    async function crearUsuario() {
        const u = document.getElementById("newU").value;
        const p = document.getElementById("newP").value;
        const r = document.getElementById("newR").value;
        if(!u || !p) return;
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'addUser', usuario: u, clave: p, rol: r }) });
        USUARIOS.push({u, p, r});
        listarU();
    }

    async function delU(n) {
        if(!confirm(`쮼liminar a ${n}?`)) return;
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'delete', usuarioNombre: n }) });
        USUARIOS = USUARIOS.filter(x => x.u !== n);
        listarU();
    }

    function cambiarPag(v) { pag += v; render(); }
    function logout() { localStorage.removeItem("sesion_master"); location.reload(); }
</script>
</body>
</html>
