<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DISTELSA - Cobertura Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --p: #003399; --s: #28a745; --d: #dc3545; --w: #ffc107; --g: #7f8c8d; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; }
        .hidden { display: none !important; }
        
        header { background: white; border-bottom: 4px solid var(--p); padding: 10px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .logo { font-weight: 900; color: var(--p); font-size: 24px; letter-spacing: -1px; }

        .container { max-width: 1400px; margin: 20px auto; padding: 0 15px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

        .online-badge { background: #eef2ff; color: var(--p); padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: bold; border: 1px solid #cdd9f7; cursor: help; position: relative; }
        .online-list { display: none; position: absolute; top: 110%; right: 0; background: white; border: 1px solid #ddd; width: 180px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 100; border-radius: 6px; padding: 10px; }
        .online-badge:hover .online-list { display: block; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; background: #fff; }
        th { background: #f1f3f8; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; color: #333; }
        td { padding: 8px 12px; border-bottom: 1px solid #eee; }
        
        .btn { padding: 9px 18px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 13px; }
        .btn-p { background: var(--p); color: white; }
        .btn-s { background: var(--s); color: white; }
        .btn-d { background: var(--d); color: white; }

        /* Estados con alta visibilidad */
        .badge { padding: 6px 10px; border-radius: 5px; color: white !important; font-size: 12px; font-weight: 800; text-transform: uppercase; border: none; width: 100%; opacity: 1 !important; cursor: pointer; }
        .badge:disabled { cursor: default; -webkit-appearance: none; appearance: none; }
        .bg-cob { background: var(--s) !important; }
        .bg-nocob { background: var(--d) !important; }
        .bg-cons { background: var(--w) !important; color: #000 !important; }
        .bg-null { background: var(--g) !important; }
        
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 100%; box-sizing: border-box; }
        .search-bar { flex-grow: 1; border: 2px solid #ddd; font-size: 16px; border-radius: 8px; }

        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index: 1000; }
        .modal-box { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 600px; }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:15px;">
        <span class="logo">DISTELSA</span>
        <h2 style="margin:0; font-size:14px; color:#888;">COBERTURA 2026</h2>
    </div>
    <div id="navRight" class="hidden" style="display:flex; align-items:center; gap:20px;">
        <div class="online-badge" id="onlineWidget">
            <i class="fa-solid fa-signal" style="color:var(--s);"></i> <span id="onlineCount">0</span> Online
            <div id="onlineNames" class="online-list"></div>
        </div>
        <span id="userName" style="font-weight:700; color:var(--p);"></span>
        <button onclick="logout()" class="btn btn-d" style="padding:6px 10px;"><i class="fa-solid fa-power-off"></i></button>
    </div>
</header>

<div id="loginBox" class="container" style="max-width: 380px; margin-top: 15vh;">
    <div class="card" style="text-align: center; border-bottom: 6px solid var(--p);">
        <h3 style="color:var(--p); margin-bottom:20px;">Acceso Seguro</h3>
        <input type="text" id="user" placeholder="Usuario" style="margin-bottom:12px;">
        <input type="password" id="pass" placeholder="Contrase√±a" style="margin-bottom:25px;">
        <button onclick="login()" class="btn btn-p" style="width:100%; justify-content:center; height:45px;">INGRESAR AL PORTAL</button>
    </div>
</div>

<div id="app" class="container hidden">
    <div class="card">
        <div style="display:flex; justify-content:space-between; gap:12px; margin-bottom:20px; align-items:center;">
            <input type="text" id="search" class="search-bar" placeholder="üîç Buscar municipio o lugar..." onkeyup="pag=1; render()">
            <div style="display:flex; gap:8px;">
                <button id="btnAdd" onclick="toggleModal('modalAdd', true)" class="btn btn-s hidden"><i class="fa-solid fa-plus"></i> NUEVO</button>
                <button id="btnExcel" onclick="exportarExcel()" class="btn btn-p hidden" style="background:#1d6f42"><i class="fa-solid fa-file-excel"></i></button>
                <button id="btnHist" onclick="toggleModal('modalHist', true)" class="btn btn-p hidden"><i class="fa-solid fa-history"></i></button>
                <button id="btnUsers" onclick="toggleModal('modalUsers', true)" class="btn btn-p hidden" style="background:#555"><i class="fa-solid fa-users"></i></button>
            </div>
        </div>

        <div style="overflow-x: auto;">
            <table id="mainTable">
                <thead>
                    <tr>
                        <th style="width:20%">Municipio</th>
                        <th style="width:25%">Lugar / Punto</th>
                        <th style="width:8%">Zona</th>
                        <th style="width:25%">Referencia</th>
                        <th style="width:15%">Estado</th>
                        <th class="adm-col hidden" style="width:7%">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>

        <div style="text-align:center; margin-top:25px; display:flex; justify-content:center; align-items:center; gap:20px;">
            <button onclick="changePag(-1)" id="btnPrev" class="btn btn-p"><i class="fa-solid fa-arrow-left"></i></button>
            <span id="pagInfo" style="font-weight:800; color:var(--p); font-size:16px;">P√°gina 1</span>
            <button onclick="changePag(1)" id="btnNext" class="btn btn-p"><i class="fa-solid fa-arrow-right"></i></button>
        </div>
    </div>
</div>

<div id="modalAdd" class="modal-overlay hidden">
    <div class="modal-box">
        <h3 style="color:var(--p); margin-top:0;">Agregar Nueva Ubicaci√≥n</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div><label>Municipio:</label><input id="newM"></div>
            <div><label>Lugar/Punto:</label><input id="newN"></div>
            <div><label>Zona:</label><input id="newZ"></div>
            <div><label>Estado:</label>
                <select id="newV">
                    <option value="Cobertura">Cobertura</option>
                    <option value="Sin Cobertura">Sin Cobertura</option>
                    <option value="Consultar">Consultar</option>
                </select>
            </div>
            <div style="grid-column: span 2;"><label>Referencia:</label><input id="newRef"></div>
        </div>
        <div style="margin-top:20px; display:flex; gap:10px; justify-content: flex-end;">
            <button onclick="toggleModal('modalAdd', false)" class="btn btn-d">Cancelar</button>
            <button onclick="addCoverage()" class="btn btn-s">Guardar Ubicaci√≥n</button>
        </div>
    </div>
</div>

<div id="modalUsers" class="modal-overlay hidden">
    <div class="modal-box">
        <h3>Gesti√≥n de Accesos</h3>
        <div style="background:#f0f0f0; padding:15px; border-radius:8px; margin-bottom:15px; display:flex; gap:5px;">
            <input id="unN" placeholder="Usuario">
            <input id="unP" placeholder="Clave">
            <select id="unR"><option value="agente">Agente</option><option value="lider">L√≠der</option><option value="admin">Admin</option></select>
            <button onclick="manageUser('add')" class="btn btn-s">A√±adir</button>
        </div>
        <div id="listUsers" style="max-height:200px; overflow-y:auto;"></div>
        <button onclick="toggleModal('modalUsers', false)" class="btn btn-d" style="margin-top:15px;">Cerrar</button>
    </div>
</div>

<div id="modalHist" class="modal-overlay hidden">
    <div class="modal-box" style="max-width:800px;">
        <h3>Registro de Actividad</h3>
        <div id="histContent" style="font-size:12px; max-height:400px; overflow-y:auto;"></div>
        <button onclick="toggleModal('modalHist', false)" class="btn btn-d" style="margin-top:15px;">Cerrar</button>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycby-oP8w_bPEE3Jp3XK_4pH5rmiOhIPd44NM7JKKQp2Sfw3_690Kgqj8a4CdG2TUDHsB9Q/exec"; 
    let DATA = { cob: [], users: [], online: [], tokens: {} };
    let SES = { u: "", r: "", tk: "" };
    let pag = 1;

    async function fetchData() {
        try {
            const res = await fetch(API_URL);
            const json = await res.json();
            if (SES.u && json.tokens[SES.u.toLowerCase()] !== SES.tk) { logout(); return; }
            DATA.cob = json.cobertura.slice(1).map((r,i) => ({f:i+2, m:r[0], n:r[1], c:r[2], z:r[3], ref:r[4], val:r[5]||"Sin Datos"}));
            DATA.users = json.usuariosList;
            DATA.online = json.onlineList;
            DATA.logs = json.historial;
            updateWidgets();
            if(SES.u) render();
        } catch(e) { console.warn("Sincronizando..."); }
    }

    function updateWidgets() {
        document.getElementById("onlineCount").innerText = DATA.online.length;
        document.getElementById("onlineNames").innerHTML = (SES.r==='admin') ? 
            "<b>En l√≠nea:</b><hr>" + DATA.online.map(u => `<div>‚Ä¢ ${u}</div>`).join('') : "<i>Solo administradores</i>";
    }

    async function login() {
        const u = document.getElementById("user").value, p = document.getElementById("pass").value;
        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({action:'login', u, p}) });
        const rj = await res.json();
        if(rj.status === 'ok') {
            SES = { u, r: rj.rol, tk: rj.token };
            localStorage.setItem("distelsa_v3", JSON.stringify(SES));
            start();
        } else alert("Credenciales inv√°lidas");
    }

    function start() {
        const storage = localStorage.getItem("distelsa_v3");
        if(storage) {
            SES = JSON.parse(storage);
            document.getElementById("loginBox").classList.add("hidden");
            document.getElementById("app").classList.remove("hidden");
            document.getElementById("navRight").classList.remove("hidden");
            document.getElementById("userName").innerText = SES.u.toUpperCase();
            
            const isAL = (SES.r==='admin' || SES.r==='lider');
            if(isAL) {
                document.querySelectorAll(".adm-col").forEach(e => e.classList.remove("hidden"));
                document.getElementById("btnExcel").classList.remove("hidden");
                document.getElementById("btnAdd").classList.remove("hidden");
            }
            if(SES.r==='admin') {
                document.getElementById("btnHist").classList.remove("hidden");
                document.getElementById("btnUsers").classList.remove("hidden");
            }
            fetchData();
            setInterval(() => {
                fetch(API_URL, { method:'POST', body: JSON.stringify({action:'heartbeat', u: SES.u}) });
                fetchData();
            }, 30000);
        }
    }

    function render() {
        const q = document.getElementById("search").value.toLowerCase();
        const filtered = DATA.cob.filter(r => `${r.m} ${r.n} ${r.z} ${r.ref}`.toLowerCase().includes(q));
        const slice = filtered.slice((pag-1)*10, pag*10);
        const tbody = document.getElementById("tbody");
        tbody.innerHTML = "";
        const canEdit = (SES.r==='admin' || SES.r==='lider');

        slice.forEach(r => {
            const cls = r.val=='Cobertura'?'bg-cob':r.val=='Sin Cobertura'?'bg-nocob':r.val=='Consultar'?'bg-cons':'bg-null';
            tbody.innerHTML += `
                <tr>
                    <td>${canEdit ? `<input id="m-${r.f}" value="${r.m}">` : r.m}</td>
                    <td>${canEdit ? `<input id="n-${r.f}" value="${r.n}" style="font-weight:bold">` : `<b>${r.n}</b>`}</td>
                    <td>${canEdit ? `<input id="z-${r.f}" value="${r.z}" style="text-align:center">` : r.z}</td>
                    <td>${canEdit ? `<input id="r-${r.f}" value="${r.ref}">` : r.ref}</td>
                    <td>
                        <select id="v-${r.f}" class="badge ${cls}" ${!canEdit?'disabled':''} onchange="this.className='badge '+ (this.value=='Cobertura'?'bg-cob':this.value=='Sin Cobertura'?'bg-nocob':this.value=='Consultar'?'bg-cons':'bg-null')">
                            <option value="Sin Datos" ${r.val=='Sin Datos'?'selected':''}>Sin Datos</option>
                            <option value="Cobertura" ${r.val=='Cobertura'?'selected':''}>Cobertura</option>
                            <option value="Sin Cobertura" ${r.val=='Sin Cobertura'?'selected':''}>Sin Cobertura</option>
                            <option value="Consultar" ${r.val=='Consultar'?'selected':''}>Consultar</option>
                        </select>
                    </td>
                    <td class="adm-col ${canEdit?'':'hidden'}">
                        <button onclick="save(${r.f})" class="btn btn-s" style="padding:5px 10px"><i class="fa-solid fa-save"></i></button>
                    </td>
                </tr>`;
        });
        document.getElementById("pagInfo").innerText = `P√°gina ${pag} de ${Math.ceil(filtered.length/10) || 1}`;
    }

    async function save(f) {
        const d = {
            action:'update', fila: f, userLog: SES.u,
            m: document.getElementById(`m-${f}`).value, n: document.getElementById(`n-${f}`).value,
            z: document.getElementById(`z-${f}`).value, ref: document.getElementById(`r-${f}`).value,
            val: document.getElementById(`v-${f}`).value
        };
        await fetch(API_URL, { method:'POST', mode:'no-cors', body: JSON.stringify(d) });
        alert("¬°Fila Actualizada!"); fetchData();
    }

    async function addCoverage() {
        const d = {
            action:'addCoverage', userLog: SES.u,
            m: document.getElementById("newM").value, n: document.getElementById("newN").value,
            z: document.getElementById("newZ").value, ref: document.getElementById("newRef").value,
            val: document.getElementById("newV").value
        };
        if(!d.m || !d.n) return alert("Municipio y Lugar son obligatorios");
        await fetch(API_URL, { method:'POST', mode:'no-cors', body: JSON.stringify(d) });
        toggleModal('modalAdd', false);
        alert("Ubicaci√≥n Guardada con √âxito"); fetchData();
    }

    function toggleModal(id, show) {
        document.getElementById(id).classList.toggle("hidden", !show);
        if(id === 'modalUsers' && show) {
            document.getElementById("listUsers").innerHTML = DATA.users.map(u => `
                <div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;">
                    <span><b>${u[0]}</b> (${u[2]})</span>
                    <button onclick="manageUser('del','${u[0]}')" style="color:var(--d); border:none; background:none; cursor:pointer;">Eliminar</button>
                </div>`).join('');
        }
        if(id === 'modalHist' && show) {
            document.getElementById("histContent").innerHTML = `<table><thead><tr><th>Fecha</th><th>User</th><th>Acci√≥n</th><th>Detalle</th></tr></thead><tbody>` + 
                DATA.logs.map(l => `<tr><td>${new Date(l[0]).toLocaleString()}</td><td>${l[1]}</td><td>${l[2]}</td><td>${l[3]}</td></tr>`).join('') + `</tbody></table>`;
        }
    }

    async function manageUser(type, name) {
        const u = name || document.getElementById("unN").value, p = document.getElementById("unP").value, r = document.getElementById("unR").value;
        await fetch(API_URL, { method:'POST', body: JSON.stringify({action:'manageUser', type, u, p, r, userLog: SES.u}) });
        fetchData(); toggleModal('modalUsers', false);
    }

    function exportarExcel() {
        const ws = XLSX.utils.json_to_sheet(DATA.cob.map(r => ({ Municipio: r.m, Lugar: r.n, Zona: r.z, Referencia: r.ref, Estado: r.val })));
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Cobertura");
        XLSX.writeFile(wb, "Cobertura_Distelsa_2026.xlsx");
    }

    function changePag(v) { pag = Math.max(1, pag + v); render(); }
    function logout() { localStorage.clear(); location.reload(); }
    start();
</script>
</body>
</html>
